<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis de Carpeta de Investigaci√≥n - Sistema Jur√≠dico</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            font-size: 2.5rem;
            color: #1e3c72;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e3c72;
        }

        .subtitle {
            font-size: 0.9rem;
            color: #666;
        }

        .status-indicator {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        nav {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn, .export-btn, .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .nav-btn:hover, .export-btn:hover, .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
        }

        .content-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px;
            min-height: 600px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #4CAF50;
        }

        .upload-area.dragover {
            background: rgba(76, 175, 80, 0.1);
            border-color: #4CAF50;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #666;
            margin-bottom: 5px;
        }

        .file-input {
            display: none;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            background: #4CAF50;
            color: white;
        }

        .analysis-panel {
            background: #f9f9f9;
            border-radius: 12px;
            margin: 20px 0;
        }

        .panel-header {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            padding: 20px;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .result-title {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .result-score {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            background: #2196F3;
            color: white;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">‚öñ</div>
                    <div>
                        <div class="logo-text">An√°lisis Carpeta de Investigaci√≥n</div>
                        <div class="subtitle">Sistema de Evaluaci√≥n Jur√≠dica CNPP - CPEUM</div>
                    </div>
                </div>
                <div class="status-indicator">Sistema Activo</div>
            </div>
        </header>

        <nav>
            <div class="nav-buttons">
                <button class="export-btn" onclick="exportResultsAsPDF()">üìÑ Descargar PDF</button>
                <button class="nav-btn active" data-section="upload">üìÅ Cargar Documentos</button>
                <button class="nav-btn" data-section="analysis">‚öñÔ∏è An√°lisis Jur√≠dico</button>
                <button class="nav-btn" data-section="results">üìä Resultados</button>
                <button class="nav-btn" data-section="reports">üìÑ Reportes</button>
                <button class="nav-btn" data-section="help">‚ùì Ayuda</button>
            </div>
        </nav>

        <div class="main-content">
            <div class="sidebar">
                <h3>üìÇ Estructura de Carpeta</h3>
                <div class="document-tree" id="documentTree">
                    <div class="tree-item">üìã Carpeta de Investigaci√≥n</div>
                    <div class="tree-item">‚îî‚îÄ‚îÄ üìÅ Documentos Cargados (<span id="docCount">0</span>)</div>
                </div>

                <div class="summary-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalDocs">0</div>
                        <div class="stat-label">Documentos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="analyzedDocs">0</div>
                        <div class="stat-label">Analizados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgScore">0%</div>
                        <div class="stat-label">Score Promedio</div>
                    </div>
                </div>
            </div>

            <div class="content-area">
                <!-- Upload Section -->
                <div class="section active" id="upload">
                    <h2>üìÅ Carga de Documentos</h2>
                    <p>Sube los documentos que conforman la carpeta de investigaci√≥n para su an√°lisis jur√≠dico conforme al CNPP y CPEUM.</p>

                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Arrastra documentos aqu√≠</div>
                        <div class="upload-subtext">O haz clic para seleccionar archivos</div>
                        <div class="upload-subtext">Formatos: PDF, DOCX, TXT, CSV, JSON, XLSX</div>
                        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                            Seleccionar Archivos
                        </button>
                    </div>

                    <input type="file" id="fileInput" class="file-input" multiple 
                           accept=".pdf,.docx,.txt,.csv,.json,.xlsx">

                    <div class="file-list" id="fileList"></div>
                </div>

                <!-- Analysis Section -->
                <div class="section" id="analysis">
                    <h2>‚öñÔ∏è An√°lisis Jur√≠dico en Progreso</h2>
                    
                    <div class="analysis-panel">
                        <div class="panel-header">
                            <span>Evaluaci√≥n de Documentos</span>
                            <span id="analysisStatus">Listo para analizar</span>
                        </div>
                        <div class="panel-content">
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <div class="progress-text" id="progressText">0% completado</div>
                            </div>
                            
                            <div id="analysisLog">
                                <p>Selecciona documentos y presiona "Iniciar An√°lisis" para comenzar la evaluaci√≥n jur√≠dica.</p>
                            </div>
                        </div>
                    </div>

                    <button class="upload-btn" id="startAnalysis">
                        üîç Iniciar An√°lisis Jur√≠dico
                    </button>
                </div>

                <!-- Results Section -->
                <div class="section" id="results">
                    <h2>üìä Resultados del An√°lisis</h2>
                    <div class="results-grid" id="resultsGrid"></div>
                </div>

                <!-- Reports Section -->
                <div class="section" id="reports">
                    <h2>üìÑ Generaci√≥n de Reportes</h2>
                    
                    <div class="export-panel">
                        <h3>üìã Resumen Ejecutivo</h3>
                        <p>Generar dictamen procesal estructurado con an√°lisis completo de la carpeta de investigaci√≥n.</p>
                        
                        <div class="export-options" style="margin-top: 15px;">
                            <button class="export-btn" onclick="exportSpecialReport('pdf')">üìÑ Exportar PDF</button>
                            <button class="export-btn" onclick="exportSpecialReport('json')">üìã Exportar JSON</button>
                        </div>
                    </div>
                </div>

                <!-- Help Section -->
                <div class="section" id="help">
                    <h2>‚ùì Ayuda y Documentaci√≥n</h2>
                    
                    <div class="panel-content">
                        <h3>üîç Tipos de Documentos Analizados</h3>
                        <ul style="margin: 15px 0; padding-left: 30px;">
                            <li><strong>Denuncia/Querella:</strong> Inicio formal de la investigaci√≥n</li>
                            <li><strong>Inspecci√≥n:</strong> Levantamiento de evidencia f√≠sica</li>
                            <li><strong>Entrevistas:</strong> Declaraciones de v√≠ctimas, testigos, imputados</li>
                            <li><strong>Dict√°menes Periciales:</strong> An√°lisis t√©cnicos especializados</li>
                            <li><strong>Oficios:</strong> Comunicaciones oficiales</li>
                            <li><strong>Cadena de Custodia:</strong> Control de evidencias</li>
                        </ul>

                        <h3>‚öñÔ∏è Marco Legal Aplicado</h3>
                        <ul style="margin: 15px 0; padding-left: 30px;">
                            <li><strong>CPEUM:</strong> Arts. 14, 16, 20, 21</li>
                            <li><strong>CNPP:</strong> Arts. 131, 211-220, 259-265, 266-303, 313, 335-336, 359</li>
                            <li><strong>C√≥digo Penal:</strong> Tipificaci√≥n de delitos</li>
                            <li><strong>Leyes Complementarias:</strong> Normativa espec√≠fica aplicable</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

// Sistema de An√°lisis Jur√≠dico Integral

class CarpetaAnalyzer {
    constructor() {
        this.documents = [];
        this.analysisResults = [];
        this.legalFramework = this.initLegalFramework();
        this.documentTypes = this.initDocumentTypes();
        this.isAnalyzing = false;
    }

    init() {
        console.log('Inicializando CarpetaAnalyzer...');
        this.initPDFWorker();
        this.setupEventListeners();
        this.setupNavigation();
        this.setupDragDrop();
        console.log('CarpetaAnalyzer inicializado correctamente');
    }

    initPDFWorker() {
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            console.log('PDF.js worker configurado');
        }
    }

    setupEventListeners() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files));
        }

        const startBtn = document.getElementById('startAnalysis');
        if (startBtn) {
            startBtn.addEventListener('click', () => this.startAnalysis());
        }
    }

    setupNavigation() {
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remover clase active de todas las secciones y botones
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                
                // Activar la secci√≥n seleccionada
                const section = document.getElementById(btn.dataset.section);
                if (section) {
                    section.classList.add('active');
                    btn.classList.add('active');
                }
            });
        });
    }

    setupDragDrop() {
        const uploadArea = document.getElementById('uploadArea');
        if (uploadArea) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                this.handleFileSelect(e.dataTransfer.files);
            });

            uploadArea.addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
        }
    }

    async handleFileSelect(files) {
        console.log(`Procesando ${files.length} archivos...`);
        
        for (const file of files) {
            if (this.isValidFileType(file)) {
                try {
                    const content = await this.extractText(file);
                    const doc = {
                        id: this.generateId(),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        content,
                        analyzed: false,
                        uploadDate: new Date()
                    };
                    
                    this.documents.push(doc);
                    this.addFileToList(doc);
                    console.log(`Archivo ${file.name} procesado correctamente`);
                } catch (error) {
                    console.error(`Error procesando ${file.name}:`, error);
                    alert(`Error al procesar ${file.name}: ${error.message}`);
                }
            } else {
                alert(`Tipo de archivo no soportado: ${file.name}`);
            }
        }
        
        this.updateStats();
    }

    addFileToList(doc) {
        const fileList = document.getElementById('fileList');
        if (!fileList) return;

        const fileDiv = document.createElement('div');
        fileDiv.className = 'file-item';
        fileDiv.innerHTML = `
            <div class="file-info">
                <span>üìÑ</span>
                <div>
                    <div><strong>${doc.name}</strong></div>
                    <div style="font-size: 0.8rem; color: #666;">
                        ${this.formatFileSize(doc.size)} - ${doc.uploadDate.toLocaleString()}
                    </div>
                </div>
            </div>
            <div class="file-status">${doc.analyzed ? 'Analizado' : 'Pendiente'}</div>
        `;
        
        fileList.appendChild(fileDiv);
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    async startAnalysis() {
        if (this.isAnalyzing) {
            alert('An√°lisis en progreso...');
            return;
        }

        if (this.documents.length === 0) {
            alert('No hay documentos para analizar. Por favor, carga algunos archivos primero.');
            return;
        }

        this.isAnalyzing = true;
        this.analysisResults = [];
        
        const statusEl = document.getElementById('analysisStatus');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const analysisLog = document.getElementById('analysisLog');
        
        if (statusEl) statusEl.textContent = 'Analizando...';
        if (analysisLog) analysisLog.innerHTML = '<p>Iniciando an√°lisis jur√≠dico...</p>';

        try {
            for (let i = 0; i < this.documents.length; i++) {
                const doc = this.documents[i];
                const progress = ((i + 1) / this.documents.length) * 100;
                
                if (progressFill) progressFill.style.width = `${progress}%`;
                if (progressText) progressText.textContent = `${Math.round(progress)}% completado`;
                if (analysisLog) {
                    analysisLog.innerHTML += `<p>Analizando: ${doc.name}...</p>`;
                    analysisLog.scrollTop = analysisLog.scrollHeight;
                }

                const analysis = await this.analyzeDocument(doc);
                this.analysisResults.push(analysis);
                doc.analyzed = true;

                // Simular tiempo de an√°lisis
                await this.sleep(500);
            }

            if (statusEl) statusEl.textContent = 'An√°lisis completado';
            if (analysisLog) analysisLog.innerHTML += '<p><strong>‚úÖ An√°lisis completado exitosamente</strong></p>';
            
            this.displayResults();
            this.updateStats();
            
            // Cambiar autom√°ticamente a la secci√≥n de resultados
            document.querySelector('[data-section="results"]').click();
            
        } catch (error) {
            console.error('Error durante el an√°lisis:', error);
            if (statusEl) statusEl.textContent = 'Error en an√°lisis';
            if (analysisLog) analysisLog.innerHTML += `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
        } finally {
            this.isAnalyzing = false;
        }
    }

    async analyzeDocument(doc) {
        const type = this.classifyDocument(doc.content);
        const foundArticles = this.getApplicableArticles(doc.content, type);
        const score = this.calculateScore(doc, foundArticles);

        return {
            documentId: doc.id,
            documentName: doc.name,
            documentType: type,
            articles: foundArticles,
            score: score,
            resumen: this.generateSummary(doc, type, foundArticles, score),
            recommendations: this.generateRecommendations(type, foundArticles)
        };
    }

    classifyDocument(content) {
        let bestType = 'desconocido';
        let maxMatches = 0;
        const lowerContent = content.toLowerCase();

        for (const [key, definition] of Object.entries(this.documentTypes)) {
            const matches = definition.keywords.filter(keyword => 
                lowerContent.includes(keyword.toLowerCase())
            ).length;
            
            if (matches > maxMatches) {
                maxMatches = matches;
                bestType = key;
            }
        }

        return bestType;
    }

    getApplicableArticles(content, docType) {
        const foundArticles = [];
        const lowerContent = content.toLowerCase();

        for (const [codigo, articulos] of Object.entries(this.legalFramework)) {
            for (const [articulo, definition] of Object.entries(articulos)) {
                const matches = definition.applies.some(keyword => 
                    lowerContent.includes(keyword.toLowerCase()) || 
                    docType.includes(keyword.toLowerCase())
                );
                
                if (matches) {
                    foundArticles.push({
                        codigo: codigo,
                        articulo: articulo,
                        contenido: definition.content,
                        relevancia: this.calculateRelevance(lowerContent, definition.applies)
                    });
                }
            }
        }

        return foundArticles.sort((a, b) => b.relevancia - a.relevancia);
    }

    calculateRelevance(content, keywords) {
        return keywords.reduce((count, keyword) => {
            const regex = new RegExp(keyword.toLowerCase(), 'g');
            const matches = content.match(regex);
            return count + (matches ? matches.length : 0);
        }, 0);
    }

    calculateScore(doc, articles) {
        const baseScore = Math.min(articles.length * 10, 70);
        const contentLength = doc.content.length;
        const lengthBonus = contentLength > 1000 ? 20 : contentLength > 500 ? 10 : 5;
        return Math.min(baseScore + lengthBonus, 100);
    }

    generateSummary(doc, type, articles, score) {
        const typeName = this.documentTypes[type]?.name || 'Documento no clasificado';
        return `Documento "${doc.name}" clasificado como ${typeName}. Identificados ${articles.length} art√≠culos legales aplicables con una puntuaci√≥n de ${score}% de completitud jur√≠dica.`;
    }

    generateRecommendations(type, articles) {
        const recommendations = [];
        
        if (articles.length === 0) {
            recommendations.push('Revisar la clasificaci√≥n del documento y verificar contenido jur√≠dico relevante.');
        }
        
        if (articles.length < 3) {
            recommendations.push('Considerar complementar con documentos adicionales para fortalecer el sustento legal.');
        }
        
        if (type === 'desconocido') {
            recommendations.push('Verificar el tipo de documento y asegurar que contenga elementos identificables.');
        }
        
        return recommendations;
    }

    displayResults() {
        const container = document.getElementById('resultsGrid');
        if (!container) {
            console.error('Container resultsGrid no encontrado');
            return;
        }

        container.innerHTML = '';

        if (this.analysisResults.length === 0) {
            container.innerHTML = '<p>No hay resultados para mostrar. Ejecuta un an√°lisis primero.</p>';
            return;
        }

        this.analysisResults.forEach(result => {
            const card = document.createElement('div');
            card.className = 'result-card';

            const tipoDocs = this.documentTypes[result.documentType]?.name || 'Desconocido';
            const scoreClass = result.score >= 70 ? 'score-high' : result.score >= 40 ? 'score-medium' : 'score-low';
            
            const articulosHtml = result.articles.slice(0, 5).map(art => 
                `<li><strong>${art.codigo} ${art.articulo}:</strong> ${art.contenido}</li>`
            ).join('');

            const recommendationsHtml = result.recommendations.map(rec => `<li>${rec}</li>`).join('');

            card.innerHTML = `
                <div class="result-header">
                    <div class="result-title">${result.documentName}</div>
                    <div class="result-score ${scoreClass}">${result.score}% - ${tipoDocs}</div>
                </div>
                
                <p><strong>Resumen:</strong> ${result.resumen}</p>
                
                <div style="margin: 15px 0;">
                    <strong>Art√≠culos Legales Aplicables (${result.articles.length}):</strong>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        ${articulosHtml}
                        ${result.articles.length > 5 ? '<li><em>... y ' + (result.articles.length - 5) + ' m√°s</em></li>' : ''}
                    </ul>
                </div>
                
    // Continuaci√≥n del sistema - a partir de displayResults()
.analysisResults.length} resultados`);
    }

    // Funci√≥n para generar reportes especializados
    generateSpecializedReport(type) {
        const results = this.analysisResults;
        if (results.length === 0) {
            alert('No hay an√°lisis disponibles para generar reporte.');
            return;
        }

        switch(type) {
            case 'chronology':
                return this.generateChronologyReport(results);
            case 'sufficiency':
                return this.generateSufficiencyReport(results);
            case 'legal':
                return this.generateLegalReport(results);
            case 'recommendations':
                return this.generateRecommendationsReport(results);
            default:
                return null;
        }
    }

    generateChronologyReport(results) {
        const chronology = results.map((result, index) => ({
            orden: index + 1,
            documento: result.documentName,
            tipo: this.documentTypes[result.documentType]?.name || 'Desconocido',
            fecha: new Date().toLocaleDateString('es-MX'),
            relevancia: result.score >= 80 ? 'Alta' : result.score >= 60 ? 'Media' : 'Baja'
        }));

        return {
            titulo: 'Cronolog√≠a de Actuaciones',
            data: chronology,
            resumen: `An√°lisis cronol√≥gico de ${results.length} documentos procesales`
        };
    }

    generateSufficiencyReport(results) {
        const totalDocs = results.length;
        const highQuality = results.filter(r => r.score >= 80).length;
        const mediumQuality = results.filter(r => r.score >= 60 && r.score < 80).length;
        const lowQuality = results.filter(r => r.score < 60).length;
        
        const avgScore = totalDocs > 0 ? Math.round(results.reduce((sum, r) => sum + r.score, 0) / totalDocs) : 0;

        return {
            titulo: '√çndice de Suficiencia Probatoria',
            totalDocumentos: totalDocs,
            calidadAlta: highQuality,
            calidadMedia: mediumQuality,
            calidadBaja: lowQuality,
            promedioGeneral: avgScore,
            recomendacion: avgScore >= 75 ? 'Carpeta suficiente para ejercicio de acci√≥n penal' : 
                          avgScore >= 50 ? 'Requiere fortalecimiento probatorio' : 
                          'Insuficiente para acusaci√≥n'
        };
    }

    generateLegalReport(results) {
        const articlesUsed = new Map();
        results.forEach(result => {
            result.articles.forEach(art => {
                const key = `${art.codigo} ${art.articulo}`;
                articlesUsed.set(key, (articlesUsed.get(key) || 0) + 1);
            });
        });

        return {
            titulo: 'Dictamen de Legalidad',
            articulosAplicados: Array.from(articlesUsed.entries()).map(([art, count]) => ({
                articulo: art,
                frecuencia: count
            })),
            conclusion: 'An√°lisis de conformidad con marco jur√≠dico vigente'
        };
    }

    generateRecommendationsReport(results) {
        const allRecommendations = [];
        results.forEach(result => {
            result.recommendations.forEach(rec => {
                allRecommendations.push({
                    documento: result.documentName,
                    recomendacion: rec,
                    prioridad: result.score < 60 ? 'Alta' : result.score < 80 ? 'Media' : 'Baja'
                });
            });
        });

        return {
            titulo: 'Recomendaciones de Mejora',
            total: allRecommendations.length,
            recomendaciones: allRecommendations
        };
    }

    // Funci√≥n para exportar a PDF mejorada
    async exportToPDF() {
        try {
            const container = document.getElementById('resultsGrid');
            if (!container || this.analysisResults.length === 0) {
                alert('No hay resultados para exportar.');
                return;
            }

            // Crear elemento temporal con contenido completo
            const exportContent = document.createElement('div');
            exportContent.innerHTML = `
                <div style="padding: 20px; font-family: Arial, sans-serif;">
                    <h1 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">
                        üìã AN√ÅLISIS DE CARPETA DE INVESTIGACI√ìN
                    </h1>
                    <div style="text-align: center; margin-bottom: 30px; color: #666;">
                        <p>Fecha de an√°lisis: ${new Date().toLocaleDateString('es-MX')}</p>
                        <p>Sistema de Evaluaci√≥n Jur√≠dica CNPP - CPEUM</p>
                    </div>
                    ${container.innerHTML}
                </div>
            `;

            const opt = {
                margin: 0.5,
                filename: `analisis_carpeta_${new Date().getTime()}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    allowTaint: true 
                },
                jsPDF: { 
                    unit: 'in', 
                    format: 'letter', 
                    orientation: 'portrait' 
                }
            };

            await html2pdf().set(opt).from(exportContent).save();
            alert('PDF generado correctamente.');

        } catch (error) {
            console.error('Error al generar PDF:', error);
            alert('Error al generar PDF. Int√©ntalo de nuevo.');
        }
    }

    // Funci√≥n para exportar a JSON
    exportToJSON() {
        if (this.analysisResults.length === 0) {
            alert('No hay resultados para exportar.');
            return;
        }

        const exportData = {
            metadata: {
                fechaAnalisis: new Date().toISOString(),
                totalDocumentos: this.analysisResults.length,
                sistema: 'An√°lisis Carpeta de Investigaci√≥n v1.0'
            },
            resultados: this.analysisResults,
            resumen: this.generateSufficiencyReport(this.analysisResults)
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], 
                             { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `analisis_carpeta_${new Date().getTime()}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // Actualizar estad√≠sticas en sidebar
    updateStats() {
        const totalDocs = this.documents.length;
        const analyzedDocs = this.documents.filter(d => d.analyzed).length;
        const avgScore = this.analysisResults.length > 0 ? 
            Math.round(this.analysisResults.reduce((sum, r) => sum + r.score, 0) / this.analysisResults.length) : 0;

        document.getElementById('totalDocs').textContent = totalDocs;
        document.getElementById('analyzedDocs').textContent = analyzedDocs;
        document.getElementById('avgScore').textContent = `${avgScore}%`;
        document.getElementById('docCount').textContent = totalDocs;
    }

    // Funci√≥n para mostrar progreso de an√°lisis
    updateProgress(current, total, message = '') {
        const percentage = Math.round((current / total) * 100);
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const analysisStatus = document.getElementById('analysisStatus');

        if (progressFill) progressFill.style.width = `${percentage}%`;
        if (progressText) progressText.textContent = `${percentage}% completado`;
        if (analysisStatus && message) analysisStatus.textContent = message;
    }

    // Limpiar resultados
    clearResults() {
        this.analysisResults = [];
        this.documents.forEach(doc => doc.analyzed = false);
        
        const container = document.getElementById('resultsGrid');
        if (container) container.innerHTML = '';
        
        this.updateStats();
        this.updateProgress(0, 1, 'Listo para analizar');
    }
}

// Funciones globales para exports
function exportResultsAsPDF() {
    if (window.carpetaAnalyzer) {
        window.carpetaAnalyzer.exportToPDF();
    }
}

function exportResultsAsJSON() {
    if (window.carpetaAnalyzer) {
        window.carpetaAnalyzer.exportToJSON();
    }
}

// Event listeners adicionales cuando se carga el DOM
document.addEventListener('DOMContentLoaded', () => {
    // Navegaci√≥n entre secciones
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const targetSection = btn.dataset.section;
            
            // Remover clase active de todas las secciones y botones
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // Activar secci√≥n y bot√≥n correspondiente
            const section = document.getElementById(targetSection);
            if (section) section.classList.add('active');
            btn.classList.add('active');
        });
    });

    // Event listeners para botones de export
    const exportPDFBtn = document.getElementById('exportPDF');
    if (exportPDFBtn) {
        exportPDFBtn.addEventListener('click', exportResultsAsPDF);
    }

    const exportJSONBtn = document.getElementById('exportJSON');
    if (exportJSONBtn) {
        exportJSONBtn.addEventListener('click', exportResultsAsJSON);
    }

    // Drag and drop para √°rea de upload
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) {
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#f0f8ff';
            uploadArea.style.borderColor = '#4CAF50';
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '';
            uploadArea.style.borderColor = '';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.backgroundColor = '';
            uploadArea.style.borderColor = '';
            
            const files = e.dataTransfer.files;
            if (window.carpetaAnalyzer && files.length > 0) {
                window.carpetaAnalyzer.handleFileSelect(files);
            }
        });

        uploadArea.addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
    }

    console.log('Sistema de An√°lisis Jur√≠dico inicializado correctamente.');
});

// Instancia global
window.addEventListener('DOMContentLoaded', () => {
    window.carpetaAnalyzer = new CarpetaAnalyzer();
});

${result.recommendations.length > 0 ? `
                    <div style="margin: 15px 0;">
                        <strong>Recomendaciones:</strong>
                        <ul style="margin: 10px 0; padding-left: 20px; color: #666;">
                            ${recommendationsHtml}
                        </ul>
                    </div>
                ` : ''}
            `;
            container.appendChild(card);
        });
        console.log(`Mostrados ${this.analysisResults.length} resultados de an√°lisis`);
    }

    getScoreClass(score) {
        if (score >= 80) return 'score-high';
        if (score >= 60) return 'score-medium';
        return 'score-low';
    }

    // Funciones de utilidad y actualizaci√≥n de interfaz
    updateStats() {
        const totalDocs = document.getElementById('totalDocs');
        const analyzedDocs = document.getElementById('analyzedDocs');
        const avgScore = document.getElementById('avgScore');
        const docCount = document.getElementById('docCount');

        if (totalDocs) totalDocs.textContent = this.documents.length;
        if (docCount) docCount.textContent = this.documents.length;
        
        const analyzed = this.documents.filter(d => d.analyzed).length;
        if (analyzedDocs) analyzedDocs.textContent = analyzed;

        if (avgScore && this.analysisResults.length > 0) {
            const avg = Math.round(
                this.analysisResults.reduce((sum, r) => sum + r.legalScore, 0) / this.analysisResults.length
            );
            avgScore.textContent = `${avg}%`;
        } else if (avgScore) {
            avgScore.textContent = '0%';
        }
        
        console.log(`Stats actualizados: ${this.documents.length} docs, ${analyzed} analizados`);
    }

    updateDocumentTree() {
        const tree = document.getElementById('documentTree');
        if (!tree) return;

        const treeHTML = `
            <div class="tree-item">üìã Carpeta de Investigaci√≥n</div>
            <div class="tree-item">‚îî‚îÄ‚îÄ üìÅ Documentos Cargados (${this.documents.length})</div>
            ${this.documents.map(doc => 
                `<div class="tree-item">    ‚îî‚îÄ‚îÄ ${this.getFileIcon(doc.name)} ${doc.name} ${doc.analyzed ? '‚úÖ' : '‚è≥'}</div>`
            ).join('')}
        `;
        
        tree.innerHTML = treeHTML;
    }

    updateProgress() {
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        
        if (progressFill) {
            progressFill.style.width = `${this.currentProgress}%`;
        }
        
        if (progressText) {
            progressText.textContent = `${this.currentProgress}% completado`;
        }
    }

    updateAnalysisStatus(status) {
        const statusElement = document.getElementById('analysisStatus');
        if (statusElement) {
            statusElement.textContent = status;
        }
        console.log(`Status: ${status}`);
    }

    updateAnalysisLog(message) {
        const logElement = document.getElementById('analysisLog');
        if (logElement) {
            logElement.innerHTML += message + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }
        console.log(message);
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const icons = {
            'pdf': 'üìÑ',
            'docx': 'üìù',
            'doc': 'üìù',
            'txt': 'üìã',
            'csv': 'üìä',
            'xlsx': 'üìà',
            'json': 'üîß'
        };
        return icons[ext] || 'üìé';
    }

    isValidFileType(file) {
        const validTypes = ['.pdf', '.docx', '.doc', '.txt', '.csv', '.json', '.xlsx'];
        return validTypes.some(type => file.name.toLowerCase().endsWith(type));
    }

    async extractText(file) {
        const ext = file.name.split('.').pop().toLowerCase();
        
        try {
            if (ext === 'txt' || ext === 'csv' || ext === 'json') {
                return await file.text();
            }
            
            const arrayBuffer = await file.arrayBuffer();
            
            if (ext === 'pdf') {
                return await this.extractFromPDF(arrayBuffer);
            }
            
            if (ext === 'docx' || ext === 'doc') {
                return await this.extractFromDOCX(arrayBuffer);
            }
            
            if (ext === 'xlsx') {
                return await this.extractFromXLSX(arrayBuffer);
            }
            
            return '';
        } catch (error) {
            console.error(`Error extrayendo texto de ${file.name}:`, error);
            throw new Error(`No se pudo procesar el archivo: ${error.message}`);
        }
    }

    async extractFromPDF(arrayBuffer) {
        if (typeof pdfjsLib === 'undefined') {
            throw new Error('PDF.js no est√° disponible');
        }
        
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';
        
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            fullText += pageText + '\n';
        }
        
        return fullText;
    }

    async extractFromDOCX(arrayBuffer) {
        if (typeof mammoth === 'undefined') {
            throw new Error('Mammoth.js no est√° disponible');
        }
        
        const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
        return result.value;
    }

    async extractFromXLSX(arrayBuffer) {
        if (typeof XLSX === 'undefined') {
            throw new Error('SheetJS no est√° disponible');
        }
        
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        let allText = '';
        
        workbook.SheetNames.forEach(sheetName => {
            const sheet = workbook.Sheets[sheetName];
            const csv = XLSX.utils.sheet_to_csv(sheet);
            allText += csv + '\n';
        });
        
        return allText;
    }

    generateId() {
        return 'doc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async exportResultsAsPDF() {
        const container = document.getElementById('resultsGrid');
        if (!container || this.analysisResults.length === 0) {
            alert('No hay resultados para exportar.');
            return;
        }

        try {
            // Crear contenido para PDF
            const pdfContent = this.generatePDFContent();
            
            // Si html2pdf est√° disponible, usarlo
            if (typeof html2pdf !== 'undefined') {
                const opt = {
                    margin: 0.5,
                    filename: `analisis_carpeta_${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                await html2pdf().set(opt).from(pdfContent).save();
            } else {
                // Fallback: abrir en nueva ventana para imprimir
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>An√°lisis Jur√≠dico - ${new Date().toLocaleDateString()}</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                .result-card { border: 1px solid #ddd; margin: 20px 0; padding: 15px; }
                                .score-high { color: #28a745; }
                                .score-medium { color: #ffc107; }
                                .score-low { color: #dc3545; }
                                ul { margin: 10px 0; padding-left: 20px; }
                            </style>
                        </head>
                        <body>
                            ${pdfContent.innerHTML}
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }
            
            this.updateAnalysisLog('‚úÖ Reporte exportado correctamente');
            
        } catch (error) {
            console.error('Error exportando PDF:', error);
            alert('Error al exportar el reporte. Int√©ntalo de nuevo.');
        }
    }

    generatePDFContent() {
        const div = document.createElement('div');
        div.innerHTML = `
            <h1>üìã An√°lisis Jur√≠dico de Carpeta de Investigaci√≥n</h1>
            <p><strong>Fecha:</strong> ${new Date().toLocaleDateString()}</p>
            <p><strong>Documentos analizados:</strong> ${this.analysisResults.length}</p>
            <hr>
            ${this.analysisResults.map(result => `
                <div class="result-card">
                    <h2>üìÑ ${result.documentName}</h2>
                    <p><strong>Tipo:</strong> ${this.documentTypes[result.documentType]?.name || 'Desconocido'}</p>
                    <p><strong>Score Legal:</strong> <span class="${this.getScoreClass(result.legalScore)}">${result.legalScore}%</span></p>
                    <p><strong>Resumen:</strong> ${result.resumen}</p>
                    
                    <h3>‚öñÔ∏è Art√≠culos Legales Aplicables (${result.articles.length}):</h3>
                    <ul>
                        ${result.articles.map(art => 
                            `<li><strong>${art.codigo} Art. ${art.articulo}:</strong> ${art.contenido}</li>`
                        ).join('')}
                    </ul>
                    
            ${result.recommendations.length > 0 ? `
                        <h3>üìã Recomendaciones:</h3>
                        <ul>
                            ${result.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    ` : ''}
                </div>
            `).join('')}
        `;
        return div;
    }

    // M√©todos de configuraci√≥n de datos legales
    initDocumentTypes() {
        return {
            denuncia: {
                name: 'Denuncia/Querella',
                keywords: ['denuncia', 'querella', 'hechos', 'delito', 'narraci√≥n', 'acontecimiento', 'suceso']
            },
            inspeccion: {
                name: 'Inspecci√≥n',
                keywords: ['inspecci√≥n', 'evidencia', 'croquis', 'lugar', 'hallazgo', 'observaci√≥n', 'levantamiento']
            },
            entrevista: {
                name: 'Entrevista',
                keywords: ['entrevista', 'declaraci√≥n', 'testigo', 'v√≠ctima', 'imputado', 'manifestaci√≥n', 'testimonio']
            },
            dictamen: {
                name: 'Dictamen Pericial',
                keywords: ['dictamen', 'perito', 'an√°lisis', 't√©cnico', 'pericial', 'especialista', 'estudio']
            },
            oficio: {
                name: 'Oficio',
                keywords: ['oficio', 'comunicaci√≥n', 'solicitud', 'requerimiento', 'petici√≥n', 'exhorto']
            },
            custodia: {
                name: 'Cadena de Custodia',
                keywords: ['custodia', 'evidencia', 'indicio', 'objeto', 'preservaci√≥n', 'resguardo']
            }
        };
    }

    initLegalFramework() {
        return {
            CPEUM: {
                'art14': {
                    content: 'Garant√≠a de audiencia y legalidad - Nadie podr√° ser privado de la libertad o de sus propiedades, posesiones o derechos, sino mediante juicio seguido ante los tribunales previamente establecidos',
                    applies: ['audiencia', 'legalidad', 'juicio', 'tribunal', 'debido proceso'],
                    relevancia: 'alta',
                    documentTypes: ['denuncia', 'entrevista']
                },
                'art16': {
                    content: 'Garant√≠a de legalidad - Nadie puede ser molestado en su persona, familia, domicilio, papeles o posesiones, sino en virtud de mandamiento escrito de la autoridad competente',
                    applies: ['cateo', 'orden', 'mandamiento', 'autoridad', 'domicilio'],
                    relevancia: 'alta',
                    documentTypes: ['inspeccion', 'oficio']
                },
                'art20': {
                    content: 'Principios del proceso penal acusatorio y oral - El proceso penal ser√° acusatorio y oral. Se regir√° por los principios de publicidad, contradicci√≥n, concentraci√≥n, continuidad e inmediaci√≥n',
                    applies: ['proceso penal', 'acusatorio', 'oral', 'publicidad', 'contradicci√≥n'],
                    relevancia: 'media',
                    documentTypes: ['entrevista', 'dictamen']
                },
                'art21': {
                    content: 'Ministerio P√∫blico - La investigaci√≥n de los delitos corresponde al Ministerio P√∫blico y a las polic√≠as, las cuales actuar√°n bajo la conducci√≥n y mando de aqu√©l',
                    applies: ['ministerio p√∫blico', 'investigaci√≥n', 'polic√≠a', 'delito'],
                    relevancia: 'alta',
                    documentTypes: ['denuncia', 'inspeccion']
                }
            },
            CNPP: {
                'art131': {
                    content: 'Ejercicio de la acci√≥n penal - Corresponde al Ministerio P√∫blico el ejercicio exclusivo de la acci√≥n penal, la cual tiene por objeto el esclarecimiento de los hechos',
                    applies: ['acci√≥n penal', 'ministerio p√∫blico', 'esclarecimiento', 'hechos'],
                    relevancia: 'alta',
                    documentTypes: ['denuncia']
                },
                'art211': {
                    content: 'Denuncia - Cualquier persona que tenga conocimiento de la comisi√≥n de un delito podr√° denunciarlo ante el Ministerio P√∫blico',
                    applies: ['denuncia', 'conocimiento', 'delito', 'comisi√≥n'],
                    relevancia: 'alta',
                    documentTypes: ['denuncia']
                },
                'art259': {
                    content: 'Exclusi√≥n de prueba il√≠cita - El √ìrgano jurisdiccional no podr√° admitir o desahogar los medios de prueba que hayan sido obtenidos de manera il√≠cita',
                    applies: ['prueba il√≠cita', 'exclusi√≥n', 'admisi√≥n', 'il√≠cita'],
                    relevancia: 'media',
                    documentTypes: ['custodia', 'dictamen']
                },
                'art266': {
                    content: 'Cadena de custodia - Se aplicar√° la cadena de custodia a los indicios, huellas o vestigios del hecho delictuoso, as√≠ como a los instrumentos, objetos o productos del delito',
                    applies: ['cadena de custodia', 'indicios', 'huellas', 'vestigios', 'instrumentos'],
                    relevancia: 'alta',
                    documentTypes: ['custodia', 'inspeccion']
                },
                'art313': {
                    content: 'Declaraci√≥n del imputado - El imputado no estar√° obligado a declarar y su silencio no podr√° ser utilizado en su perjuicio',
                    applies: ['declaraci√≥n', 'imputado', 'silencio', 'perjuicio'],
                    relevancia: 'alta',
                    documentTypes: ['entrevista']
                },
                'art335': {
                    content: 'Testimonio - Toda persona tendr√° la obligaci√≥n de concurrir al llamamiento judicial y declarar la verdad de cuanto supiere y le fuere preguntado',
                    applies: ['testimonio', 'testigo', 'verdad', 'declarar'],
                    relevancia: 'media',
                    documentTypes: ['entrevista']
                },
                'art359': {
                    content: 'Dictamen pericial - Los peritos deber√°n tener t√≠tulo oficial en la ciencia, t√©cnica, arte, oficio o actividad especializada',
                    applies: ['dictamen pericial', 'perito', 't√≠tulo', 'especializada'],
                    relevancia: 'alta',
                    documentTypes: ['dictamen']
                }
            }
        };
    }

    // M√©todo adicional para limpiar el sistema
    resetSystem() {
        this.documents = [];
        this.analysisResults = [];
        this.currentProgress = 0;
        this.isAnalyzing = false;
        
        // Limpiar interfaz
        const fileList = document.getElementById('fileList');
        if (fileList) fileList.innerHTML = '';
        
        const resultsGrid = document.getElementById('resultsGrid');
        if (resultsGrid) resultsGrid.innerHTML = '';
        
        const analysisLog = document.getElementById('analysisLog');
        if (analysisLog) analysisLog.innerHTML = '';
        
        this.updateStats();
        this.updateDocumentTree();
        this.updateProgress();
        
        this.updateAnalysisLog('üîÑ Sistema reiniciado correctamente');
        console.log('Sistema reiniciado');
    }
}

// ===============================
// INICIALIZACI√ìN GLOBAL
// ===============================

let carpetaAnalyzer;

// Funci√≥n de exportaci√≥n global para HTML
function exportResultsAsPDF() {
    if (carpetaAnalyzer) {
        carpetaAnalyzer.exportResultsAsPDF();
    } else {
        alert('Sistema no inicializado correctamente.');
    }
}

// Funci√≥n global para reiniciar sistema
function resetSystem() {
    if (carpetaAnalyzer) {
        carpetaAnalyzer.resetSystem();
    }
}

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM cargado, inicializando CarpetaAnalyzer...');
    try {
        carpetaAnalyzer = new CarpetaAnalyzer();
        carpetaAnalyzer.init();
        console.log('‚úÖ CarpetaAnalyzer inicializado correctamente');
    } catch (error) {
        console.error('‚ùå Error inicializando CarpetaAnalyzer:', error);
        alert('Error inicializando el sistema. Revisa la consola para m√°s detalles.');
    }
});

// Event listener adicional para manejar errores
window.addEventListener('error', (event) => {
    console.error('Error global capturado:', event.error);
    if (carpetaAnalyzer) {
        carpetaAnalyzer.updateAnalysisLog(`‚ùå Error: ${event.error.message}`);
    }
});

console.log('üìã Sistema de An√°lisis Jur√≠dico Integral cargado - v1.0');
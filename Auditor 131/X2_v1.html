<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor Carpeta de Investigaci√≥n -131 CNPP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 3px dashed #dee2e6;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .upload-section.dragover {
            border-color: #28a745;
            background: #d4edda;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            display: inline-block;
            text-decoration: none;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,123,255,0.3);
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            flex-grow: 1;
        }

        .file-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .file-size {
            color: #6c757d;
            font-size: 0.9em;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .analyze-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40,167,69,0.3);
        }

        .analyze-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #007bff, #28a745);
            transition: width 0.3s ease;
            width: 0%;
        }

        .results-section {
            display: none;
            margin-top: 40px;
        }

        .analysis-summary {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .score-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            font-weight: bold;
            color: white;
            position: relative;
        }

        .score-low { background: linear-gradient(135deg, #dc3545, #c82333); }
        .score-medium { background: linear-gradient(135deg, #ffc107, #e0a800); }
        .score-high { background: linear-gradient(135deg, #28a745, #20c997); }

        .elements-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .element-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #dee2e6;
        }

        .element-card.present {
            border-left-color: #28a745;
        }

        .element-card.missing {
            border-left-color: #dc3545;
        }

        .element-card.partial {
            border-left-color: #ffc107;
        }

        .element-title {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .status-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .present .status-icon { color: #28a745; }
        .missing .status-icon { color: #dc3545; }
        .partial .status-icon { color: #ffc107; }

        .element-description {
            color: #6c757d;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .detailed-report {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
        }

        .report-section {
            margin-bottom: 30px;
        }

        .report-section h3 {
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .export-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            text-align: center;
        }

        .export-btn {
            background: linear-gradient(45deg, #6f42c1, #563d7c);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            margin: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(111,66,193,0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media print {
            body { background: white; }
            .container { box-shadow: none; }
            .upload-section, .export-controls { display: none; }
            .main-content { padding: 20px; }
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px dashed #ccc;
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
        }

        .debug-info ul {
            font-size: 0.9em;
            color: #333;
            margin-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Analizador de Carpetas de Investigaci√≥n</h1>
            <p>Sistema de Evaluaci√≥n de Integraci√≥n seg√∫n CNPP - Art√≠culo 131</p>
        </div>

        <div class="main-content">
            <!-- Secci√≥n de Carga de Archivos -->
            <div class="upload-section" id="uploadSection">
                <h2>üìÅ Cargar Documentos de la Carpeta de Investigaci√≥n</h2>
                <p>Soporta archivos PDF, DOC, DOCX y TXT</p>
                <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.doc,.docx,.txt">
                <label for="fileInput" class="upload-btn">
                    üìé Seleccionar Archivos
                </label>
                <div class="file-list" id="fileList"></div>
                <div id="debugFileOutput" class="debug-info">
                    <strong>üß™ Archivos cargados (debug):</strong>
                    <ul id="debugFileList"></ul>
                </div>
            </div>

            <button class="analyze-btn" id="analyzeBtn" onclick="startAnalysis()" disabled>
                üîç Analizar Carpeta de Investigaci√≥n
            </button>

            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Secci√≥n de Resultados -->
            <div class="results-section" id="resultsSection">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('summary')">Resumen Ejecutivo</button>
                    <button class="tab" onclick="showTab('checklist')">Lista de Verificaci√≥n</button>
                    <button class="tab" onclick="showTab('detailed')">Informe Detallado</button>
                    <button class="tab" onclick="showTab('legal')">Marco Legal</button>
                </div>

                <!-- Resumen Ejecutivo -->
                <div class="tab-content active" id="summary">
                    <div class="analysis-summary">
                        <div class="score-display">
                            <div class="score-circle" id="scoreCircle">
                                <span id="scoreText">0%</span>
                            </div>
                            <h3>Nivel de Judicializaci√≥n</h3>
                            <p id="scoreDescription">Evaluando...</p>
                        </div>
                        
                        <div class="report-section">
                            <h3>üìä An√°lisis General</h3>
                            <div id="generalAnalysis"></div>
                            <h3>üìà Histograma de Elementos CNPP</h3>
                            <canvas id="cnppChart" style="max-width: 100%; height: 300px;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Lista de Verificaci√≥n -->
                <div class="tab-content" id="checklist">
                    <h2>‚úÖ Elementos de la Carpeta de Investigaci√≥n</h2>
                    <div class="elements-checklist" id="elementsChecklist"></div>
                </div>

                <!-- Informe Detallado -->
                <div class="tab-content" id="detailed">
                    <div class="detailed-report" id="detailedReport"></div>
                </div>

                <!-- Marco Legal -->
                <div class="tab-content" id="legal">
                    <div class="detailed-report" id="legalFramework"></div>
                </div>

                <!-- Controles de Exportaci√≥n -->
                <div class="export-controls">
                    <h3>üìÑ Exportar Informe</h3>
                    <button class="export-btn" onclick="exportToHTML()">üìã Exportar HTML</button>
                    <button class="export-btn" onclick="exportToPDF()">üìë Generar PDF</button>
                    <button class="export-btn" onclick="printReport()">üñ®Ô∏è Imprimir</button>
                    <button class="export-btn" onclick="exportToJSON()">üíæ Exportar JSON</button>
                    <button class="export-btn" onclick="exportExecutiveSummaryToPDF()">üìÑ Exportar Resumen Ejecutivo</button>
                    <button id="printExecutiveBtn" onclick="printExecutiveSummary()" style="
                        position: fixed;
                        bottom: 30px;
                        right: 30px;
                        background: #007bff;
                        color: white;
                        border: none;
                        padding: 14px 20px;
                        border-radius: 50px;
                        box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
                        font-size: 1em;
                        cursor: pointer;
                        z-index: 9999;
                    ">
                        üñ®Ô∏è Imprimir Resumen
                    </button>
                </div>
            </div>
        </div>
    </div>
	
	<div id="avepdf-container-id">
<script type="text/javascript" src="https://avepdf.com/api/js/embedwidgets.js"></script>
	<script type="text/javascript">
		loadAvePDFWidget('cfa08d51-b5c4-4b96-b356-84967699309e', 'auto', 'cleanup-pdf', 'avepdf-container-id');
	</script>
</div>
<div id="avepdf-container-id">
<script type="text/javascript" src="https://avepdf.com/api/js/embedwidgets.js"></script>
	<script type="text/javascript">
		loadAvePDFWidget('cfa08d51-b5c4-4b96-b356-84967699309e', 'auto', 'hyper-compress-pdf', 'avepdf-container-id');
	</script>
</div>
<div id="avepdf-container-id">
<script type="text/javascript" src="https://avepdf.com/api/js/embedwidgets.js"></script>
	<script type="text/javascript">
		loadAvePDFWidget('cfa08d51-b5c4-4b96-b356-84967699309e', 'auto', 'pdf-ocr', 'avepdf-container-id');
	</script>
</div>

    <script>
        // Variables globales
        let uploadedFiles = [];
        let analysisResults = {};
        let processedDocuments = [];

        // Elementos CNPP requeridos para carpeta de investigaci√≥n
        const requiredElements = {
            'denuncia_querella': {
                name: 'Denuncia o Querella',
                description: 'Documento inicial que da inicio a la investigaci√≥n',
                keywords: ['denuncia', 'querella', 'hechos', 'delito', 'narraci√≥n'],
                weight: 15,
                required: true
            },
            'entrevista_victima': {
                name: 'Entrevista de la V√≠ctima',
                description: 'Declaraci√≥n formal de la persona ofendida',
                keywords: ['v√≠ctima', 'ofendido', 'entrevista', 'declaraci√≥n', 'testimonio'],
                weight: 12,
                required: true
            },
            'entrevista_testigos': {
                name: 'Entrevistas de Testigos',
                description: 'Declaraciones de personas que presenciaron los hechos',
                keywords: ['testigo', 'presencial', 'observ√≥', 'vio', 'escuch√≥'],
                weight: 10,
                required: false
            },
            'entrevista_policia': {
                name: 'Entrevista a Polic√≠as',
                description: 'Declaraci√≥n de elementos policiales intervinientes',
                keywords: ['polic√≠a', 'oficial', 'agente', 'elemento', 'intervenci√≥n'],
                weight: 8,
                required: false
            },
            'inspeccion_lugar': {
                name: 'Inspecci√≥n del Lugar de los Hechos',
                description: 'Registro detallado del sitio donde ocurrieron los hechos',
                keywords: ['inspecci√≥n', 'lugar', 'sitio', 'escena', 'criminal√≠stica'],
                weight: 12,
                required: true
            },
            'cadena_custodia': {
                name: 'Cadena de Custodia',
                description: 'Registro de manejo de evidencias y objetos',
                keywords: ['cadena', 'custodia', 'evidencia', 'indicio', 'objeto'],
                weight: 10,
                required: true
            },
            'dictamen_pericial': {
                name: 'Dict√°menes Periciales',
                description: 'An√°lisis t√©cnico-cient√≠fico de evidencias',
                keywords: ['perito', 'dictamen', 'an√°lisis', 'laboratorio', 't√©cnico'],
                weight: 8,
                required: false
            },
            'informe_investigacion': {
                name: 'Informe de Investigaci√≥n',
                description: 'Resumen de actividades investigativas realizadas',
                keywords: ['informe', 'investigaci√≥n', 'actividades', 'diligencias'],
                weight: 8,
                required: true
            },
            'acuerdo_reparatorio': {
                name: 'Acuerdo Reparatorio',
                description: 'Convenio entre v√≠ctima e imputado (si aplica)',
                keywords: ['acuerdo', 'reparatorio', 'convenio', 'reparaci√≥n'],
                weight: 5,
                required: false
            },
            'orden_aprehension': {
                name: 'Orden de Aprehensi√≥n',
                description: 'Mandamiento judicial para detenci√≥n (si aplica)',
                keywords: ['orden', 'aprehensi√≥n', 'detenci√≥n', 'mandamiento'],
                weight: 7,
                required: false
            }
        };

        // Inicializaci√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando aplicaci√≥n...');
            setupFileUpload();
            setupDragAndDrop();
        });

        // Configuraci√≥n de carga de archivos
        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', handleFileSelect);
            console.log('Event listener para archivos configurado');
        }

        // Configuraci√≥n de drag & drop
        function setupDragAndDrop() {
            const uploadSection = document.getElementById('uploadSection');
            
            uploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFiles(files);
            });
        }

        // Manejo de selecci√≥n de archivos
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            console.log('Archivos seleccionados:', files);
            handleFiles(files);
        }

        // Procesamiento de archivos
        function handleFiles(files) {
            const validTypes = ['.pdf', '.doc', '.docx', '.txt'];
            
            files.forEach(file => {
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                if (validTypes.includes(fileExtension)) {
                    uploadedFiles.push({
                        file,
                        name: file.name,
                        size: file.size,
                        type: fileExtension,
                        id: Date.now() + Math.random()
                    });
                } else {
                    alert(`Archivo ${file.name} no es compatible. Solo se aceptan PDF, DOC, DOCX y TXT.`);
                }
            });

            console.log('Archivos v√°lidos cargados:', uploadedFiles);
            updateFileList();
            updateAnalyzeButton();
            updateDebugInfo();
        }

        // Actualizar informaci√≥n de debug
        function updateDebugInfo() {
            const debugList = document.getElementById('debugFileList');
            if (debugList) {
                debugList.innerHTML = uploadedFiles.map(f =>
                    `<li>${f.name} - ${f.type.toUpperCase()} - ${formatFileSize(f.size)}</li>`
                ).join('');
            }
        }

        // Actualizar lista de archivos
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = '';
                return;
            }

            fileList.innerHTML = uploadedFiles.map(fileObj => `
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-name">üìÑ ${fileObj.name}</div>
                        <div class="file-size">${formatFileSize(fileObj.size)} - ${fileObj.type.toUpperCase()}</div>
                    </div>
                    <button class="remove-btn" onclick="removeFile('${fileObj.id}')">‚ùå</button>
                </div>
            `).join('');
        }

        // Remover archivo
        function removeFile(fileId) {
            uploadedFiles = uploadedFiles.filter(f => f.id != fileId);
            updateFileList();
            updateAnalyzeButton();
            updateDebugInfo();
        }

        // Formatear tama√±o de archivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Actualizar bot√≥n de an√°lisis
        function updateAnalyzeButton() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = uploadedFiles.length === 0;
        }

        // Mostrar pesta√±as
        function showTab(tabName) {
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Desactivar todas las pesta√±as
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar contenido seleccionado
            document.getElementById(tabName).classList.add('active');
            
            // Activar pesta√±a seleccionada
            event.target.classList.add('active');
        }

        // Iniciar an√°lisis
        async function startAnalysis() {
            if (uploadedFiles.length === 0) return;

            console.log('Iniciando an√°lisis de', uploadedFiles.length, 'archivos');
            
            // Mostrar progreso
            document.getElementById('progressBar').style.display = 'block';
            document.getElementById('analyzeBtn').disabled = true;
            
            try {
                // Procesar archivos
                processedDocuments = [];
                for (let i = 0; i < uploadedFiles.length; i++) {
                    updateProgress((i / uploadedFiles.length) * 50);
                    const processedDoc = await processDocument(uploadedFiles[i]);
                    processedDocuments.push(processedDoc);
                }

                console.log('Documentos procesados:', processedDocuments);

                // Analizar contenido
                updateProgress(60);
                analysisResults = await analyzeDocuments(processedDocuments);
                
                // Generar reportes
                updateProgress(80);
                generateReports();
                
                updateProgress(100);
                
                // Mostrar resultados
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('progressBar').style.display = 'none';
                
            } catch (error) {
                console.error('Error en an√°lisis:', error);
                alert('Error al procesar documentos: ' + error.message);
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        // Actualizar barra de progreso
        function updateProgress(percentage) {
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        // NOTA: Las siguientes funciones necesitan la segunda parte del c√≥digo para completarse:
        // - processDocument()
        // - analyzeDocuments()
        // - generateReports()
        // - Funciones de exportaci√≥n
        
        // Procesar documento espec√≠fico
        async function processDocument(fileObj) {
            console.log('Procesando documento:', fileObj.name);
            
            try {
                let content = '';
                const file = fileObj.file;
                
                if (fileObj.type === '.txt') {
                    content = await readTextFile(file);
                } else if (fileObj.type === '.pdf') {
                    content = await readPDFFile(file);
                } else if (fileObj.type === '.doc' || fileObj.type === '.docx') {
                    content = await readWordFile(file);
                }
                
                return {
                    name: fileObj.name,
                    type: fileObj.type,
                    content: content,
                    wordCount: content.split(/\s+/).length,
                    status: 'processed'
                };
            } catch (error) {
                console.error('Error procesando documento:', error);
                return {
                    name: fileObj.name,
                    type: fileObj.type,
                    content: '',
                    wordCount: 0,
                    status: 'error',
                    error: error.message
                };
            }
        }

        // Leer archivo de texto
        async function readTextFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Error leyendo archivo de texto'));
                reader.readAsText(file, 'UTF-8');
            });
        }

        // Leer archivo PDF
        async function readPDFFile(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                return fullText;
            } catch (error) {
                console.error('Error leyendo PDF:', error);
                throw new Error('No se pudo leer el archivo PDF');
            }
        }

        // Leer archivo Word
        async function readWordFile(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer });
                return result.value;
            } catch (error) {
                console.error('Error leyendo Word:', error);
                throw new Error('No se pudo leer el archivo Word');
            }
        }

        // Analizar documentos procesados
        async function analyzeDocuments(documents) {
            console.log('Iniciando an√°lisis de documentos...');
            
            const results = {
                totalDocuments: documents.length,
                totalWords: documents.reduce((sum, doc) => sum + doc.wordCount, 0),
                elements: {},
                score: 0,
                analysis: '',
                recommendations: [],
                missingElements: [],
                foundElements: []
            };

            // Analizar cada elemento requerido
            for (const [key, element] of Object.entries(requiredElements)) {
                const elementResult = analyzeElement(documents, element);
                results.elements[key] = elementResult;
                
                if (elementResult.found) {
                    results.foundElements.push(element.name);
                } else if (element.required) {
                    results.missingElements.push(element.name);
                }
            }

            // Calcular puntuaci√≥n
            results.score = calculateScore(results.elements);
            
            // Generar an√°lisis textual
            results.analysis = generateAnalysisText(results);
            
            // Generar recomendaciones
            results.recommendations = generateRecommendations(results);

            console.log('An√°lisis completado:', results);
            return results;
        }

        // Analizar elemento espec√≠fico
        function analyzeElement(documents, element) {
            let found = false;
            let confidence = 0;
            let evidence = [];
            let documentMatches = [];

            documents.forEach(doc => {
                if (doc.status === 'error') return;
                
                const content = doc.content.toLowerCase();
                let docScore = 0;
                let docEvidence = [];

                element.keywords.forEach(keyword => {
                    const regex = new RegExp(`\\b${keyword.toLowerCase()}\\b`, 'gi');
                    const matches = content.match(regex);
                    if (matches) {
                        docScore += matches.length;
                        docEvidence.push(`"${keyword}" (${matches.length} veces)`);
                    }
                });

                if (docScore > 0) {
                    found = true;
                    documentMatches.push({
                        document: doc.name,
                        score: docScore,
                        evidence: docEvidence
                    });
                    evidence = evidence.concat(docEvidence);
                }
            });

            // Calcular confianza basada en n√∫mero de coincidencias
            if (found) {
                const totalMatches = documentMatches.reduce((sum, match) => sum + match.score, 0);
                confidence = Math.min(totalMatches / element.keywords.length * 20, 100);
            }

            return {
                found,
                confidence: Math.round(confidence),
                evidence,
                documentMatches,
                required: element.required,
                weight: element.weight
            };
        }

        // Calcular puntuaci√≥n general
        function calculateScore(elements) {
            let totalWeight = 0;
            let achievedWeight = 0;

            for (const [key, element] of Object.entries(elements)) {
                const requiredElement = requiredElements[key];
                totalWeight += requiredElement.weight;
                
                if (element.found) {
                    achievedWeight += requiredElement.weight * (element.confidence / 100);
                }
            }

            return Math.round((achievedWeight / totalWeight) * 100);
        }

        // Generar texto de an√°lisis
        function generateAnalysisText(results) {
            let analysis = `Se analizaron ${results.totalDocuments} documentos con un total de ${results.totalWords.toLocaleString()} palabras.\n\n`;
            
            analysis += `ELEMENTOS ENCONTRADOS (${results.foundElements.length}):\n`;
            results.foundElements.forEach(element => {
                analysis += `‚Ä¢ ${element}\n`;
            });
            
            if (results.missingElements.length > 0) {
                analysis += `\nELEMENTOS FALTANTES REQUERIDOS (${results.missingElements.length}):\n`;
                results.missingElements.forEach(element => {
                    analysis += `‚Ä¢ ${element}\n`;
                });
            }

            return analysis;
        }

        // Generar recomendaciones
        function generateRecommendations(results) {
            const recommendations = [];
            
            if (results.score < 50) {
                recommendations.push('La carpeta de investigaci√≥n presenta deficiencias graves que impiden su judicializaci√≥n.');
            } else if (results.score < 75) {
                recommendations.push('La carpeta requiere complementar elementos antes de proceder a judicializaci√≥n.');
            } else {
                recommendations.push('La carpeta cumple con los elementos m√≠nimos para judicializaci√≥n.');
            }

            // Recomendaciones espec√≠ficas por elementos faltantes
            results.missingElements.forEach(element => {
                recommendations.push(`Se requiere incorporar: ${element}`);
            });

            return recommendations;
        }

        // Generar todos los reportes
        function generateReports() {
            generateExecutiveSummary();
            generateChecklist();
            generateDetailedReport();
            generateLegalFramework();
            generateChart();
        }

        // Generar resumen ejecutivo
        function generateExecutiveSummary() {
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreText = document.getElementById('scoreText');
            const scoreDescription = document.getElementById('scoreDescription');
            const generalAnalysis = document.getElementById('generalAnalysis');

            // Actualizar puntuaci√≥n
            scoreText.textContent = analysisResults.score + '%';
            
            // Determinar clase de color
            if (analysisResults.score >= 75) {
                scoreCircle.className = 'score-circle score-high';
                scoreDescription.textContent = 'Apto para Judicializaci√≥n';
            } else if (analysisResults.score >= 50) {
                scoreCircle.className = 'score-circle score-medium';
                scoreDescription.textContent = 'Requiere Complementos';
            } else {
                scoreCircle.className = 'score-circle score-low';
                scoreDescription.textContent = 'No Apto - Deficiencias Graves';
            }

            // An√°lisis general
            generalAnalysis.innerHTML = `
                <div style="text-align: left;">
                    <h4>üìã Resumen del An√°lisis</h4>
                    <p><strong>Documentos Analizados:</strong> ${analysisResults.totalDocuments}</p>
                    <p><strong>Total de Palabras:</strong> ${analysisResults.totalWords.toLocaleString()}</p>
                    <p><strong>Elementos Encontrados:</strong> ${analysisResults.foundElements.length}/10</p>
                    <p><strong>Elementos Faltantes Cr√≠ticos:</strong> ${analysisResults.missingElements.length}</p>
                    
                    <h4>üéØ Recomendaciones Principales</h4>
                    <ul>
                        ${analysisResults.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        // Generar lista de verificaci√≥n
        function generateChecklist() {
            const checklist = document.getElementById('elementsChecklist');
            
            checklist.innerHTML = Object.entries(requiredElements).map(([key, element]) => {
                const result = analysisResults.elements[key];
                let status, icon;
                
                if (result.found) {
                    if (result.confidence >= 80) {
                        status = 'present';
                        icon = '‚úÖ';
                    } else {
                        status = 'partial';
                        icon = '‚ö†Ô∏è';
                    }
                } else {
                    status = 'missing';
                    icon = '‚ùå';
                }

                return `
                    <div class="element-card ${status}">
                        <div class="element-title">
                            <span class="status-icon">${icon}</span>
                            ${element.name}
                            ${element.required ? '<span style="color: #dc3545; font-size: 0.8em;">(REQUERIDO)</span>' : ''}
                        </div>
                        <div class="element-description">
                            ${element.description}
                            ${result.found ? `<br><strong>Confianza:</strong> ${result.confidence}%` : ''}
                            ${result.evidence.length > 0 ? `<br><strong>Evidencia:</strong> ${result.evidence.slice(0, 3).join(', ')}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Generar reporte detallado
        function generateDetailedReport() {
            const detailedReport = document.getElementById('detailedReport');
            
            detailedReport.innerHTML = `
                <h2>üìä Informe Detallado de An√°lisis</h2>
                
                <div class="report-section">
                    <h3>üéØ Puntuaci√≥n General</h3>
                    <p>La carpeta de investigaci√≥n obtuvo una puntuaci√≥n de <strong>${analysisResults.score}%</strong>, lo que indica un nivel de integraci√≥n ${getScoreLevel(analysisResults.score)}.</p>
                </div>

                <div class="report-section">
                    <h3>üìã An√°lisis por Documento</h3>
                    ${processedDocuments.map(doc => `
                        <div style="border-left: 3px solid #007bff; padding-left: 15px; margin: 15px 0;">
                            <h4>${doc.name}</h4>
                            <p><strong>Tipo:</strong> ${doc.type.toUpperCase()}</p>
                            <p><strong>Palabras:</strong> ${doc.wordCount.toLocaleString()}</p>
                            <p><strong>Estado:</strong> ${doc.status === 'processed' ? '‚úÖ Procesado' : '‚ùå Error'}</p>
                            ${doc.error ? `<p style="color: #dc3545;"><strong>Error:</strong> ${doc.error}</p>` : ''}
                        </div>
                    `).join('')}
                </div>

                <div class="report-section">
                    <h3>üîç An√°lisis Detallado por Elemento</h3>
                    ${Object.entries(requiredElements).map(([key, element]) => {
                        const result = analysisResults.elements[key];
                        return `
                            <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0;">
                                <h4>${result.found ? '‚úÖ' : '‚ùå'} ${element.name}</h4>
                                <p><strong>Descripci√≥n:</strong> ${element.description}</p>
                                <p><strong>Requerido:</strong> ${element.required ? 'S√≠' : 'No'}</p>
                                <p><strong>Peso:</strong> ${element.weight}%</p>
                                <p><strong>Estado:</strong> ${result.found ? `Encontrado (${result.confidence}% confianza)` : 'No encontrado'}</p>
                                
                                ${result.documentMatches.length > 0 ? `
                                    <p><strong>Documentos con coincidencias:</strong></p>
                                    <ul>
                                        ${result.documentMatches.map(match => `
                                            <li>${match.document} - ${match.score} coincidencias</li>
                                        `).join('')}
                                    </ul>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Generar marco legal
        function generateLegalFramework() {
            const legalFramework = document.getElementById('legalFramework');
            
            legalFramework.innerHTML = `
                <h2>‚öñÔ∏è Marco Legal de Referencia</h2>
                
                <div class="report-section">
                    <h3>üìñ C√≥digo Nacional de Procedimientos Penales - Art√≠culo 131</h3>
                    <p>El art√≠culo 131 del CNPP establece los elementos m√≠nimos que debe contener la carpeta de investigaci√≥n para su correcta integraci√≥n y posterior judicializaci√≥n.</p>
					<ul>
					<p>Art√≠culo 212 Deber de investigaci√≥n penal</p>
					<p>Cuando el Ministerio P√∫blico tenga conocimiento de la existencia de un hecho que la ley se√±ale como delito, dirigir√° la investigaci√≥n penal, sin que pueda suspender, interrumpir o hacer cesar su curso, salvo en los casos autorizados en la misma.</p>
					<p>La investigaci√≥n deber√° realizarse de manera inmediata, eficiente, exhaustiva, profesional e imparcial, libre de estereotipos y discriminaci√≥n, orientada a explorar todas las l√≠neas de investigaci√≥n posibles que permitan allegarse de datos para el esclarecimiento del hecho que la ley se√±ala como delito, as√≠ como la identificaci√≥n de quien lo cometi√≥ o particip√≥ en su comisi√≥n.</p>
					<ul>
					<p>Art√≠culo 213 Objeto de la investigaci√≥n</p>
					<p>La investigaci√≥n tiene por objeto que el Ministerio P√∫blico re√∫na indicios para el esclarecimiento de los hechos y, en su caso, los datos de prueba para sustentar el ejercicio de la acci√≥n penal, la acusaci√≥n contra el imputado y la reparaci√≥n del da√±o.</p>
					<ul>
					<p>Art√≠culo 214 Principios que rigen a las autoridades de la investigaci√≥n</p>
					<p>Las autoridades encargadas de desarrollar la investigaci√≥n de los delitos se regir√°n por los principios de legalidad, objetividad, eficiencia, profesionalismo, honradez, lealtad y respeto a los derechos humanos reconocidos en la Constituci√≥n y en los Tratados.</p>
					<ul>
					<p>Art√≠culo 215 Obligaci√≥n de suministrar informaci√≥n</p>
					<p>Toda persona o servidor p√∫blico est√° obligado a proporcionar oportunamente la informaci√≥n que requieran el Ministerio P√∫blico y la Polic√≠a en el ejercicio de sus funciones de investigaci√≥n de un hecho delictivo concreto. En caso de ser citados para ser entrevistados por el Ministerio P√∫blico o la Polic√≠a, tienen obligaci√≥n de comparecer y s√≥lo podr√°n excusarse en los casos expresamente previstos en la ley. En caso de incumplimiento, se incurrir√° en responsabilidad y ser√° sancionado de conformidad con las leyes aplicables.</p>
					<ul>
					<p>Art√≠culo 216 Proposici√≥n de actos de investigaci√≥n</p>
					<p>Durante la investigaci√≥n, tanto el imputado cuando haya comparecido o haya sido entrevistado, como su Defensor, as√≠ como la v√≠ctima u ofendido, podr√°n solicitar al Ministerio P√∫blico todos aquellos actos de investigaci√≥n que consideraren pertinentes y √∫tiles para el esclarecimiento de los hechos. El Ministerio P√∫blico ordenar√° que se lleven a cabo aquellos que sean conducentes. La solicitud deber√° resolverse en un plazo m√°ximo de tres d√≠as siguientes a la fecha en que se haya formulado la petici√≥n al Ministerio P√∫blico.</p>
					<ul>
					<p>Art√≠culo 217 Registro de los actos de investigaci√≥n</p>
					<p>El Ministerio P√∫blico y la Polic√≠a deber√°n dejar registro de todas las actuaciones que se realicen durante la investigaci√≥n de los delitos, utilizando al efecto cualquier medio que permita garantizar que la informaci√≥n recabada sea completa, √≠ntegra y exacta, as√≠ como el acceso a la misma por parte de los sujetos que de acuerdo con la ley tuvieren derecho a exigirlo.</p>
					<p>Cada acto de investigaci√≥n se registrar√° por separado, y ser√° firmado por quienes hayan intervenido. Si no quisieren o no pudieren firmar, se imprimir√° su huella digital. En caso de que esto no sea posible o la persona se niegue a imprimir su huella, se har√° constar el motivo.</p>
					<p>El registro de cada actuaci√≥n deber√° contener por lo menos la indicaci√≥n de la fecha, hora y lugar en que se haya efectuado, identificaci√≥n de los servidores p√∫blicos y dem√°s personas que hayan intervenido y una breve descripci√≥n de la actuaci√≥n y, en su caso, de sus resultados.</p>
					<ul>
					<p>Art√≠culo 218 Reserva de los actos de investigaci√≥n</p>
					<p>Los registros de la investigaci√≥n, as√≠ como todos los documentos, independientemente de su contenido o naturaleza, los objetos, los registros de voz e im√°genes o cosas que le est√©n relacionados, son estrictamente reservados, por lo que √∫nicamente las partes, podr√°n tener acceso a los mismos, con las limitaciones establecidas en este C√≥digo y dem√°s disposiciones aplicables.</p>
					<p>La v√≠ctima u ofendido y su Asesor Jur√≠dico podr√°n tener acceso a los registros de la investigaci√≥n en cualquier momento.</p>
					<p>El imputado y su defensor podr√°n tener acceso a ellos cuando se encuentre detenido, sea citado para comparecer como imputado o sea sujeto de un acto de molestia y se pretenda recibir su entrevista, a partir de este momento ya no podr√°n mantenerse en reserva los registros para el imputado o su Defensor a fin de no afectar su derecho de defensa. Para los efectos de este p√°rrafo, se entender√° como acto de molestia lo dispuesto en el art√≠culo 266 de este C√≥digo.</p>
					<p>En ning√∫n caso la reserva de los registros podr√° hacerse valer en perjuicio del imputado y su Defensor, una vez dictado el auto de vinculaci√≥n a proceso, salvo lo previsto en este C√≥digo o en las leyes especiales.</p>
					<p>Para efectos de acceso a la informaci√≥n p√∫blica gubernamental, el Ministerio P√∫blico √∫nicamente deber√° proporcionar una versi√≥n p√∫blica de las determinaciones de no ejercicio de la acci√≥n penal, archivo temporal o de aplicaci√≥n de un criterio de oportunidad, siempre que haya transcurrido un plazo igual al de prescripci√≥n de los delitos de que se trate, de conformidad con lo dispuesto en el C√≥digo Penal Federal o estatal correspondiente, sin que pueda ser menor de tres a√±os, ni mayor de doce a√±os, contado a partir de que dicha determinaci√≥n haya quedado firme.</p>
										<p>(ART√çCULO REFORMADO D.O.F. 17 DE JUNIO DE 2016)</p>
					<ul>
					<p>Art√≠culo 219 Acceso a los registros y la audiencia inicial</p>
					<p>Una vez convocados a la audiencia inicial, el imputado y su Defensor tienen derecho a consultar los registros de la investigaci√≥n y a obtener copia, con la oportunidad debida para preparar la defensa. En caso que el Ministerio P√∫blico se niegue a permitir el acceso a los registros o a la obtenci√≥n de las copias, podr√°n acudir ante el Juez de control para que resuelva lo conducente.</p>
					<ul>
					<p>Art√≠culo 220 Excepciones para el acceso a la informaci√≥n</p>
					<p>El Ministerio P√∫blico podr√° solicitar excepcionalmente al Juez de control que determinada informaci√≥n se mantenga bajo reserva a√∫n despu√©s de la vinculaci√≥n a proceso, cuando sea necesario para evitar la destrucci√≥n, alteraci√≥n u ocultamiento de pruebas, la intimidaci√≥n, amenaza o influencia a los testigos del hecho, para asegurar el √©xito de la investigaci√≥n, o para garantizar la protecci√≥n de personas o bienes jur√≠dicos.</p>
					<p>Si el Juez de control considera procedente la solicitud, as√≠ lo resolver√° y determinar√° el plazo de la reserva, siempre que la informaci√≥n que se solicita sea reservada, sea oportunamente revelada para no afectar el derecho de defensa. La reserva podr√° ser prorrogada cuando sea estrictamente necesario, pero no podr√° prolongarse hasta despu√©s de la formulaci√≥n de la acusaci√≥n.</p>
					<ul>
					<p>Art√≠culo 221 Formas de inicio</p>
					<p>La investigaci√≥n de los hechos que revistan caracter√≠sticas de un delito podr√° iniciarse por denuncia, por querella o por su equivalente cuando la ley lo exija. El Ministerio P√∫blico y la Polic√≠a est√°n obligados a proceder sin mayores requisitos a la investigaci√≥n de los hechos de los que tengan noticia.</p>
					<p>Trat√°ndose de delitos que deban perseguirse de oficio, bastar√° para el inicio de la investigaci√≥n la comunicaci√≥n que haga cualquier persona, en la que se haga del conocimiento de la autoridad investigadora los hechos que pudieran ser constitutivos de un delito.</p>
					<p>Trat√°ndose de informaciones an√≥nimas, la Polic√≠a constatar√° la veracidad de los datos aportados mediante los actos de investigaci√≥n que consideren conducentes para este efecto. De confirmarse la informaci√≥n, se iniciar√° la investigaci√≥n correspondiente.</p>
					<p>Cuando el Ministerio P√∫blico tenga conocimiento de la probable comisi√≥n de un hecho delictivo cuya persecuci√≥n dependa de querella o de cualquier otro requisito equivalente que deba formular alguna autoridad, lo comunicar√° por escrito y de inmediato a √©sta, a fin de que resuelva lo que a sus facultades o atribuciones corresponda. Las autoridades har√°n saber por escrito al Ministerio P√∫blico la determinaci√≥n que adopten.</p>
					<p>El Ministerio P√∫blico podr√° aplicar el criterio de oportunidad en los casos previstos por las disposiciones legales aplicables o no iniciar investigaci√≥n cuando resulte evidente que no hay delito que perseguir. Las decisiones del Ministerio P√∫blico ser√°n impugnables en los t√©rminos que prev√© este C√≥digo.</p>
					<ul>
					<p>Art√≠culo 222 Deber de denunciar</p>
					<p>Toda persona a quien le conste que se ha cometido un hecho probablemente constitutivo de un delito est√° obligada a denunciarlo ante el Ministerio P√∫blico y en caso de urgencia ante cualquier agente de la Polic√≠a.</p>
					<p>Quien en ejercicio de funciones p√∫blicas tenga conocimiento de la probable existencia de un hecho que la ley se√±ale como delito, est√° obligado a denunciarlo inmediatamente al Ministerio P√∫blico, proporcion√°ndole todos los datos que tuviere, poniendo a su disposici√≥n a los imputados, si hubieren sido detenidos en flagrancia. Quien tenga el deber jur√≠dico de denunciar y no lo haga, ser√° acreedor a las sanciones correspondientes.</p>
					<p>Cuando el ejercicio de las funciones p√∫blicas a que se refiere el p√°rrafo anterior, correspondan a la coadyuvancia con las autoridades responsables de la seguridad p√∫blica, adem√°s de cumplir con lo previsto en dicho p√°rrafo, la intervenci√≥n de los servidores p√∫blicos respectivos deber√° limitarse a preservar el lugar de los hechos hasta el arribo de las autoridades competentes y, en su caso, adoptar las medidas a su alcance para que se brinde atenci√≥n m√©dica de urgencia a los heridos si los hubiere, as√≠ como poner a disposici√≥n de la autoridad a los detenidos por conducto o en coordinaci√≥n con la polic√≠a.</p>
					<p>(P√ÅRRAFO ADICIONADO D.O.F. 17 DE JUNIO DE 2016)</p>
					<p>No estar√°n obligados a denunciar quienes al momento de la comisi√≥n del delito detenten el car√°cter de tutor, curador, pupilo, c√≥nyuge, concubina o concubinario, conviviente del imputado, los parientes por consanguinidad o por afinidad en la l√≠nea recta ascendente o descendente hasta el cuarto grado y en la colateral por consanguinidad o afinidad, hasta el segundo grado inclusive.</p>
					<ul>
					<p>Art√≠culo 223 Forma y contenido de la denuncia</p>
					<p>La denuncia podr√° formularse por cualquier medio y deber√° contener, salvo los casos de denuncia an√≥nima o reserva de identidad, la identificaci√≥n del denunciante, su domicilio, la narraci√≥n circunstanciada del hecho, la indicaci√≥n de qui√©n o qui√©nes lo habr√≠an cometido y de las personas que lo hayan presenciado o que tengan noticia de √©l y todo cuanto le constare al denunciante.</p>
					<p>En el caso de que la denuncia se haga en forma oral, se levantar√° un registro en presencia del denunciante, quien previa lectura que se haga de la misma, lo firmar√° junto con el servidor p√∫blico que la reciba. La denuncia escrita ser√° firmada por el denunciante.</p>
					<p>En ambos casos, si el denunciante no pudiere firmar, estampar√° su huella digital, previa lectura que se le haga de la misma.</p>
					<ul>
					<p>Art√≠culo 224 Tr√°mite de la denuncia</p>
					<p>Cuando la denuncia sea presentada directamente ante el Ministerio P√∫blico, √©ste iniciar√° la investigaci√≥n conforme a las reglas previstas en este C√≥digo.</p>
					<p>Cuando la denuncia sea presentada ante la Polic√≠a, √©sta informar√° de dicha circunstancia al Ministerio P√∫blico en forma inmediata y por cualquier medio, sin perjuicio de realizar las diligencias urgentes que se requieran dando cuenta de ello en forma posterior al Ministerio P√∫blico.</p>
					<ul>
					<p>Art√≠culo 225 Querella u otro requisito equivalente</p>
					<p>La querella es la expresi√≥n de la voluntad de la v√≠ctima u ofendido o de quien legalmente se encuentre facultado para ello, mediante la cual manifiesta expresamente ante el Ministerio P√∫blico su pretensi√≥n de que se inicie la investigaci√≥n de uno o varios hechos que la ley se√±ale como delitos y que requieran de este requisito de procedibilidad para ser investigados y, en su caso, se ejerza la acci√≥n penal correspondiente.</p>
					<p>La querella deber√° contener, en lo conducente, los mismos requisitos que los previstos para la denuncia. El Ministerio P√∫blico deber√° cerciorarse que √©stos se encuentren debidamente satisfechos para, en su caso, proceder en los t√©rminos que prev√© el presente C√≥digo. Trat√°ndose de requisitos de procedibilidad equivalentes, el Ministerio P√∫blico deber√° realizar la misma verificaci√≥n.</p>
					<ul>
					<p>Art√≠culo 226 Querella de personas menores de edad o que no tienen capacidad para comprender el significado del hecho</p>
					<p>Trat√°ndose de personas menores de dieciocho a√±os, o de personas que no tengan la capacidad de comprender el significado del hecho, la querella podr√° ser presentada por quienes ejerzan la patria potestad o la tutela o sus representantes legales, sin perjuicio de que puedan hacerlo por s√≠ mismos, por sus hermanos o un tercero, cuando se trate de delitos cometidos en su contra por quienes ejerzan la patria potestad, la tutela o sus propios representantes.</p>
					<ul>
					<p>Art√≠culo 227 Cadena de custodia</p>
					<p>La cadena de custodia es el sistema de control y registro que se aplica al indicio, evidencia, objeto, instrumento o producto del hecho delictivo, desde su localizaci√≥n, descubrimiento o aportaci√≥n, en el lugar de los hechos o del hallazgo, hasta que la autoridad competente ordene su conclusi√≥n.</p>
					<p>Con el fin de corroborar los elementos materiales probatorios y la evidencia f√≠sica, la cadena de custodia se aplicar√° teniendo en cuenta los siguientes factores: identidad, estado original, condiciones de recolecci√≥n, preservaci√≥n, empaque y traslado; lugares y fechas de permanencia y los cambios que en cada custodia se hayan realizado; igualmente se registrar√° el nombre y la identificaci√≥n de todas las personas que hayan estado en contacto con esos elementos.</p>
					<ul>
					<p>Art√≠culo 228 Responsables de cadena de custodia</p>
					<p>La aplicaci√≥n de la cadena de custodia es responsabilidad de quienes, en cumplimiento de las funciones propias de su encargo o actividad, en los t√©rminos de ley, tengan contacto con los indicios, vestigios, evidencias, objetos, instrumentos o productos del hecho delictivo.</p>
					<p>Cuando durante el procedimiento de cadena de custodia los indicios, huellas o vestigios del hecho delictivo, as√≠ como los instrumentos, objetos o productos del delito se alteren, no perder√°n su valor probatorio, a menos que la autoridad competente verifique que han sido modificados de tal forma que hayan perdido su eficacia para acreditar el hecho o circunstancia de que se trate. Los indicios, huellas o vestigios del hecho delictivo, as√≠ como los instrumentos, objetos o productos del delito deber√°n concatenarse con otros medios probatorios para tal fin. Lo anterior, con independencia de la responsabilidad en que pudieran incurrir los servidores p√∫blicos por la inobservancia de este procedimiento.</p>
					<ul>
					<p>Art√≠culo 229 Aseguramiento de bienes, instrumentos, objetos o productos del delito</p>
					<p>Los instrumentos, objetos o productos del delito, as√≠ como los bienes en que existan huellas o pudieran tener relaci√≥n con √©ste, siempre que guarden relaci√≥n directa con el lugar de los hechos o del hallazgo, ser√°n asegurados durante el desarrollo de la investigaci√≥n, a fin de que no se alteren, destruyan o desaparezcan. Para tales efectos se establecer√°n controles espec√≠ficos para su resguardo, que atender√°n como m√≠nimo a la naturaleza del bien y a la peligrosidad de su conservaci√≥n.</p>
					<ul>
					<p>Art√≠culo 230 Reglas sobre el aseguramiento de bienes</p>
					<p>El aseguramiento de bienes se realizar√° conforme a lo siguiente:</p>
					<p>I.El Ministerio P√∫blico, o la Polic√≠a en auxilio de √©ste, deber√° elaborar un inventario de todos y cada uno de los bienes que se pretendan asegurar, firmado por el imputado o la persona con quien se atienda el acto de investigaci√≥n. Ante su ausencia o negativa, la relaci√≥n deber√° ser firmada por dos testigos presenciales que preferentemente no sean miembros de la Polic√≠a y cuando ello suceda, que no hayan participado materialmente en la ejecuci√≥n del acto;</p>
					<p>II.La Polic√≠a deber√° tomar las providencias necesarias para la debida preservaci√≥n del lugar de los hechos o del hallazgo y de los indicios, huellas, o vestigios del hecho delictivo, as√≠ como de los instrumentos, objetos o productos del delito asegurados, y</p>
					<p>III.Los bienes asegurados y el inventario correspondiente se pondr√°n a la brevedad a disposici√≥n de la autoridad competente, de conformidad con las disposiciones aplicables. Se deber√° informar si los bienes asegurados son indicio, evidencia f√≠sica, objeto, instrumento o producto del hecho delictivo.</p>
					<ul>
					<p>Art√≠culo 230. Reglas sobre el aseguramiento de bienes</p>
					<p>El aseguramiento de bienes se realizar√° conforme a lo siguiente:</p>
					<p>I. El Ministerio P√∫blico, o la Polic√≠a en auxilio de √©ste, deber√° elaborar un inventario de todos y cada uno de los bienes que se pretendan asegurar, firmado por el imputado o la persona con quien se atienda el acto de investigaci√≥n. Ante su ausencia o negativa, la relaci√≥n deber√° ser firmada por dos testigos presenciales que preferentemente no sean miembros de la Polic√≠a y cuando ello suceda, que no hayan participado materialmente en la ejecuci√≥n del acto;</p>
					<p>II. La Polic√≠a deber√° tomar las providencias necesarias para la debida preservaci√≥n del lugar de los hechos o del hallazgo y de los indicios, huellas, o vestigios del hecho delictivo, as√≠ como de los instrumentos, objetos o productos del delito asegurados, y</p>
					<p>III. Los bienes asegurados y el inventario correspondiente se pondr√°n a la brevedad a disposici√≥n de la autoridad competente, de conformidad con las disposiciones aplicables. Se deber√° informar si los bienes asegurados son indicio, evidencia f√≠sica, objeto, instrumento o producto del hecho delictivo.</p>
					<ul>
					<p>Art√≠culo 231. Notificaci√≥n del aseguramiento y abandono</p>
					<p>El Ministerio P√∫blico deber√° notificar al interesado o a su representante legal el aseguramiento del objeto, instrumento o producto del delito, dentro de los sesenta d√≠as naturales siguientes a su ejecuci√≥n, entregando o poniendo a su disposici√≥n, seg√∫n sea el caso, una copia del registro de aseguramiento, para que manifieste lo que a su derecho convenga.</p>
					<p>En la notificaci√≥n se apercibir√° al interesado o a su representante legal para que se abstenga de ejercer actos de dominio sobre los bienes asegurados y se le apercibir√° que de no manifestar lo que a su derecho convenga, en un t√©rmino de noventa d√≠as naturales siguientes al de la notificaci√≥n, los bienes causar√°n abandono a favor del Gobierno Federal o de la Entidad federativa de que se trate, seg√∫n corresponda.</p>
					<ul>
					<p>Art√≠culo 232. Custodia y disposici√≥n de los bienes asegurados</p>
					<p>Cuando los bienes que se aseguren hayan sido previamente embargados, intervenidos, secuestrados o asegurados, se notificar√° el nuevo aseguramiento a las autoridades que hayan ordenado dichos actos. Los bienes continuar√°n en custodia de quien se haya designado para ese fin, y a disposici√≥n de la autoridad judicial o del Ministerio P√∫blico para los efectos del procedimiento penal.</p>
					<ul>
					<p>Art√≠culo 233. Registro de los bienes asegurados</p>
					<p>Se har√° constar en los registros p√∫blicos que correspondan, de conformidad con las disposiciones aplicables:</p>
					<p>I. El aseguramiento de bienes muebles o inmuebles, y</p>
					<p>II. La existencia de medidas cautelares que afecten la propiedad o posesi√≥n de bienes.</p>
					<p>Servicio de Informaci√≥n Legislativa</p>
					<ul>
					<p>Art√≠culo 234. Frutos de los bienes asegurados</p>
					<p>A los frutos o rendimientos de los bienes durante el tiempo del aseguramiento, se les dar√° el mismo tratamiento que a los bienes asegurados, debiendo ser conservados y administrados conforme a las disposiciones aplicables.</p>
					<ul>
					<p>Art√≠culo 235. Aseguramiento de bienes en delitos de querella</p>
					<p>En los delitos de querella, no se proceder√° sin que √©sta se haya formulado, salvo para realizar los actos urgentes de investigaci√≥n o los estrictamente necesarios para impedir o interrumpir la comisi√≥n del delito.</p>
					<ul>
					<p>Art√≠culo 236. Objetos de gran tama√±o</p>
					<p>Los objetos de gran tama√±o, como naves, aeronaves, veh√≠culos automotores, m√°quinas, gr√∫as y otros similares, despu√©s de ser examinados, fotografiados o videograbados, podr√°n ser devueltos, con o sin reservas, al propietario, poseedor o al tenedor leg√≠timo seg√∫n el caso, previa demostraci√≥n de la calidad invocada, siempre y cuando no hayan sido medios comisivos del delito ni se requieran para el desarrollo de la investigaci√≥n.</p>
					<ul>
					<p>Art√≠culo 237. Aseguramiento de objetos de gran tama√±o</p>
					<p>Los objetos mencionados en el art√≠culo precedente, despu√©s de que sean examinados, fotografiados o videograbados, podr√°n ser devueltos, con o sin reservas, al propietario, poseedor o al tenedor leg√≠timo seg√∫n el caso, previa demostraci√≥n de la calidad invocada, siempre y cuando no hayan sido medios comisivos del delito ni se requieran para el desarrollo de la investigaci√≥n.</p>
					<ul>
					<p>Art√≠culo 238. Aseguramiento de flora y fauna</p>
					<p>Las especies de flora y fauna de reserva ecol√≥gica que se aseguren, ser√°n provistas de los cuidados necesarios y, en su caso, se pondr√°n a disposici√≥n de las autoridades competentes para su resguardo y conservaci√≥n, conforme a las disposiciones aplicables.</p>
					<ul>
					<p>Art√≠culo 239. Requisitos para el aseguramiento de veh√≠culos</p>
					<p>Trat√°ndose de delitos culposos ocasionados con motivo del tr√°nsito de veh√≠culos, estos se entregar√°n a su propietario, poseedor o tenedor leg√≠timo, una vez que se hayan realizado las diligencias necesarias para la investigaci√≥n, salvo que existan razones fundadas para su retenci√≥n.</p>
					<ul>
					<p>Art√≠culo 240. Aseguramiento de veh√≠culos</p>
					<p>En caso de que se presente alguno de los supuestos anteriores, el Ministerio P√∫blico podr√° ordenar el aseguramiento y resguardo del veh√≠culo, tomando las medidas necesarias para su conservaci√≥n y evitando su deterioro.</p>
					<ul>
					<p>Art√≠culo 241. Aseguramiento de armas de fuego o explosivos</p>
					<p>Cuando se aseguren armas de fuego o explosivos, se har√° del conocimiento de la Secretar√≠a de la Defensa Nacional, para los efectos legales conducentes.</p>
					<p>Conceptos Jur√≠dicos</p>
					<ul>
					<p>Art√≠culo 242. Aseguramiento de sustancias t√≥xicas o peligrosas</p>
					<p>Las sustancias t√≥xicas o peligrosas que se aseguren ser√°n puestas a disposici√≥n de las autoridades competentes para su resguardo, an√°lisis o destrucci√≥n, conforme a las disposiciones aplicables.</p>
					<ul>
					<p>Art√≠culo 243. Aseguramiento de documentos</p>
					<p>Los documentos que se aseguren ser√°n conservados en su estado original y, en su caso, se realizar√°n copias certificadas para su incorporaci√≥n a la carpeta de investigaci√≥n, garantizando su autenticidad e integridad.</p>
					<ul>
					<p>Art√≠culo 244. Aseguramiento de informaci√≥n electr√≥nica</p>
					<p>La informaci√≥n electr√≥nica que se asegure ser√° resguardada en medios que garanticen su integridad y, en su caso, se realizar√°n copias de seguridad para su an√°lisis, conforme a las disposiciones aplicables.</p>
					<ul>
					<p>Art√≠culo 245. Aseguramiento de correspondencia</p>
					<p>La correspondencia que se asegure ser√° abierta y examinada √∫nicamente por orden judicial, garantizando la confidencialidad y los derechos de las personas involucradas.</p>
					<ul>
					<p>Art√≠culo 246. Aseguramiento de bienes culturales</p>
					<p>Los bienes culturales que se aseguren ser√°n puestos a disposici√≥n de las autoridades competentes para su resguardo y conservaci√≥n, conforme a las disposiciones aplicables.</p>
					<ul>
					<p>Art√≠culo 247. Aseguramiento de bienes en delitos fiscales</p>
					<p>En los delitos fiscales, el aseguramiento de bienes se realizar√° conforme a las disposiciones aplicables en la materia, garantizando los derechos de los contribuyentes.</p>
					<p>I. Prueba Testimonial (Art√≠culos 360 al 367)</p>
					<ul>
					<p>Art√≠culo 360. Deber de testificar</p>
					<p>Toda persona tiene la obligaci√≥n de concurrir al proceso cuando sea citada y de declarar la verdad de cuanto conozca y le sea preguntado. No deber√° ocultar hechos, circunstancias o cualquier otra informaci√≥n relevante para la soluci√≥n de la controversia, salvo disposici√≥n en contrario. El testigo no estar√° obligado a declarar sobre hechos por los que se le pueda fincar responsabilidad penal.</p>
					<ul>
					<p>Art√≠culo 361. Facultad de abstenci√≥n</p>
					<p>Podr√°n abstenerse de declarar el tutor, curador, pupilo, c√≥nyuge, concubina o concubinario, conviviente del imputado, la persona que tenga con √©l una relaci√≥n de parentesco por consanguinidad o afinidad hasta el cuarto grado, as√≠ como quienes est√©n ligados por v√≠nculos de confianza, afecto o inter√©s que, a juicio del √≥rgano jurisdiccional, justifiquen la abstenci√≥n.</p>
					<ul>
					<p>Art√≠culo 362. Inadmisibilidad de testimonios</p>
					<p>Es inadmisible el testimonio de quien haya sido coimputado en el mismo proceso, salvo que haya sido separado del mismo y su declaraci√≥n sea ofrecida por la defensa.</p>
					<ul>
					<p>Art√≠culo 363. Citaci√≥n de testigos</p>
					<p>Los testigos ser√°n citados para su examinaci√≥n. En casos de urgencia, podr√°n ser citados por cualquier medio que garantice la recepci√≥n de la citaci√≥n, de lo cual se deber√° dejar constancia. El testigo podr√° presentarse a declarar sin previa cita.</p>
					<ul>
					<p>Art√≠culo 364. Sanciones por incomparecencia</p>
					<p>Se impondr√° de seis meses a tres a√±os de prisi√≥n y de veinticinco a cien d√≠as multa al particular que, citado legalmente como testigo, no comparezca sin justa causa.</p>
					<ul>
					<p>Art√≠culo 365. Protecci√≥n de testigos</p>
					<p>El √≥rgano jurisdiccional podr√° ordenar medidas especiales destinadas a proteger la integridad f√≠sica y psicol√≥gica del testigo y sus familiares, cuando exista riesgo fundado.</p>
					<ul>
					<p>Art√≠culo 366. Testimonios especiales</p>
					<p>Cuando deba recibirse testimonio de menores de edad v√≠ctimas del delito y se tema por su afectaci√≥n psicol√≥gica o emocional, el √≥rgano jurisdiccional deber√° ordenar su recepci√≥n con el auxilio de familiares y peritos especializados de manera oficiosa.</p>
					<ul>
					<p>Art√≠culo 367. Protecci√≥n a los testigos</p>
					<p>El √≥rgano jurisdiccional, por un tiempo razonable, podr√° ordenar medidas especiales destinadas a proteger la integridad f√≠sica y psicol√≥gica del testigo y sus familiares, cuando exista riesgo fundado.</p>
					<p>II. Prueba Pericial (Art√≠culos 368 al 370)</p>
					<ul>
					<p>Art√≠culo 368. Prueba pericial</p>
					<p>Podr√° ofrecerse la prueba pericial cuando, para el examen de personas, hechos, objetos o circunstancias relevantes para el proceso, sea necesario o conveniente poseer conocimientos especiales en alguna ciencia, arte, t√©cnica u oficio.</p>
					<ul>
					<p>Art√≠culo 369. Requisitos de los peritos</p>
					<p>Los peritos deber√°n poseer t√≠tulo oficial en la materia relativa al punto sobre el cual dictaminar√°n y no tener impedimentos legales para ejercer su profesi√≥n.</p>
					<ul>
					<p>Art√≠culo 370. Medidas de protecci√≥n</p>
					<p>En caso necesario, los peritos y otros terceros que deban intervenir en el procedimiento para efectos probatorios, podr√°n ser objeto de medidas de protecci√≥n, cuando exista riesgo fundado para su integridad.</p>
					<p>III. Disposiciones Generales del Interrogatorio y Contrainterrogatorio (Art√≠culos 371 al 376)</p>
					<ul>
					<p>Art√≠culo 371. Declarantes en la audiencia de juicio</p>
					<p>Antes de declarar, los testigos no podr√°n comunicarse entre s√≠, ni ver, o√≠r o ser informados de lo que ocurra en la audiencia.</p>
					<ul>
					<p>Art√≠culo 372. Desarrollo del interrogatorio</p>
					<p>Otorgada la protesta y realizada su identificaci√≥n, el juzgador que presida la audiencia de juicio conceder√° la palabra a la parte que ofreci√≥ al testigo para que proceda a su interrogatorio.</p>
					<ul>
					<p>Art√≠culo 373. Reglas para formular preguntas en juicio</p>
					<p>Toda pregunta deber√° formularse de manera oral y versar√° sobre un hecho espec√≠fico. En ning√∫n caso se permitir√°n preguntas ambiguas, conclusivas, impertinentes, irrelevantes o argumentativas.</p>
					<ul>
					<p>Art√≠culo 374. Objeciones</p>
					<p>Las partes podr√°n formular objeciones a las preguntas que consideren improcedentes. El juez resolver√° de inmediato sobre su procedencia.</p>
					<ul>
					<p>Art√≠culo 375. Contrainterrogatorio</p>
					<p>La parte contraria podr√° interrogar al testigo sobre los mismos hechos objeto del interrogatorio principal y sobre otros relacionados con su credibilidad.</p>
					<ul>
					<p>Art√≠culo 376. Intervenci√≥n del juez</p>
					<p>El juez podr√° formular preguntas para aclarar aspectos oscuros o contradictorios de las declaraciones, sin asumir el papel de las partes.</p>
					<p>IV. Declaraci√≥n del Acusado (Art√≠culos 377 al 379)</p>
					<ul>
					<p>Art√≠culo 377. Derecho a declarar</p>
					<p>El acusado podr√° declarar en cualquier momento del proceso, sin que ello implique confesi√≥n ni perjuicio.</p>
					<ul>
					<p>Art√≠culo 378. Asistencia de defensa</p>
					<p>La declaraci√≥n del acusado se recibir√° en presencia de su defensor.</p>
					<ul>
					<p>Art√≠culo 379. Valor probatorio</p>
					<p>La declaraci√≥n del acusado se valorar√° en conjunto con las dem√°s pruebas del proceso.</p>
					<p>V. Prueba Documental y Material (Art√≠culos 380 al 387)</p>
					<ul>
					<p>Art√≠culo 380. Presentaci√≥n de documentos</p>
					<p>Los documentos deber√°n presentarse en su forma original o en copia certificada, salvo imposibilidad justificada.</p>
					<ul>
					<p>Art√≠culo 381. Incorporaci√≥n de documentos</p>
					<p>Los documentos se incorporar√°n al juicio mediante su lectura o exhibici√≥n, seg√∫n corresponda.</p>
					<ul>
					<p>Art√≠culo 382. Valor probatorio de documentos</p>
					<p>El valor probatorio de los documentos se determinar√° conforme a las reglas de la sana cr√≠tica.</p>
					<ul>
					<p>Art√≠culo 383. Objetos materiales</p>
					<p>Los objetos materiales relacionados con el delito podr√°n ser presentados como prueba, siempre que se garantice su autenticidad e integridad.</p>
					<ul>
					<p>Art√≠culo 384. Exhibici√≥n de objetos</p>
					<p>La exhibici√≥n de objetos materiales se realizar√° en audiencia, permitiendo su examen por las partes.</p>
					<ul>
					<p>Art√≠culo 385. Conservaci√≥n de objetos</p>
					<p>Los objetos materiales deber√°n conservarse en condiciones que eviten su alteraci√≥n o deterioro.</p>
					<ul>
					<p>Art√≠culo 386. Devoluci√≥n de objetos</p>
					<p>Los objetos podr√°n ser devueltos a quien acredite su leg√≠tima propiedad, salvo que deban conservarse para el proceso.</p>
					<ul>
					<p>Art√≠culo 387. Destrucci√≥n de objetos</p>
					<p>Cuando los objetos representen un peligro o no sea posible su conservaci√≥n, el juez podr√° ordenar su destrucci√≥n, previa documentaci√≥n adecuada.</p>
                </div>

                <div class="report-section">
                    <h3>üìã Elementos Obligatorios seg√∫n CNPP</h3>
                    <ul>
                        <li><strong>Denuncia o Querella:</strong> Acto inicial que da conocimiento de los hechos delictivos</li>
                        <li><strong>Entrevista de la V√≠ctima:</strong> Declaraci√≥n formal del sujeto pasivo del delito</li>
                        <li><strong>Inspecci√≥n del Lugar:</strong> Registro t√©cnico del sitio de los hechos</li>
                        <li><strong>Cadena de Custodia:</strong> Control y seguimiento de indicios y evidencias</li>
                        <li><strong>Informe de Investigaci√≥n:</strong> Resumen de diligencias realizadas</li>
                    </ul>
                </div>

                <div class="report-section">
                    <h3>üìä Criterios de Evaluaci√≥n</h3>
                    <p>La evaluaci√≥n se basa en los siguientes criterios:</p>
                    <ul>
                        <li><strong>75-100%:</strong> Carpeta apta para judicializaci√≥n</li>
                        <li><strong>50-74%:</strong> Requiere elementos complementarios</li>
                        <li><strong>0-49%:</strong> Deficiencias graves que impiden judicializaci√≥n</li>
                    </ul>
                </div>

                <div class="report-section">
                    <h3>‚öñÔ∏è Consecuencias Legales</h3>
                    <p>Una carpeta de investigaci√≥n mal integrada puede resultar en:</p>
                    <ul>
                        <li>Rechazo de la consignaci√≥n por parte del juez</li>
                        <li>Sobreseimiento del proceso penal</li>
                        <li>Absoluci√≥n del imputado por deficiencias probatorias</li>
                        <li>Responsabilidad administrativa para el Ministerio P√∫blico</li>
                    </ul>
                </div>
            `;
        }

        // Generar gr√°fico
        function generateChart() {
            const ctx = document.getElementById('cnppChart').getContext('2d');
            
            const labels = Object.values(requiredElements).map(el => el.name);
            const data = Object.entries(requiredElements).map(([key, el]) => {
                const result = analysisResults.elements[key];
                return result.found ? result.confidence : 0;
            });
            
            const colors = data.map(value => {
                if (value >= 80) return '#28a745';
                if (value >= 50) return '#ffc107';
                if (value > 0) return '#fd7e14';
                return '#dc3545';
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nivel de Cumplimiento (%)',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Cumplimiento: ' + context.parsed.y + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Obtener nivel de puntuaci√≥n
        function getScoreLevel(score) {
            if (score >= 75) return 'ALTO - Apto para judicializaci√≥n';
            if (score >= 50) return 'MEDIO - Requiere complementos';
            return 'BAJO - Deficiencias graves';
        }

        // Funciones de exportaci√≥n
        function exportToJSON() {
            const data = {
                metadata: {
                    generatedAt: new Date().toISOString(),
                    totalDocuments: analysisResults.totalDocuments,
                    totalWords: analysisResults.totalWords
                },
                score: analysisResults.score,
                elements: analysisResults.elements,
                analysis: analysisResults.analysis,
                recommendations: analysisResults.recommendations,
                documents: processedDocuments.map(doc => ({
                    name: doc.name,
                    type: doc.type,
                    wordCount: doc.wordCount,
                    status: doc.status
                }))
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            downloadFile(blob, 'analisis-carpeta-investigacion.json');
        }

        function exportToHTML() {
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <title>Informe de An√°lisis - Carpeta de Investigaci√≥n</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .score { font-size: 2em; font-weight: bold; color: ${analysisResults.score >= 75 ? '#28a745' : analysisResults.score >= 50 ? '#ffc107' : '#dc3545'}; }
                        .section { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; }
                        .element { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
                        .found { background-color: #d4edda; }
                        .missing { background-color: #f8d7da; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Informe de An√°lisis - Carpeta de Investigaci√≥n</h1>
                        <div class="score">${analysisResults.score}%</div>
                        <p>Generado el ${new Date().toLocaleDateString('es-MX')}</p>
                    </div>
                    
                    <div class="section">
                        <h2>Resumen Ejecutivo</h2>
                        <p>Documentos analizados: ${analysisResults.totalDocuments}</p>
                        <p>Total de palabras: ${analysisResults.totalWords.toLocaleString()}</p>
                        <p>Nivel de cumplimiento: ${getScoreLevel(analysisResults.score)}</p>
                    </div>
                    
                    <div class="section">
                        <h2>Elementos Analizados</h2>
                        ${Object.entries(requiredElements).map(([key, element]) => {
                            const result = analysisResults.elements[key];
                            return `
                                <div class="element ${result.found ? 'found' : 'missing'}">
                                    <h3>${result.found ? '‚úÖ' : '‚ùå'} ${element.name}</h3>
                                    <p>${element.description}</p>
                                    <p><strong>Estado:</strong> ${result.found ? `Encontrado (${result.confidence}%)` : 'No encontrado'}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="section">
                        <h2>Recomendaciones</h2>
                        <ul>
                            ${analysisResults.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            downloadFile(blob, 'informe-carpeta-investigacion.html');
        }

        async function exportToPDF() {
            try {
                const { PDFDocument, rgb, StandardFonts } = PDFLib;
                const pdfDoc = await PDFDocument.create();
                const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
                const helveticaBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
                
                const page = pdfDoc.addPage([612, 792]); // Tama√±o carta
                const { width, height } = page.getSize();
                
                let yPosition = height - 50;
                
                // T√≠tulo
                page.drawText('INFORME DE AN√ÅLISIS', {
                    x: 50,
                    y: yPosition,
                    size: 20,
                    font: helveticaBold,
                    color: rgb(0, 0, 0)
                });
                
                yPosition -= 30;
                page.drawText('Carpeta de Investigaci√≥n - CNPP Art. 131', {
                    x: 50,
                    y: yPosition,
                    size: 14,
                    font: helveticaFont,
                    color: rgb(0.5, 0.5, 0.5)
                });
                
                yPosition -= 40;
                
                // Puntuaci√≥n
                page.drawText(`PUNTUACI√ìN: ${analysisResults.score}%`, {
                    x: 50,
                    y: yPosition,
                    size: 16,
                    font: helveticaBold,
                    color: rgb(0, 0.5, 1)
                });
                
                yPosition -= 30;
                page.drawText(`Nivel: ${getScoreLevel(analysisResults.score)}`, {
                    x: 50,
                    y: yPosition,
                    size: 12,
                    font: helveticaFont
                });
                
                yPosition -= 40;
                
                // Resumen
                page.drawText('RESUMEN EJECUTIVO', {
                    x: 50,
                    y: yPosition,
                    size: 14,
                    font: helveticaBold
                });
                
                yPosition -= 20;
                const summaryLines = [
                    `Documentos analizados: ${analysisResults.totalDocuments}`,
                    `Total de palabras: ${analysisResults.totalWords.toLocaleString()}`,
                    `Elementos encontrados: ${analysisResults.foundElements.length}/10`,
                    `Elementos faltantes cr√≠ticos: ${analysisResults.missingElements.length}`
                ];
                
                summaryLines.forEach(line => {
                    page.drawText(line, {
                        x: 50,
                        y: yPosition,
                        size: 10,
                        font: helveticaFont
                    });
                    yPosition -= 15;
                });
                
                // Generar PDF
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                downloadFile(blob, 'informe-carpeta-investigacion.pdf');
                
            } catch (error) {
                console.error('Error generando PDF:', error);
                alert('Error al generar PDF: ' + error.message);
            }
        }

        function exportExecutiveSummaryToPDF() {
            // Versi√≥n simplificada del PDF solo con resumen ejecutivo
            exportToPDF();
        }

        function printExecutiveSummary() {
            const printContent = `
                <div style="text-align: center; font-family: Arial, sans-serif;">
                    <h1>Resumen Ejecutivo</h1>
                    <h2>Carpeta de Investigaci√≥n</h2>
                    <div style="font-size: 3em; color: ${analysisResults.score >= 75 ? '#28a745' : analysisResults.score >= 50 ? '#ffc107' : '#dc3545'}; margin: 20px 0;">
                        ${analysisResults.score}%
                    </div>
                    <h3>${getScoreLevel(analysisResults.score)}</h3>
                    <p>Generado el ${new Date().toLocaleDateString('es-MX')}</p>
                    
                    <div style="text-align: left; margin: 30px 0;">
                        <h3>Resumen:</h3>
                        <p>Documentos analizados: ${analysisResults.totalDocuments}</p>
                        <p>Total de palabras: ${analysisResults.totalWords.toLocaleString()}</p>
                        <p>Elementos encontrados: ${analysisResults.foundElements.length}/10</p>
                        
                        <h3>Recomendaciones:</h3>
                        <ul>
                            ${analysisResults.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // Funci√≥n auxiliar para descargar archivos
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Agregar CDN de PDF.js si no est√° disponible
        if (typeof pdfjsLib === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
            document.head.appendChild(script);
        }
    </script>
</body>
</html>
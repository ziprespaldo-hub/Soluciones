<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor Carpeta de Investigaci√≥n -131 CNPP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 3px dashed #dee2e6;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .upload-section.dragover {
            border-color: #28a745;
            background: #d4edda;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            display: inline-block;
            text-decoration: none;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,123,255,0.3);
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            flex-grow: 1;
        }

        .file-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .file-size {
            color: #6c757d;
            font-size: 0.9em;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .analyze-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40,167,69,0.3);
        }

        .analyze-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #007bff, #28a745);
            transition: width 0.3s ease;
            width: 0%;
        }

        .results-section {
            display: none;
            margin-top: 40px;
        }

        .analysis-summary {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .score-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            font-weight: bold;
            color: white;
            position: relative;
        }

        .score-low { background: linear-gradient(135deg, #dc3545, #c82333); }
        .score-medium { background: linear-gradient(135deg, #ffc107, #e0a800); }
        .score-high { background: linear-gradient(135deg, #28a745, #20c997); }

        .elements-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .element-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #dee2e6;
        }

        .element-card.present {
            border-left-color: #28a745;
        }

        .element-card.missing {
            border-left-color: #dc3545;
        }

        .element-card.partial {
            border-left-color: #ffc107;
        }

        .element-title {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .status-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .present .status-icon { color: #28a745; }
        .missing .status-icon { color: #dc3545; }
        .partial .status-icon { color: #ffc107; }

        .element-description {
            color: #6c757d;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .detailed-report {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
        }

        .report-section {
            margin-bottom: 30px;
        }

        .report-section h3 {
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .export-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            text-align: center;
        }

        .export-btn {
            background: linear-gradient(45deg, #6f42c1, #563d7c);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            margin: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(111,66,193,0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .severity-high { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        .severity-medium { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        .severity-low { background-color: #d4edda; border-left: 4px solid #28a745; }
        
        .risk-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }

        .risk-critical { background: #dc3545; color: white; }
        .risk-high { background: #fd7e14; color: white; }
        .risk-medium { background: #ffc107; color: black; }
        .risk-low { background: #28a745; color: white; }

        .evidence-strength {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .strength-bar {
            flex: 1;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 0 10px;
            overflow: hidden;
        }

        .strength-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .recommendation-card {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }

        .deficiency-analysis {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .quality-indicator {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            margin: 5px;
        }

        .quality-excellent { background: #d4edda; color: #155724; }
        .quality-good { background: #d1ecf1; color: #0c5460; }
        .quality-regular { background: #fff3cd; color: #856404; }
        .quality-poor { background: #f8d7da; color: #721c24; }

        @media print {
            body { background: white; }
            .container { box-shadow: none; }
            .upload-section, .export-controls, .tabs { display: none; }
            .main-content { padding: 20px; }
            .tab-content { display: block !important; }
            .page-break { page-break-before: always; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Analizador Avanzado de Carpetas de Investigaci√≥n</h1>
            <p>Sistema de Evaluaci√≥n Integral seg√∫n CNPP - Art√≠culo 131</p>
        </div>

        <div class="main-content">
            <!-- Secci√≥n de Carga de Archivos -->
            <div class="upload-section" id="uploadSection">
                <h2>üìÅ Cargar Documentos de la Carpeta de Investigaci√≥n</h2>
                <p>Soporta archivos PDF, DOC, DOCX y TXT</p>
                <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.doc,.docx,.txt">
                <label for="fileInput" class="upload-btn">
                    üìé Seleccionar Archivos
                </label>
                <div class="file-list" id="fileList"></div>
            </div>

            <button class="analyze-btn" id="analyzeBtn" onclick="startAnalysis()" disabled>
                üîç Analizar Carpeta de Investigaci√≥n
            </button>

            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Secci√≥n de Resultados -->
            <div class="results-section" id="resultsSection">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('summary')">Resumen Ejecutivo</button>
                    <button class="tab" onclick="showTab('checklist')">Lista de Verificaci√≥n</button>
                    <button class="tab" onclick="showTab('detailed')">An√°lisis Detallado</button>
                    <button class="tab" onclick="showTab('legal')">Marco Legal y Riesgos</button>
                </div>

                <!-- Resumen Ejecutivo -->
                <div class="tab-content active" id="summary">
                    <div class="analysis-summary">
                        <div class="score-display">
                            <div class="score-circle" id="scoreCircle">
                                <span id="scoreText">0%</span>
                            </div>
                            <h3 id="scoreTitle">Evaluando...</h3>
                            <p id="scoreDescription">Analizando documentos...</p>
                        </div>
                        
                        <div class="statistics-grid" id="statsGrid"></div>
                        
                        <div class="report-section">
                            <h3>üìä An√°lisis Ejecutivo</h3>
                            <div id="executiveAnalysis"></div>
                        </div>

                        <div class="report-section">
                            <h3>üéØ Recomendaciones Prioritarias</h3>
                            <div id="priorityRecommendations"></div>
                        </div>
                        
                        <div class="report-section">
                            <h3>üìà Distribuci√≥n de Elementos CNPP</h3>
                            <canvas id="cnppChart" style="max-width: 100%; height: 300px;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Lista de Verificaci√≥n -->
                <div class="tab-content" id="checklist">
                    <h2>‚úÖ Verificaci√≥n Detallada de Elementos</h2>
                    <div id="checklistSummary"></div>
                    <div class="elements-checklist" id="elementsChecklist"></div>
                </div>

                <!-- An√°lisis Detallado -->
                <div class="tab-content" id="detailed">
                    <div class="detailed-report" id="detailedReport"></div>
                </div>

                <!-- Marco Legal y Riesgos -->
                <div class="tab-content" id="legal">
                    <div class="detailed-report" id="legalFramework"></div>
                </div>

                <!-- Controles de Exportaci√≥n -->
                <div class="export-controls">
                    <h3>üìÑ Exportar Informe</h3>
                    <button class="export-btn" onclick="exportToHTML()">üìã Exportar HTML</button>
                    <button class="export-btn" onclick="exportToPDF()">üìë Generar PDF Completo</button>
                    <button class="export-btn" onclick="printReport()">üñ®Ô∏è Imprimir</button>
                    <button class="export-btn" onclick="exportToJSON()">üíæ Exportar Datos</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let uploadedFiles = [];
        let analysisResults = {};
        let processedDocuments = [];

        // Elementos CNPP requeridos (versi√≥n mejorada con m√°s detalles)
        const requiredElements = {
            'denuncia_querella': {
                name: 'Denuncia o Querella',
                description: 'Acto procesal inicial que da conocimiento al Ministerio P√∫blico de la probable comisi√≥n de un delito',
                keywords: ['denuncia', 'querella', 'hechos', 'delito', 'narraci√≥n', 'probable', 'conocimiento', 'ministerio p√∫blico', 'ratificaci√≥n'],
                advancedKeywords: ['fecha de los hechos', 'lugar de los hechos', 'circunstancias', 'modo', 'tiempo', 'identidad del probable responsable'],
                weight: 15,
                required: true,
                category: 'Inicio',
                riskLevel: 'CR√çTICO',
                qualityIndicators: ['fecha clara', 'lugar espec√≠fico', 'narraci√≥n coherente', 'identificaci√≥n de testigos']
            },
            'entrevista_victima': {
                name: 'Entrevista de la V√≠ctima',
                description: 'Declaraci√≥n formal del sujeto pasivo del delito bajo los principios de inmediatez y concentraci√≥n',
                keywords: ['v√≠ctima', 'ofendido', 'entrevista', 'declaraci√≥n', 'testimonio', 'sujeto pasivo', 'relato', 'afectaci√≥n'],
                advancedKeywords: ['da√±o causado', 'impacto del delito', 'solicitud de reparaci√≥n', 'identificaci√≥n del agresor', 'testigos presenciales'],
                weight: 12,
                required: true,
                category: 'Testimonial',
                riskLevel: 'CR√çTICO',
                qualityIndicators: ['relato detallado', 'coherencia temporal', 'identificaci√≥n precisa', 'cuantificaci√≥n del da√±o']
            },
            'entrevista_testigos': {
                name: 'Entrevistas de Testigos',
                description: 'Declaraciones de personas que presenciaron los hechos o tienen conocimiento relevante',
                keywords: ['testigo', 'presencial', 'observ√≥', 'vio', 'escuch√≥', 'conocimiento', 'informaci√≥n', 'circunstancias'],
                advancedKeywords: ['testigo presencial', 'testigo de referencia', 'credibilidad', 'corroboraci√≥n', 'contradicciones'],
                weight: 10,
                required: false,
                category: 'Testimonial',
                riskLevel: 'ALTO',
                qualityIndicators: ['n√∫mero suficiente', 'testimonios consistentes', 'identificaci√≥n completa', 'disponibilidad procesal']
            },
            'inspeccion_lugar': {
                name: 'Inspecci√≥n del Lugar de los Hechos',
                description: 'Examen t√©cnico y metodol√≥gico del sitio donde ocurrieron los hechos delictivos',
                keywords: ['inspecci√≥n', 'lugar', 'sitio', 'escena', 'criminal√≠stica', 'preservaci√≥n', 'fijaci√≥n', 'evidencia f√≠sica'],
                advancedKeywords: ['cadena de custodia', 'planimetr√≠a', 'fotograf√≠a forense', 'descripci√≥n detallada', 'condiciones ambientales'],
                weight: 12,
                required: true,
                category: 'T√©cnica',
                riskLevel: 'CR√çTICO',
                qualityIndicators: ['preservaci√≥n adecuada', 'documentaci√≥n fotogr√°fica', 'planimetr√≠a', 'descripci√≥n t√©cnica']
            },
            'cadena_custodia': {
                name: 'Cadena de Custodia',
                description: 'Sistema de control que garantiza la autenticidad de evidencias desde su recolecci√≥n hasta su presentaci√≥n',
                keywords: ['cadena', 'custodia', 'evidencia', 'indicio', 'objeto', 'recolecci√≥n', 'preservaci√≥n', 'integridad'],
                advancedKeywords: ['embalaje', 'etiquetado', 'transporte', 'almacenamiento', 'entrega recepci√≥n', 'autenticidad'],
                weight: 10,
                required: true,
                category: 'T√©cnica',
                riskLevel: 'CR√çTICO',
                qualityIndicators: ['documentaci√≥n completa', 'firmas de responsables', 'fechas y horas', 'condiciones de preservaci√≥n']
            },
            'dictamen_pericial': {
                name: 'Dict√°menes Periciales',
                description: 'An√°lisis t√©cnico-cient√≠fico especializado de evidencias por parte de peritos certificados',
                keywords: ['perito', 'dictamen', 'an√°lisis', 'laboratorio', 't√©cnico', 'cient√≠fico', 'especializado', 'metodolog√≠a'],
                advancedKeywords: ['acreditaci√≥n del perito', 'metodolog√≠a aplicada', 'conclusiones', 'grado de certeza', 'limitaciones t√©cnicas'],
                weight: 8,
                required: false,
                category: 'T√©cnica',
                riskLevel: 'MEDIO',
                qualityIndicators: ['perito certificado', 'metodolog√≠a validada', 'conclusiones claras', 'sustento cient√≠fico']
            },
            'informe_investigacion': {
                name: 'Informe de Investigaci√≥n',
                description: 'Documento que resume y sistematiza todas las diligencias y actuaciones realizadas',
                keywords: ['informe', 'investigaci√≥n', 'actividades', 'diligencias', 'actuaciones', 'resumen', 'sistematizaci√≥n'],
                advancedKeywords: ['l√≠neas de investigaci√≥n', 'hip√≥tesis del caso', 'an√°lisis de evidencias', 'conclusiones preliminares'],
                weight: 8,
                required: true,
                category: 'Administrativa',
                riskLevel: 'ALTO',
                qualityIndicators: ['cronolog√≠a clara', 'an√°lisis integral', 'conclusiones l√≥gicas', 'propuestas de acci√≥n']
            },
            'entrevista_imputado': {
                name: 'Entrevista del Imputado',
                description: 'Declaraci√≥n del probable responsable respetando sus derechos constitucionales',
                keywords: ['imputado', 'probable responsable', 'declaraci√≥n', 'derechos', 'defensor', 'versi√≥n de los hechos'],
                advancedKeywords: ['lectura de derechos', 'presencia de defensor', 'renuncia a declarar', 'confesi√≥n', 'coartada'],
                weight: 7,
                required: false,
                category: 'Testimonial',
                riskLevel: 'ALTO',
                qualityIndicators: ['derechos respetados', 'presencia de defensor', 'registro √≠ntegro', 'voluntariedad']
            },
            'acuerdo_reparatorio': {
                name: 'Acuerdo Reparatorio',
                description: 'Mecanismo alternativo de soluci√≥n de controversias entre v√≠ctima e imputado',
                keywords: ['acuerdo', 'reparatorio', 'convenio', 'reparaci√≥n', 'v√≠ctima', 'imputado', 'soluci√≥n alternativa'],
                advancedKeywords: ['reparaci√≥n integral', 'cumplimiento voluntario', 'supervisi√≥n judicial', 'extinci√≥n de la acci√≥n penal'],
                weight: 5,
                required: false,
                category: 'Alternativa',
                riskLevel: 'BAJO',
                qualityIndicators: ['voluntariedad', 'reparaci√≥n adecuada', 'supervisi√≥n', 'cumplimiento verificable']
            },
            'solicitud_medidas': {
                name: 'Solicitud de Medidas Cautelares',
                description: 'Petici√≥n fundamentada de restricciones al imputado para asegurar el proceso',
                keywords: ['medidas cautelares', 'restricci√≥n', 'garant√≠a procesal', 'riesgo procesal', 'peligro para la v√≠ctima'],
                advancedKeywords: ['prisi√≥n preventiva', 'supervisi√≥n judicial', 'prohibici√≥n de acercamiento', 'garant√≠a econ√≥mica'],
                weight: 6,
                required: false,
                category: 'Procesal',
                riskLevel: 'MEDIO',
                qualityIndicators: ['fundamentaci√≥n jur√≠dica', 'proporcionalidad', 'necesidad procesal', 'alternativas consideradas']
            }
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
            setupDragAndDrop();
        });

        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', handleFileSelect);
        }

        function setupDragAndDrop() {
            const uploadSection = document.getElementById('uploadSection');
            
            uploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFiles(files);
            });
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            handleFiles(files);
        }

        function handleFiles(files) {
            const validTypes = ['.pdf', '.doc', '.docx', '.txt'];
            
            files.forEach(file => {
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                if (validTypes.includes(fileExtension)) {
                    uploadedFiles.push({
                        file,
                        name: file.name,
                        size: file.size,
                        type: fileExtension,
                        id: Date.now() + Math.random()
                    });
                } else {
                    alert(`Archivo ${file.name} no es compatible. Solo se aceptan PDF, DOC, DOCX y TXT.`);
                }
            });

            updateFileList();
            updateAnalyzeButton();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = '';
                return;
            }

            fileList.innerHTML = uploadedFiles.map(fileObj => `
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-name">üìÑ ${fileObj.name}</div>
                        <div class="file-size">${formatFileSize(fileObj.size)} - ${fileObj.type.toUpperCase()}</div>
                    </div>
                    <button class="remove-btn" onclick="removeFile('${fileObj.id}')">‚ùå</button>
                </div>
            `).join('');
        }

        function removeFile(fileId) {
            uploadedFiles = uploadedFiles.filter(f => f.id != fileId);
            updateFileList();
            updateAnalyzeButton();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateAnalyzeButton() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = uploadedFiles.length === 0;
            analyzeBtn.textContent = uploadedFiles.length === 0 ? 'Selecciona archivos para analizar' : `Analizar ${uploadedFiles.length} archivo(s)`;
        }

        async function analyzeDocuments() {
            if (uploadedFiles.length === 0) return;

            const loadingDiv = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            
            loadingDiv.style.display = 'block';
            resultsDiv.style.display = 'none';

            try {
                analysisResults = {};
                processedDocuments = [];

                for (const fileObj of uploadedFiles) {
                    const content = await readFileContent(fileObj.file);
                    const analysis = await analyzeDocument(content, fileObj.name);
                    
                    analysisResults[fileObj.id] = analysis;
                    processedDocuments.push({
                        id: fileObj.id,
                        name: fileObj.name,
                        analysis: analysis
                    });
                }

                generateDetailedReports();
                
            } catch (error) {
                console.error('Error en el an√°lisis:', error);
                alert('Error al analizar los documentos. Por favor, intenta nuevamente.');
            } finally {
                loadingDiv.style.display = 'none';
                resultsDiv.style.display = 'block';
            }
        }

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
            });
        }

        async function analyzeDocument(content, fileName) {
            const normalizedContent = content.toLowerCase();
            const analysis = {
                fileName: fileName,
                elementsFound: [],
                elementsNotFound: [],
                qualityScore: 0,
                riskAssessment: [],
                recommendations: [],
                legalGaps: [],
                proceduralErrors: [],
                technicalDeficiencies: []
            };

            let totalWeight = 0;
            let achievedWeight = 0;

            // Analizar cada elemento requerido
            for (const [key, element] of Object.entries(requiredElements)) {
                const elementAnalysis = analyzeElement(normalizedContent, element, fileName);
                
                if (elementAnalysis.found) {
                    analysis.elementsFound.push(elementAnalysis);
                    achievedWeight += element.weight;
                } else {
                    analysis.elementsNotFound.push(elementAnalysis);
                }
                
                totalWeight += element.weight;
            }

            analysis.qualityScore = Math.round((achievedWeight / totalWeight) * 100);
            analysis.riskAssessment = generateRiskAssessment(analysis);
            analysis.recommendations = generateRecommendations(analysis);
            analysis.legalGaps = identifyLegalGaps(analysis);
            analysis.proceduralErrors = identifyProceduralErrors(analysis);
            analysis.technicalDeficiencies = identifyTechnicalDeficiencies(analysis);

            return analysis;
        }

        function analyzeElement(content, element, fileName) {
            const keywordMatches = element.keywords.filter(keyword => 
                content.includes(keyword.toLowerCase())
            ).length;

            const advancedMatches = element.advancedKeywords.filter(keyword => 
                content.includes(keyword.toLowerCase())
            ).length;

            const found = keywordMatches >= 2 || advancedMatches >= 1;
            const confidence = Math.min(100, ((keywordMatches * 20) + (advancedMatches * 30)));

            return {
                element: element.name,
                found: found,
                confidence: confidence,
                keywordMatches: keywordMatches,
                advancedMatches: advancedMatches,
                category: element.category,
                riskLevel: element.riskLevel,
                weight: element.weight,
                required: element.required,
                qualityIndicators: evaluateQualityIndicators(content, element),
                specificFindings: extractSpecificFindings(content, element),
                deficiencies: identifyDeficiencies(content, element)
            };
        }

        function evaluateQualityIndicators(content, element) {
            const indicators = [];
            
            element.qualityIndicators.forEach(indicator => {
                const present = content.includes(indicator.toLowerCase());
                indicators.push({
                    indicator: indicator,
                    present: present,
                    impact: present ? 'Positivo' : 'Negativo'
                });
            });

            return indicators;
        }

        function extractSpecificFindings(content, element) {
            const findings = [];
            
            // Extraer hallazgos espec√≠ficos basados en el tipo de elemento
            switch (element.name) {
                case 'Denuncia o Querella':
                    if (content.includes('fecha')) findings.push('Fecha de hechos identificada');
                    if (content.includes('lugar')) findings.push('Lugar de hechos especificado');
                    if (content.includes('testigo')) findings.push('Testigos mencionados');
                    break;
                    
                case 'Entrevista de la V√≠ctima':
                    if (content.includes('da√±o')) findings.push('Da√±os cuantificados');
                    if (content.includes('reparaci√≥n')) findings.push('Solicitud de reparaci√≥n presente');
                    break;
                    
                case 'Inspecci√≥n del Lugar de los Hechos':
                    if (content.includes('fotograf√≠a')) findings.push('Documentaci√≥n fotogr√°fica');
                    if (content.includes('planimetr√≠a')) findings.push('Planimetr√≠a incluida');
                    break;
            }

            return findings;
        }

        function identifyDeficiencies(content, element) {
            const deficiencies = [];
            
            // Identificar deficiencias espec√≠ficas
            if (element.required && !content.includes(element.keywords[0].toLowerCase())) {
                deficiencies.push(`Ausencia de ${element.name} (elemento cr√≠tico)`);
            }

            element.qualityIndicators.forEach(indicator => {
                if (!content.includes(indicator.toLowerCase())) {
                    deficiencies.push(`Falta: ${indicator}`);
                }
            });

            return deficiencies;
        }

        function generateRiskAssessment(analysis) {
            const risks = [];
            
            // Evaluar riesgos basados en elementos faltantes
            analysis.elementsNotFound.forEach(element => {
                if (element.riskLevel === 'CR√çTICO') {
                    risks.push({
                        level: 'CR√çTICO',
                        description: `Ausencia de ${element.element} puede invalidar la investigaci√≥n`,
                        impact: 'Archivo del caso o sobreseimiento probable',
                        recommendation: 'Acci√≥n inmediata requerida'
                    });
                } else if (element.riskLevel === 'ALTO') {
                    risks.push({
                        level: 'ALTO',
                        description: `Falta de ${element.element} debilita significativamente el caso`,
                        impact: 'Reducci√≥n considerable de probabilidad de √©xito',
                        recommendation: 'Complementar investigaci√≥n prioritariamente'
                    });
                }
            });

            // Evaluar calidad general
            if (analysis.qualityScore < 50) {
                risks.push({
                    level: 'CR√çTICO',
                    description: 'Calidad general de la investigaci√≥n insuficiente',
                    impact: 'Alto riesgo de impunidad',
                    recommendation: 'Revisi√≥n integral del expediente'
                });
            }

            return risks;
        }

        function generateRecommendations(analysis) {
            const recommendations = [];
            
            // Recomendaciones por elementos faltantes
            analysis.elementsNotFound.forEach(element => {
                if (element.required) {
                    recommendations.push({
                        priority: 'ALTA',
                        action: `Realizar ${element.element}`,
                        justification: `Elemento obligatorio seg√∫n el CNPP`,
                        timeline: 'Inmediato',
                        responsible: 'Ministerio P√∫blico'
                    });
                }
            });

            // Recomendaciones por calidad
            if (analysis.qualityScore < 70) {
                recommendations.push({
                    priority: 'ALTA',
                    action: 'Fortalecer la investigaci√≥n con diligencias adicionales',
                    justification: 'Calidad insuficiente para sostener acusaci√≥n',
                    timeline: '30 d√≠as',
                    responsible: 'Agente del MP'
                });
            }

            // Recomendaciones espec√≠ficas por tipo de caso
            if (analysis.elementsFound.some(e => e.element.includes('V√≠ctima'))) {
                recommendations.push({
                    priority: 'MEDIA',
                    action: 'Implementar medidas de protecci√≥n para la v√≠ctima',
                    justification: 'Garantizar integridad del proceso',
                    timeline: '15 d√≠as',
                    responsible: 'Unidad de V√≠ctimas'
                });
            }

            return recommendations;
        }

        function identifyLegalGaps(analysis) {
            const gaps = [];
            
            // Identificar vac√≠os legales comunes
            if (!analysis.elementsFound.some(e => e.element.includes('Denuncia'))) {
                gaps.push({
                    area: 'Inicio del Proceso',
                    description: 'Falta de denuncia formal debidamente integrada',
                    article: 'Art√≠culo 221 CNPP',
                    consequence: 'Vicio procesal que puede invalidar actuaciones posteriores'
                });
            }

            if (!analysis.elementsFound.some(e => e.element.includes('Cadena'))) {
                gaps.push({
                    area: 'Prueba Material',
                    description: 'Cadena de custodia inexistente o deficiente',
                    article: 'Art√≠culo 227 CNPP',
                    consequence: 'Exclusi√≥n de evidencia f√≠sica del juicio'
                });
            }

            return gaps;
        }

        function identifyProceduralErrors(analysis) {
            const errors = [];
            
            // Identificar errores procedimentales
            analysis.elementsFound.forEach(element => {
                if (element.confidence < 50) {
                    errors.push({
                        type: 'Deficiencia Documental',
                        description: `${element.element} presenta inconsistencias`,
                        severity: 'Media',
                        correction: 'Complementar informaci√≥n faltante'
                    });
                }
            });

            return errors;
        }

        function identifyTechnicalDeficiencies(analysis) {
            const deficiencies = [];
            
            // Identificar deficiencias t√©cnicas
            if (!analysis.elementsFound.some(e => e.element.includes('Inspecci√≥n'))) {
                deficiencies.push({
                    area: 'Criminal√≠stica',
                    description: 'Falta de inspecci√≥n t√©cnica del lugar de los hechos',
                    impact: 'P√©rdida de evidencia f√≠sica crucial',
                    solution: 'Realizar inspecci√≥n complementaria si es posible'
                });
            }

            if (!analysis.elementsFound.some(e => e.element.includes('Pericial'))) {
                deficiencies.push({
                    area: 'Evidencia Cient√≠fica',
                    description: 'Ausencia de dict√°menes periciales especializados',
                    impact: 'Debilitamiento de la teor√≠a del caso',
                    solution: 'Solicitar peritajes necesarios seg√∫n el tipo de delito'
                });
            }

            return deficiencies;
        }

        function generateDetailedReports() {
            generateExecutiveSummary();
            generateChecklistReport();
            generateDetailedReport();
            generateLegalFrameworkReport();
        }

        function generateExecutiveSummary() {
            const summaryDiv = document.getElementById('executiveSummary');
            
            const totalDocs = processedDocuments.length;
            const avgQuality = Math.round(
                processedDocuments.reduce((sum, doc) => sum + doc.analysis.qualityScore, 0) / totalDocs
            );
            
            const criticalRisks = processedDocuments.reduce((sum, doc) => 
                sum + doc.analysis.riskAssessment.filter(r => r.level === 'CR√çTICO').length, 0
            );
            
            const highPriorityActions = processedDocuments.reduce((sum, doc) => 
                sum + doc.analysis.recommendations.filter(r => r.priority === 'ALTA').length, 0
            );

            summaryDiv.innerHTML = `
                <div class="executive-summary">
                    <h2>üìä Resumen Ejecutivo de la Investigaci√≥n</h2>
                    
                    <div class="summary-metrics">
                        <div class="metric-card ${avgQuality >= 70 ? 'success' : avgQuality >= 50 ? 'warning' : 'danger'}">
                            <h3>Calidad General</h3>
                            <div class="metric-value">${avgQuality}%</div>
                            <div class="metric-label">Promedio de Calidad</div>
                        </div>
                        
                        <div class="metric-card ${criticalRisks === 0 ? 'success' : 'danger'}">
                            <h3>Riesgos Cr√≠ticos</h3>
                            <div class="metric-value">${criticalRisks}</div>
                            <div class="metric-label">Requieren Atenci√≥n Inmediata</div>
                        </div>
                        
                        <div class="metric-card ${highPriorityActions === 0 ? 'success' : 'warning'}">
                            <h3>Acciones Prioritarias</h3>
                            <div class="metric-value">${highPriorityActions}</div>
                            <div class="metric-label">Recomendaciones de Alta Prioridad</div>
                        </div>
                    </div>

                    <div class="summary-analysis">
                        <h3>üéØ Evaluaci√≥n Integral del Expediente</h3>
                        <div class="analysis-content">
                            ${generateOverallAssessment(avgQuality, criticalRisks)}
                        </div>
                        
                        <h3>‚öñÔ∏è Perspectiva Legal</h3>
                        <div class="legal-perspective">
                            ${generateLegalPerspective()}
                        </div>
                        
                        <h3>üìà Recomendaciones Estrat√©gicas</h3>
                        <div class="strategic-recommendations">
                            ${generateStrategicRecommendations(avgQuality, criticalRisks)}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateOverallAssessment(avgQuality, criticalRisks) {
            if (avgQuality >= 80 && criticalRisks === 0) {
                return `
                    <div class="assessment excellent">
                        <strong>Excelente:</strong> La investigaci√≥n cumple con los est√°ndares del CNPP. 
                        El expediente presenta solidez probatoria y t√©cnica suficiente para proceder con confianza 
                        hacia la etapa de juicio oral. Se observa un trabajo metodol√≥gico y profesional.
                    </div>
                `;
            } else if (avgQuality >= 60 && criticalRisks <= 2) {
                return `
                    <div class="assessment good">
                        <strong>Satisfactorio:</strong> La investigaci√≥n presenta bases s√≥lidas aunque requiere 
                        complementar algunos elementos. Con las mejoras sugeridas, el caso tendr√≠a alta probabilidad 
                        de √©xito en juicio oral.
                    </div>
                `;
            } else if (avgQuality >= 40) {
                return `
                    <div class="assessment warning">
                        <strong>Deficiente:</strong> La investigaci√≥n presenta serias deficiencias que comprometen 
                        su viabilidad. Se requiere una revisi√≥n integral y la implementaci√≥n inmediata de las 
                        recomendaciones para evitar la impunidad.
                    </div>
                `;
            } else {
                return `
                    <div class="assessment critical">
                        <strong>Cr√≠tico:</strong> El estado actual de la investigaci√≥n es insuficiente para 
                        sostener una acusaci√≥n. Existe alto riesgo de archivo o sobreseimiento. Se requiere 
                        acci√≥n correctiva inmediata y posible reasignaci√≥n del caso.
                    </div>
                `;
            }
        }

        function generateLegalPerspective() {
            const legalGaps = processedDocuments.reduce((acc, doc) => 
                acc.concat(doc.analysis.legalGaps), []
            );

            if (legalGaps.length === 0) {
                return `
                    <div class="legal-status positive">
                        ‚úÖ No se identificaron vac√≠os legales significativos. El expediente cumple con los 
                        requisitos procesales establecidos en el CNPP.
                    </div>
                `;
            } else {
                return `
                    <div class="legal-status negative">
                        ‚ö†Ô∏è Se identificaron ${legalGaps.length} vac√≠o(s) legal(es) que requieren atenci√≥n:
                        <ul>
                            ${legalGaps.slice(0, 3).map(gap => `
                                <li><strong>${gap.area}:</strong> ${gap.description}</li>
                            `).join('')}
                        </ul>
                        ${legalGaps.length > 3 ? `<em>... y ${legalGaps.length - 3} m√°s (ver informe detallado)</em>` : ''}
                    </div>
                `;
            }
        }

        function generateStrategicRecommendations(avgQuality, criticalRisks) {
            const recommendations = [];

            if (criticalRisks > 0) {
                recommendations.push('üö® Prioridad M√°xima: Atender riesgos cr√≠ticos identificados');
            }

            if (avgQuality < 50) {
                recommendations.push('üìã Revisi√≥n Integral: Complementar investigaci√≥n con diligencias faltantes');
            }

            recommendations.push('‚è±Ô∏è Seguimiento: Establecer cronograma de cumplimiento de recomendaciones');
            recommendations.push('üë• Coordinaci√≥n: Involucrar especialistas seg√∫n tipo de delito');

            return `
                <ul class="strategic-list">
                    ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            `;
        }

        function generateChecklistReport() {
            const checklistDiv = document.getElementById('checklistReport');
            
            const allElements = Object.values(requiredElements);
            const foundElements = new Set();
            
            processedDocuments.forEach(doc => {
                doc.analysis.elementsFound.forEach(el => {
                    foundElements.add(el.element);
                });
            });

            checklistDiv.innerHTML = `
                <div class="checklist-report">
                    <h2>üìã Lista de Verificaci√≥n Detallada</h2>
                    
                    <div class="checklist-summary">
                        <div class="completion-bar">
                            <div class="bar-fill" style="width: ${(foundElements.size / allElements.length) * 100}%"></div>
                        </div>
                        <div class="completion-text">
                            ${foundElements.size} de ${allElements.length} elementos completados 
                            (${Math.round((foundElements.size / allElements.length) * 100)}%)
                        </div>
                    </div>

                    <div class="checklist-categories">
                        ${generateChecklistByCategory(allElements, foundElements)}
                    </div>
                </div>
            `;
        }

        function generateChecklistByCategory(allElements, foundElements) {
            const categories = ['Inicio', 'Testimonial', 'T√©cnica', 'Administrativa', 'Procesal', 'Alternativa'];
            
            return categories.map(category => {
                const categoryElements = allElements.filter(el => el.category === category);
                const completed = categoryElements.filter(el => foundElements.has(el.name)).length;
                
                return `
                    <div class="category-section">
                        <h3>üìÅ ${category}</h3>
                        <div class="category-progress">
                            <span class="progress-text">${completed}/${categoryElements.length} elementos</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${(completed / categoryElements.length) * 100}%"></div>
                            </div>
                        </div>
                        
                        <div class="elements-list">
                            ${categoryElements.map(element => `
                                <div class="element-item ${foundElements.has(element.name) ? 'completed' : 'missing'} ${element.required ? 'required' : 'optional'}">
                                    <div class="element-status">
                                        ${foundElements.has(element.name) ? '‚úÖ' : '‚ùå'}
                                    </div>
                                    <div class="element-details">
                                        <div class="element-name">
                                            ${element.name}
                                            ${element.required ? '<span class="required-badge">OBLIGATORIO</span>' : '<span class="optional-badge">OPCIONAL</span>'}
                                        </div>
                                        <div class="element-description">${element.description}</div>
                                        <div class="element-impact">
                                            Impacto: <span class="risk-${element.riskLevel.toLowerCase()}">${element.riskLevel}</span>
                                            | Peso: ${element.weight}pts
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateDetailedReport() {
            const detailedDiv = document.getElementById('detailedReport');
            
            detailedDiv.innerHTML = `
                <div class="detailed-report">
                    <h2>üìÑ Informe T√©cnico Detallado</h2>
                    
                    ${processedDocuments.map(doc => `
                        <div class="document-analysis">
                            <h3>üìÅ ${doc.name}</h3>
                            
                            <div class="document-metrics">
                                <div class="metric">
                                    <label>Calidad General:</label>
                                    <div class="score-badge score-${getScoreClass(doc.analysis.qualityScore)}">
                                        ${doc.analysis.qualityScore}%
                                    </div>
                                </div>
                                <div class="metric">
                                    <label>Elementos Encontrados:</label>
                                    <span class="count">${doc.analysis.elementsFound.length}</span>
                                </div>
                                <div class="metric">
                                    <label>Elementos Faltantes:</label>
                                    <span class="count">${doc.analysis.elementsNotFound.length}</span>
                                </div>
                                <div class="metric">
                                    <label>Riesgos Cr√≠ticos:</label>
                                    <span class="count critical">${doc.analysis.riskAssessment.filter(r => r.level === 'CR√çTICO').length}</span>
                                </div>
                            </div>

                            <div class="analysis-sections">
                                <div class="section">
                                    <h4>‚úÖ Elementos Identificados</h4>
                                    <div class="elements-grid">
                                        ${doc.analysis.elementsFound.map(element => `
                                            <div class="element-card found">
                                                <div class="element-header">
                                                    <span class="element-title">${element.element}</span>
                                                    <span class="confidence-badge">${element.confidence}% confianza</span>
                                                </div>
                                                <div class="element-body">
                                                    <div class="findings">
                                                        <strong>Hallazgos espec√≠ficos:</strong>
                                                        <ul>
                                                            ${element.specificFindings.map(finding => `<li>${finding}</li>`).join('')}
                                                        </ul>
                                                    </div>
                                                    <div class="quality-indicators">
                                                        <strong>Indicadores de calidad:</strong>
                                                        ${element.qualityIndicators.map(indicator => `
                                                            <span class="indicator ${indicator.present ? 'present' : 'absent'}">
                                                                ${indicator.indicator} ${indicator.present ? '‚úì' : '‚úó'}
                                                            </span>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="section">
                                    <h4>‚ùå Elementos Faltantes</h4>
                                    <div class="elements-grid">
                                        ${doc.analysis.elementsNotFound.map(element => `
                                            <div class="element-card missing">
                                                <div class="element-header">
                                                    <span class="element-title">${element.element}</span>
                                                    <span class="risk-badge risk-${element.riskLevel.toLowerCase()}">${element.riskLevel}</span>
                                                </div>
                                                <div class="element-body">
                                                    <div class="deficiencies">
                                                        <strong>Deficiencias identificadas:</strong>
                                                        <ul>
                                                            ${element.deficiencies.map(def => `<li>${def}</li>`).join('')}
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="section">
                                    <h4>‚ö†Ô∏è Evaluaci√≥n de Riesgos</h4>
                                    <div class="risks-container">
                                        ${doc.analysis.riskAssessment.map(risk => `
                                            <div class="risk-card risk-${risk.level.toLowerCase()}">
                                                <div class="risk-header">
                                                    <span class="risk-level">${risk.level}</span>
                                                    <span class="risk-title">${risk.description}</span>
                                                </div>
                                                <div class="risk-details">
                                                    <div class="risk-impact"><strong>Impacto:</strong> ${risk.impact}</div>
                                                    <div class="risk-recommendation"><strong>Recomendaci√≥n:</strong> ${risk.recommendation}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="section">
                                    <h4>üìù Recomendaciones Espec√≠ficas</h4>
                                    <div class="recommendations-list">
                                        ${doc.analysis.recommendations.map(rec => `
                                            <div class="recommendation-item priority-${rec.priority.toLowerCase()}">
                                                <div class="rec-header">
                                                    <span class="rec-priority">${rec.priority}</span>
                                                    <span class="rec-action">${rec.action}</span>
                                                </div>
                                                <div class="rec-details">
                                                    <div class="rec-justification">${rec.justification}</div>
                                                    <div class="rec-timeline">
                                                        <strong>Plazo:</strong> ${rec.timeline} | 
                                                        <strong>Responsable:</strong> ${rec.responsible}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function generateLegalFrameworkReport() {
            const legalDiv = document.getElementById('legalFramework');
            
            const allLegalGaps = processedDocuments.reduce((acc, doc) => 
                acc.concat(doc.analysis.legalGaps), []
            );
            
            const allProceduralErrors = processedDocuments.reduce((acc, doc) => 
                acc.concat(doc.analysis.proceduralErrors), []
            );

            legalDiv.innerHTML = `
                <div class="legal-framework-report">
                    <h2>‚öñÔ∏è Marco Legal y Cumplimiento Normativo</h2>
                    
                    <div class="legal-overview">
                        <h3>üìä Resumen de Cumplimiento</h3>
                        <div class="compliance-summary">
                            <div class="compliance-item">
                                <span class="compliance-label">Vac√≠os Legales Identificados:</span>
                                <span class="compliance-value ${allLegalGaps.length === 0 ? 'good' : 'warning'}">${allLegalGaps.length}</span>
                            </div>
                            <div class="compliance-item">
                                <span class="compliance-label">Errores Procedimentales:</span>
                                <span class="compliance-value ${allProceduralErrors.length === 0 ? 'good' : 'warning'}">${allProceduralErrors.length}</span>
                            </div>
                        </div>
                    </div>

                    <div class="legal-sections">
                        <div class="legal-section">
                            <h3>üìú Fundamento Legal Aplicable</h3>
                            <div class="legal-framework">
                                <div class="framework-item">
                                    <h4>C√≥digo Nacional de Procedimientos Penales</h4>
                                    <ul>
                                        <li><strong>Art. 211:</strong> Inicio de la investigaci√≥n</li>
                                        <li><strong>Art. 221:</strong> Denuncia y querella</li>
                                        <li><strong>Art. 227:</strong> Cadena de custodia</li>
                                        <li><strong>Art. 242:</strong> Registro de actuaciones</li>
                                        <li><strong>Art. 303:</strong> Actos de investigaci√≥n</li>
                                        <li><strong>Art. 384:</strong> Medios de prueba</li>
                                        <li><strong>Art. 395:</strong> Prueba testimonial</li>
                                    </ul>
                                </div>
                                <div class="framework-item">
                                    <h4>Constituci√≥n Pol√≠tica de los Estados Unidos Mexicanos</h4>
                                    <ul>
                                        <li><strong>Art. 16:</strong> Garant√≠as en materia penal</li>
                                        <li><strong>Art. 19:</strong> Prisi√≥n preventiva</li>
                                        <li><strong>Art. 20:</strong> Derechos en el proceso penal</li>
                                    </ul>
                                </div>
                                <div class="framework-item">
                                    <h4>Tratados Internacionales</h4>
                                    <ul>
                                        <li><strong>CADH Art. 8:</strong> Garant√≠as judiciales</li>
                                        <li><strong>PIDCP Art. 14:</strong> Debido proceso</li>
                                        <li><strong>Convenci√≥n Bel√©m do Par√°:</strong> Violencia contra la mujer</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        ${allLegalGaps.length > 0 ? `
                        <div class="legal-section">
                            <h3>‚ö†Ô∏è Vac√≠os Legales Identificados</h3>
                            <div class="legal-gaps">
                                ${allLegalGaps.map(gap => `
                                    <div class="gap-item">
                                        <div class="gap-header">
                                            <span class="gap-area">${gap.area}</span>
                                            <span class="gap-article">${gap.article}</span>
                                        </div>
                                        <div class="gap-description">${gap.description}</div>
                                        <div class="gap-consequence">
                                            <strong>Consecuencia:</strong> ${gap.consequence}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${allProceduralErrors.length > 0 ? `
                        <div class="legal-section">
                            <h3>üîç Errores Procedimentales</h3>
                            <div class="procedural-errors">
                                ${allProceduralErrors.map(error => `
                                    <div class="error-item severity-${error.severity.toLowerCase()}">
                                        <div class="error-type">${error.type}</div>
                                        <div class="error-description">${error.description}</div>
                                        <div class="error-correction">
                                            <strong>Correcci√≥n sugerida:</strong> ${error.correction}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <div class="legal-section">
                            <h3>üìã Recomendaciones de Cumplimiento</h3>
                            <div class="compliance-recommendations">
                                ${generateComplianceRecommendations(allLegalGaps, allProceduralErrors)}
                            </div>
                        </div>

                        <div class="legal-section">
                            <h3>üìö Jurisprudencia Relevante</h3>
                            <div class="jurisprudence">
                                <div class="jurisprudence-item">
                                    <h4>Tesis: 1a./J. 15/2016 (10a.)</h4>
                                    <p><strong>Rubro:</strong> CADENA DE CUSTODIA. Su finalidad.</p>
                                    <p><strong>Criterio:</strong> La cadena de custodia tiene como finalidad proteger la integridad de los indicios para que no sean alterados, sustituidos, contaminados o destruidos.</p>
                                </div>
                                <div class="jurisprudence-item">
                                    <h4>Tesis: 1a. CCXV/2016 (10a.)</h4>
                                    <p><strong>Rubro:</strong> PRUEBA TESTIMONIAL. Valoraci√≥n en el sistema acusatorio.</p>
                                    <p><strong>Criterio:</strong> La valoraci√≥n de la prueba testimonial debe realizarse considerando la inmediaci√≥n, contradicci√≥n y concentraci√≥n.</p>
                                </div>
                                <div class="jurisprudence-item">
                                    <h4>Tesis: 1a. CCLXIV/2016 (10a.)</h4>
                                    <p><strong>Rubro:</strong> MINISTERIO P√öBLICO. Obligaciones en la investigaci√≥n.</p>
                                    <p><strong>Criterio:</strong> El MP debe realizar una investigaci√≥n objetiva, eficaz y exhaustiva de los hechos denunciados.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateComplianceRecommendations(legalGaps, proceduralErrors) {
            const recommendations = [];

            if (legalGaps.length === 0 && proceduralErrors.length === 0) {
                return `
                    <div class="compliance-success">
                        ‚úÖ Excelente cumplimiento normativo. No se identificaron vac√≠os legales significativos 
                        ni errores procedimentales. La investigaci√≥n se ajusta a los est√°ndares del CNPP.
                    </div>
                `;
            }

            if (legalGaps.length > 0) {
                recommendations.push(`
                    <div class="recommendation-item high-priority">
                        <h4>üö® Atenci√≥n Inmediata a Vac√≠os Legales</h4>
                        <p>Se identificaron ${legalGaps.length} vac√≠os legales que requieren correcci√≥n inmediata para evitar nulidades procesales.</p>
                        <ul>
                            <li>Revisar cada vac√≠o identificado contra el marco normativo aplicable</li>
                            <li>Implementar medidas correctivas dentro de los plazos procesales</li>
                            <li>Documentar todas las acciones de subsanaci√≥n realizadas</li>
                        </ul>
                    </div>
                `);
            }

            if (proceduralErrors.length > 0) {
                recommendations.push(`
                    <div class="recommendation-item medium-priority">
                        <h4>üìù Correcci√≥n de Errores Procedimentales</h4>
                        <p>Se detectaron ${proceduralErrors.length} errores procedimentales que pueden afectar la validez de las actuaciones.</p>
                        <ul>
                            <li>Implementar las correcciones sugeridas para cada error identificado</li>
                            <li>Reforzar la capacitaci√≥n del personal en procedimientos del CNPP</li>
                            <li>Establecer protocolos de revisi√≥n previa a la judicializaci√≥n</li>
                        </ul>
                    </div>
                `);
            }

            recommendations.push(`
                <div class="recommendation-item low-priority">
                    <h4>üìö Fortalecimiento Institucional</h4>
                    <p>Medidas preventivas para mejorar la calidad de futuras investigaciones:</p>
                    <ul>
                        <li>Implementar listas de verificaci√≥n basadas en el CNPP</li>
                        <li>Capacitaci√≥n continua en sistema penal acusatorio</li>
                        <li>Supervisi√≥n t√©cnica especializada de expedientes</li>
                        <li>Actualizaci√≥n peri√≥dica en jurisprudencia relevante</li>
                    </ul>
                </div>
            `);

            return recommendations.join('');
        }

        function getScoreClass(score) {
            if (score >= 80) return 'excellent';
            if (score >= 60) return 'good';
            if (score >= 40) return 'warning';
            return 'critical';
        }

        function showTab(tabName) {
            const tabs = ['executiveSummary', 'checklistReport', 'detailedReport', 'legalFramework'];
            const tabButtons = document.querySelectorAll('.tab-button');
            
            tabs.forEach(tab => {
                const element = document.getElementById(tab);
                if (element) {
                    element.style.display = tab === tabName ? 'block' : 'none';
                }
            });

            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
        }

        function printReport() {
            const printWindow = window.open('', '_blank');
            const activeTab = document.querySelector('.tab-content > div[style*="block"]');
            
            if (!activeTab) {
                alert('No hay contenido para imprimir');
                return;
            }

            const reportTitle = getReportTitle(activeTab.id);
            const currentDate = new Date().toLocaleDateString('es-MX', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${reportTitle}</title>
                    <style>
                        body { 
                            font-family: 'Times New Roman', serif; 
                            margin: 2cm; 
                            color: #333;
                            line-height: 1.6;
                        }
                        .print-header {
                            text-align: center;
                            border-bottom: 2px solid #2c3e50;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        .print-header h1 {
                            color: #2c3e50;
                            margin-bottom: 10px;
                            font-size: 24px;
                        }
                        .print-header .subtitle {
                            color: #7f8c8d;
                            font-size: 14px;
                        }
                        .document-info {
                            background: #f8f9fa;
                            padding: 15px;
                            border-left: 4px solid #3498db;
                            margin-bottom: 25px;
                        }
                        .metric-card {
                            display: inline-block;
                            margin: 10px;
                            padding: 15px;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                            min-width: 120px;
                            text-align: center;
                        }
                        .success { border-color: #27ae60; background: #d4edda; }
                        .warning { border-color: #f39c12; background: #fff3cd; }
                        .danger { border-color: #e74c3c; background: #f8d7da; }
                        .section { margin-bottom: 25px; page-break-inside: avoid; }
                        .section h3 { 
                            color: #2c3e50; 
                            border-bottom: 1px solid #bdc3c7; 
                            padding-bottom: 5px;
                        }
                        .element-item {
                            margin: 10px 0;
                            padding: 10px;
                            border-radius: 5px;
                        }
                        .completed { background: #d4edda; border-left: 4px solid #27ae60; }
                        .missing { background: #f8d7da; border-left: 4px solid #e74c3c; }
                        .risk-cr√≠tico { color: #e74c3c; font-weight: bold; }
                        .risk-alto { color: #f39c12; font-weight: bold; }
                        .risk-medio { color: #f39c12; }
                        .print-footer {
                            position: fixed;
                            bottom: 1cm;
                            left: 0;
                            right: 0;
                            text-align: center;
                            font-size: 12px;
                            color: #7f8c8d;
                            border-top: 1px solid #bdc3c7;
                            padding-top: 10px;
                        }
                        @media print {
                            .no-print { display: none; }
                            .page-break { page-break-before: always; }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>${reportTitle}</h1>
                        <div class="subtitle">An√°lisis de Carpeta de Investigaci√≥n - Sistema CNPP</div>
                        <div class="subtitle">Generado el ${currentDate}</div>
                    </div>

                    <div class="document-info">
                        <strong>Documentos Analizados:</strong> ${processedDocuments.length}<br>
                        <strong>Fecha de An√°lisis:</strong> ${currentDate}<br>
                        <strong>Sistema:</strong> Analizador de Carpetas de Investigaci√≥n CNPP v2.0
                    </div>

                    ${activeTab.innerHTML}

                    <div class="print-footer">
                        <p>Documento generado autom√°ticamente por el Sistema de An√°lisis CNPP</p>
                        <p>P√°gina {p√°gina} - ${currentDate}</p>
                    </div>
                </body>
                </html>
            `);

            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        function getReportTitle(tabId) {
            const titles = {
                'executiveSummary': 'Resumen Ejecutivo de la Investigaci√≥n',
                'checklistReport': 'Lista de Verificaci√≥n Detallada - CNPP',
                'detailedReport': 'Informe T√©cnico Detallado de An√°lisis',
                'legalFramework': 'Marco Legal y Cumplimiento Normativo'
            };
            return titles[tabId] || 'Reporte de An√°lisis CNPP';
        }

        function exportToWord() {
            const activeTab = document.querySelector('.tab-content > div[style*="block"]');
            if (!activeTab) {
                alert('No hay contenido para exportar');
                return;
            }

            const reportTitle = getReportTitle(activeTab.id);
            const currentDate = new Date().toLocaleDateString('es-MX');
            
            // Crear contenido HTML limpio para Word
            const cleanContent = activeTab.innerHTML
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                .replace(/onclick="[^"]*"/gi, '')
                .replace(/class="[^"]*"/gi, '');

            const wordContent = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
                <head>
                    <meta charset='utf-8'>
                    <title>${reportTitle}</title>
                    <style>
                        body { font-family: 'Calibri', sans-serif; margin: 2cm; }
                        h1, h2, h3 { color: #2c3e50; }
                        .metric-card { border: 1px solid #ddd; padding: 10px; margin: 5px; }
                        .success { background: #d4edda; }
                        .warning { background: #fff3cd; }
                        .danger { background: #f8d7da; }
                    </style>
                </head>
                <body>
                    <h1>${reportTitle}</h1>
                    <p><strong>Fecha:</strong> ${currentDate}</p>
                    <p><strong>Documentos Analizados:</strong> ${processedDocuments.length}</p>
                    <hr>
                    ${cleanContent}
                </body>
                </html>
            `;

            const blob = new Blob([wordContent], { 
                type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' 
            });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${reportTitle.replace(/\s+/g, '_')}_${currentDate}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Funci√≥n auxiliar para generar estad√≠sticas adicionales
        function generateAdvancedStatistics() {
            const stats = {
                totalDocuments: processedDocuments.length,
                averageQuality: 0,
                criticalRisks: 0,
                highRisks: 0,
                mediumRisks: 0,
                completedElements: 0,
                missingElements: 0,
                recommendationsCount: 0
            };

            processedDocuments.forEach(doc => {
                stats.averageQuality += doc.analysis.qualityScore;
                stats.completedElements += doc.analysis.elementsFound.length;
                stats.missingElements += doc.analysis.elementsNotFound.length;
                stats.recommendationsCount += doc.analysis.recommendations.length;
                
                doc.analysis.riskAssessment.forEach(risk => {
                    switch(risk.level) {
                        case 'CR√çTICO': stats.criticalRisks++; break;
                        case 'ALTO': stats.highRisks++; break;
                        case 'MEDIO': stats.mediumRisks++; break;
                    }
                });
            });

            stats.averageQuality = Math.round(stats.averageQuality / stats.totalDocuments);
            return stats;
        }

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // La inicializaci√≥n ya est√° definida arriba
            showTab('executiveSummary'); // Mostrar primera pesta√±a por defecto
        });
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis de Carpeta de Investigaci√≥n - Sistema Jur√≠dico</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            font-size: 2.5rem;
            color: #1e3c72;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e3c72;
        }

        .subtitle {
            font-size: 0.9rem;
            color: #666;
        }

        .status-indicator {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        nav {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn, .export-btn, .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .nav-btn:hover, .export-btn:hover, .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
        }

        .content-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px;
            min-height: 600px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #4CAF50;
        }

        .upload-area.dragover {
            background: rgba(76, 175, 80, 0.1);
            border-color: #4CAF50;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #666;
            margin-bottom: 5px;
        }

        .file-input {
            display: none;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            background: #4CAF50;
            color: white;
        }

        .analysis-panel {
            background: #f9f9f9;
            border-radius: 12px;
            margin: 20px 0;
        }

        .panel-header {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            padding: 20px;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .result-title {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .result-score {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            background: #2196F3;
            color: white;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">‚öñ</div>
                    <div>
                        <div class="logo-text">An√°lisis Carpeta de Investigaci√≥n</div>
                        <div class="subtitle">Sistema de Evaluaci√≥n Jur√≠dica CNPP - CPEUM</div>
                    </div>
                </div>
                <div class="status-indicator">Sistema Activo</div>
            </div>
        </header>

        <nav>
            <div class="nav-buttons">
                <button class="export-btn" onclick="exportResultsAsPDF()">üìÑ Descargar PDF</button>
                <button class="nav-btn active" data-section="upload">üìÅ Cargar Documentos</button>
                <button class="nav-btn" data-section="analysis">‚öñÔ∏è An√°lisis Jur√≠dico</button>
                <button class="nav-btn" data-section="results">üìä Resultados</button>
                <button class="nav-btn" data-section="reports">üìÑ Reportes</button>
                <button class="nav-btn" data-section="help">‚ùì Ayuda</button>
            </div>
        </nav>

        <div class="main-content">
            <div class="sidebar">
                <h3>üìÇ Estructura de Carpeta</h3>
                <div class="document-tree" id="documentTree">
                    <div class="tree-item">üìã Carpeta de Investigaci√≥n</div>
                    <div class="tree-item">‚îî‚îÄ‚îÄ üìÅ Documentos Cargados (<span id="docCount">0</span>)</div>
                </div>

                <div class="summary-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalDocs">0</div>
                        <div class="stat-label">Documentos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="analyzedDocs">0</div>
                        <div class="stat-label">Analizados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgScore">0%</div>
                        <div class="stat-label">Score Promedio</div>
                    </div>
                </div>
            </div>

            <div class="content-area">
                <!-- Upload Section -->
                <div class="section active" id="upload">
                    <h2>üìÅ Carga de Documentos</h2>
                    <p>Sube los documentos que conforman la carpeta de investigaci√≥n para su an√°lisis jur√≠dico conforme al CNPP y CPEUM.</p>

                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Arrastra documentos aqu√≠</div>
                        <div class="upload-subtext">O haz clic para seleccionar archivos</div>
                        <div class="upload-subtext">Formatos: PDF, DOCX, TXT, CSV, JSON, XLSX</div>
                        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                            Seleccionar Archivos
                        </button>
                    </div>

                    <input type="file" id="fileInput" class="file-input" multiple 
                           accept=".pdf,.docx,.txt,.csv,.json,.xlsx">

                    <div class="file-list" id="fileList"></div>
                </div>

                <!-- Analysis Section -->
                <div class="section" id="analysis">
                    <h2>‚öñÔ∏è An√°lisis Jur√≠dico en Progreso</h2>
                    
                    <div class="analysis-panel">
                        <div class="panel-header">
                            <span>Evaluaci√≥n de Documentos</span>
                            <span id="analysisStatus">Listo para analizar</span>
                        </div>
                        <div class="panel-content">
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <div class="progress-text" id="progressText">0% completado</div>
                            </div>
                            
                            <div id="analysisLog">
                                <p>Selecciona documentos y presiona "Iniciar An√°lisis" para comenzar la evaluaci√≥n jur√≠dica.</p>
                            </div>
                        </div>
                    </div>

                    <button class="upload-btn" id="startAnalysis">
                        üîç Iniciar An√°lisis Jur√≠dico
                    </button>
                </div>

                <!-- Results Section -->
                <div class="section" id="results">
                    <h2>üìä Resultados del An√°lisis</h2>
                    <div class="results-grid" id="resultsGrid"></div>
                </div>

                <!-- Reports Section -->
                <div class="section" id="reports">
                    <h2>üìÑ Generaci√≥n de Reportes</h2>
                    
                    <div class="export-panel">
                        <h3>üìã Resumen Ejecutivo</h3>
                        <p>Generar dictamen procesal estructurado con an√°lisis completo de la carpeta de investigaci√≥n.</p>
                        
                        <div class="export-options" style="margin-top: 15px;">
                            <button class="export-btn" onclick="exportSpecialReport('pdf')">üìÑ Exportar PDF</button>
                            <button class="export-btn" onclick="exportSpecialReport('json')">üìã Exportar JSON</button>
                        </div>
                    </div>
                </div>

                <!-- Help Section -->
                <div class="section" id="help">
                    <h2>‚ùì Ayuda y Documentaci√≥n</h2>
                    
                    <div class="panel-content">
                        <h3>üîç Tipos de Documentos Analizados</h3>
                        <ul style="margin: 15px 0; padding-left: 30px;">
                            <li><strong>Denuncia/Querella:</strong> Inicio formal de la investigaci√≥n</li>
                            <li><strong>Inspecci√≥n:</strong> Levantamiento de evidencia f√≠sica</li>
                            <li><strong>Entrevistas:</strong> Declaraciones de v√≠ctimas, testigos, imputados</li>
                            <li><strong>Dict√°menes Periciales:</strong> An√°lisis t√©cnicos especializados</li>
                            <li><strong>Oficios:</strong> Comunicaciones oficiales</li>
                            <li><strong>Cadena de Custodia:</strong> Control de evidencias</li>
                        </ul>

                        <h3>‚öñÔ∏è Marco Legal Aplicado</h3>
                        <ul style="margin: 15px 0; padding-left: 30px;">
                            <li><strong>CPEUM:</strong> Arts. 14, 16, 20, 21</li>
                            <li><strong>CNPP:</strong> Arts. 131, 211-220, 259-265, 266-303, 313, 335-336, 359</li>
                            <li><strong>C√≥digo Penal:</strong> Tipificaci√≥n de delitos</li>
                            <li><strong>Leyes Complementarias:</strong> Normativa espec√≠fica aplicable</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
// ===============================
// Sistema de An√°lisis Jur√≠dico Integral
// ===============================

class CarpetaAnalyzer {
    constructor() {
        this.documents = [];
        this.analysisResults = [];
        this.legalFramework = this.initLegalFramework();
        this.documentTypes = this.initDocumentTypes();
        this.isAnalyzing = false;
    }

    init() {
        console.log('Inicializando CarpetaAnalyzer...');
        this.initPDFWorker();
        this.setupEventListeners();
        this.setupNavigation();
        this.setupDragDrop();
        console.log('CarpetaAnalyzer inicializado correctamente');
    }

    initPDFWorker() {
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            console.log('PDF.js worker configurado');
        }
    }

    setupEventListeners() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files));
        }

        const startBtn = document.getElementById('startAnalysis');
        if (startBtn) {
            startBtn.addEventListener('click', () => this.startAnalysis());
        }
    }

    setupNavigation() {
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remover clase active de todas las secciones y botones
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                
                // Activar la secci√≥n seleccionada
                const section = document.getElementById(btn.dataset.section);
                if (section) {
                    section.classList.add('active');
                    btn.classList.add('active');
                }
            });
        });
    }

    setupDragDrop() {
        const uploadArea = document.getElementById('uploadArea');
        if (uploadArea) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                this.handleFileSelect(e.dataTransfer.files);
            });

            uploadArea.addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
        }
    }

    async handleFileSelect(files) {
        console.log(`Procesando ${files.length} archivos...`);
        
        for (const file of files) {
            if (this.isValidFileType(file)) {
                try {
                    const content = await this.extractText(file);
                    const doc = {
                        id: this.generateId(),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        content,
                        analyzed: false,
                        uploadDate: new Date()
                    };
                    
                    this.documents.push(doc);
                    this.addFileToList(doc);
                    console.log(`Archivo ${file.name} procesado correctamente`);
                } catch (error) {
                    console.error(`Error procesando ${file.name}:`, error);
                    alert(`Error al procesar ${file.name}: ${error.message}`);
                }
            } else {
                alert(`Tipo de archivo no soportado: ${file.name}`);
            }
        }
        
        this.updateStats();
    }

    addFileToList(doc) {
        const fileList = document.getElementById('fileList');
        if (!fileList) return;

        const fileDiv = document.createElement('div');
        fileDiv.className = 'file-item';
        fileDiv.innerHTML = `
            <div class="file-info">
                <span>üìÑ</span>
                <div>
                    <div><strong>${doc.name}</strong></div>
                    <div style="font-size: 0.8rem; color: #666;">
                        ${this.formatFileSize(doc.size)} - ${doc.uploadDate.toLocaleString()}
                    </div>
                </div>
            </div>
            <div class="file-status">${doc.analyzed ? 'Analizado' : 'Pendiente'}</div>
        `;
        
        fileList.appendChild(fileDiv);
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    async startAnalysis() {
        if (this.isAnalyzing) {
            alert('An√°lisis en progreso...');
            return;
        }

        if (this.documents.length === 0) {
            alert('No hay documentos para analizar. Por favor, carga algunos archivos primero.');
            return;
        }

        this.isAnalyzing = true;
        this.analysisResults = [];
        
        const statusEl = document.getElementById('analysisStatus');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const analysisLog = document.getElementById('analysisLog');
        
        if (statusEl) statusEl.textContent = 'Analizando...';
        if (analysisLog) analysisLog.innerHTML = '<p>Iniciando an√°lisis jur√≠dico...</p>';

        try {
            for (let i = 0; i < this.documents.length; i++) {
                const doc = this.documents[i];
                const progress = ((i + 1) / this.documents.length) * 100;
                
                if (progressFill) progressFill.style.width = `${progress}%`;
                if (progressText) progressText.textContent = `${Math.round(progress)}% completado`;
                if (analysisLog) {
                    analysisLog.innerHTML += `<p>Analizando: ${doc.name}...</p>`;
                    analysisLog.scrollTop = analysisLog.scrollHeight;
                }

                const analysis = await this.analyzeDocument(doc);
                this.analysisResults.push(analysis);
                doc.analyzed = true;

                // Simular tiempo de an√°lisis
                await this.sleep(500);
            }

            if (statusEl) statusEl.textContent = 'An√°lisis completado';
            if (analysisLog) analysisLog.innerHTML += '<p><strong>‚úÖ An√°lisis completado exitosamente</strong></p>';
            
            this.displayResults();
            this.updateStats();
            
            // Cambiar autom√°ticamente a la secci√≥n de resultados
            document.querySelector('[data-section="results"]').click();
            
        } catch (error) {
            console.error('Error durante el an√°lisis:', error);
            if (statusEl) statusEl.textContent = 'Error en an√°lisis';
            if (analysisLog) analysisLog.innerHTML += `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
        } finally {
            this.isAnalyzing = false;
        }
    }

    async analyzeDocument(doc) {
        const type = this.classifyDocument(doc.content);
        const foundArticles = this.getApplicableArticles(doc.content, type);
        const score = this.calculateScore(doc, foundArticles);

        return {
            documentId: doc.id,
            documentName: doc.name,
            documentType: type,
            articles: foundArticles,
            score: score,
            resumen: this.generateSummary(doc, type, foundArticles, score),
            recommendations: this.generateRecommendations(type, foundArticles)
        };
    }

    classifyDocument(content) {
        let bestType = 'desconocido';
        let maxMatches = 0;
        const lowerContent = content.toLowerCase();

        for (const [key, definition] of Object.entries(this.documentTypes)) {
            const matches = definition.keywords.filter(keyword => 
                lowerContent.includes(keyword.toLowerCase())
            ).length;
            
            if (matches > maxMatches) {
                maxMatches = matches;
                bestType = key;
            }
        }

        return bestType;
    }

    getApplicableArticles(content, docType) {
        const foundArticles = [];
        const lowerContent = content.toLowerCase();

        for (const [codigo, articulos] of Object.entries(this.legalFramework)) {
            for (const [articulo, definition] of Object.entries(articulos)) {
                const matches = definition.applies.some(keyword => 
                    lowerContent.includes(keyword.toLowerCase()) || 
                    docType.includes(keyword.toLowerCase())
                );
                
                if (matches) {
                    foundArticles.push({
                        codigo: codigo,
                        articulo: articulo,
                        contenido: definition.content,
                        relevancia: this.calculateRelevance(lowerContent, definition.applies)
                    });
                }
            }
        }

        return foundArticles.sort((a, b) => b.relevancia - a.relevancia);
    }

    calculateRelevance(content, keywords) {
        return keywords.reduce((count, keyword) => {
            const regex = new RegExp(keyword.toLowerCase(), 'g');
            const matches = content.match(regex);
            return count + (matches ? matches.length : 0);
        }, 0);
    }

    calculateScore(doc, articles) {
        const baseScore = Math.min(articles.length * 10, 70);
        const contentLength = doc.content.length;
        const lengthBonus = contentLength > 1000 ? 20 : contentLength > 500 ? 10 : 5;
        return Math.min(baseScore + lengthBonus, 100);
    }

    generateSummary(doc, type, articles, score) {
        const typeName = this.documentTypes[type]?.name || 'Documento no clasificado';
        return `Documento "${doc.name}" clasificado como ${typeName}. Identificados ${articles.length} art√≠culos legales aplicables con una puntuaci√≥n de ${score}% de completitud jur√≠dica.`;
    }

    generateRecommendations(type, articles) {
        const recommendations = [];
        
        if (articles.length === 0) {
            recommendations.push('Revisar la clasificaci√≥n del documento y verificar contenido jur√≠dico relevante.');
        }
        
        if (articles.length < 3) {
            recommendations.push('Considerar complementar con documentos adicionales para fortalecer el sustento legal.');
        }
        
        if (type === 'desconocido') {
            recommendations.push('Verificar el tipo de documento y asegurar que contenga elementos identificables.');
        }
        
        return recommendations;
    }

    displayResults() {
        const container = document.getElementById('resultsGrid');
        if (!container) {
            console.error('Container resultsGrid no encontrado');
            return;
        }

        container.innerHTML = '';

        if (this.analysisResults.length === 0) {
            container.innerHTML = '<p>No hay resultados para mostrar. Ejecuta un an√°lisis primero.</p>';
            return;
        }

        this.analysisResults.forEach(result => {
            const card = document.createElement('div');
            card.className = 'result-card';

            const tipoDocs = this.documentTypes[result.documentType]?.name || 'Desconocido';
            const scoreClass = result.score >= 70 ? 'score-high' : result.score >= 40 ? 'score-medium' : 'score-low';
            
            const articulosHtml = result.articles.slice(0, 5).map(art => 
                `<li><strong>${art.codigo} ${art.articulo}:</strong> ${art.contenido}</li>`
            ).join('');

            const recommendationsHtml = result.recommendations.map(rec => `<li>${rec}</li>`).join('');

            card.innerHTML = `
                <div class="result-header">
                    <div class="result-title">${result.documentName}</div>
                    <div class="result-score ${scoreClass}">${result.score}% - ${tipoDocs}</div>
                </div>
                
                <p><strong>Resumen:</strong> ${result.resumen}</p>
                
                <div style="margin: 15px 0;">
                    <strong>Art√≠culos Legales Aplicables (${result.articles.length}):</strong>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        ${articulosHtml}
                        ${result.articles.length > 5 ? '<li><em>... y ' + (result.articles.length - 5) + ' m√°s</em></li>' : ''}
                    </ul>
                </div>
                
                ${result.recommendations.length > 0 ? `
                    <div style="margin: 15px 0;">
                        <strong>Recomendaciones:</strong>
                        <ul style="margin: 10px 0; padding-left: 20px; color: #666;">
                            ${recommendationsHtml}
                        </ul>
                    </div>
                ` : ''}
            `;

            container.appendChild(card);
        });

        console.log(`Mostrados ${this.analysisResults.length} resultados`);
    }

    updateStats() {
        const totalDocs = document.getElementById('totalDocs');
        const analyzedDocs = document.getElementById('analyzedDocs');
        const avgScore = document.getElementById('avgScore');
        const docCount = document.getElementById('docCount');

        const total = this.documents.length;
        const analyzed = this.documents.filter(d => d.analyzed).length;
        const avgScoreValue = this.analysisResults.length > 0 
            ? Math.round(this.analysisResults.reduce((sum, r) => sum + r.score, 0) / this.analysisResults.length)
            : 0;

        if (totalDocs) totalDocs.textContent = total;
        if (analyzedDocs) analyzedDocs.textContent = analyzed;
        if (avgScore) avgScore.textContent = `${avgScoreValue}%`;
        if (docCount) docCount.textContent = total;
    }

    isValidFileType(file) {
        const validExtensions = ['.pdf', '.docx', '.txt', '.csv', '.json', '.xlsx'];
        const fileName = file.name.toLowerCase();
        return validExtensions.some(ext => fileName.endsWith(ext));
    }

    async extractText(file) {
        const extension = file.name.split('.').pop().toLowerCase();
        
        try {
            switch (extension) {
                case 'pdf':
                    return await this.extractFromPDF(file);
                case 'docx':
                    return await this.extractFromDOCX(file);
                case 'txt':
                    return await this.extractFromTXT(file);
                case 'json':
                    return await this.extractFromJSON(file);
                case 'csv':
                    return await this.extractFromCSV(file);
                default:
                    throw new Error(`Tipo de archivo no soportado: ${extension}`);
            }
        } catch (error) {
            console.error(`Error extrayendo texto de ${file.name}:`, error);
            throw error;
        }
    }

    async extractFromPDF(file) {
        if (typeof pdfjsLib === 'undefined') {
            throw new Error('PDF.js no est√° disponible');
        }

        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            fullText += pageText + '\n';
        }

        return fullText;
    }

    async extractFromDOCX(file) {
        if (typeof mammoth === 'undefined') {
            throw new Error('Mammoth.js no est√° disponible');
        }

        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer });
        return result.value;
    }

    async extractFromTXT(file) {
        return await file.text();
    }

    async extractFromJSON(file) {
        const text = await file.text();
        const json = JSON.parse(text);
        return JSON.stringify(json, null, 2);
    }

    async extractFromCSV(file) {
        return await file.text();
    }

    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    generateId() {
        return 'doc_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
    }

    exportResultsAsPDF() {
        const container = document.getElementById('resultsGrid');
        if (!container || this.analysisResults.length === 0) {
            alert('No hay resultados para exportar. Ejecuta un an√°lisis primero.');
            return;
        }

        // Crear contenido para PDF
        const content = document.createElement('div');
        content.style.padding = '20px';
        content.style.fontFamily = 'Arial, sans-serif';
        
        content.innerHTML = `
            <div style="text-align: center; margin-bottom: 30px;">
                <h1>An√°lisis de Carpeta de Investigaci√≥n</h1>
                <h2>Sistema de Evaluaci√≥n Jur√≠dica CNPP - CPEUM</h2>
                <p>Generado el: ${new Date().toLocaleString()}</p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h3>Resumen Ejecutivo</h3>
                <p><strong>Total de documentos:</strong> ${this.documents.length}</p>
                <p><strong>Documentos analizados:</strong> ${this.analysisResults.length}</p>
                <p><strong>Puntuaci√≥n promedio:</strong> ${Math.round(this.analysisResults.reduce((sum, r) => sum + r.score, 0) / this.analysisResults.length)}%</p>
            </div>
            
            <div>
                <h3>Resultados Detallados</h3>
                ${this.analysisResults.map(result => `
                    <div style="border: 1px solid #ddd; margin: 15px 0; padding: 15px;">
                        <h4>${result.documentName} (${result.score}%)</h4>
                        <p><strong>Tipo:</strong> ${this.documentTypes[result.documentType]?.name || 'Desconocido'}</p>
                        <p><strong>Resumen:</strong> ${result.resumen}</p>
                        <p><strong>Art√≠culos aplicables:</strong></p>
                        <ul>
                            ${result.articles.map(art => `<li><strong>${art.codigo} ${art.articulo}:</strong> ${art.contenido}</li>`).join('')}
                        </ul>
                        ${result.recommendations.length > 0 ? `
                            <p><strong>Recomendaciones:</strong></p>
                            <ul>
                                ${result.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `).join('')}
            </div>
        `;

        const opt = {
            margin: 0.5,
            filename: `analisis_carpeta_${new Date().toISOString().split('T')[0]}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        if (typeof html2pdf !== 'undefined') {
            html2pdf().set(opt).from(content).save();
        } else {
            alert('Funci√≥n de exportaci√≥n PDF no disponible.');
        }
    }

    initDocumentTypes() {
        return {
            denuncia: {
                name: 'Denuncia/Querella',
                keywords: ['denuncia', 'querella', 'hechos delictuosos', 'delito', 'ministerio p√∫blico', 'comparece', 'manifiesta']
            },
            inspeccion: {
                name: 'Inspecci√≥n Ministerial',
                keywords: ['inspecci√≥n', 'levantamiento', 'evidencia', 'lugar de los hechos', 'croquis', 'cadena de custodia', 'perito']
            },
            entrevista: {
                name: 'Entrevista/Declaraci√≥n',
                keywords: ['entrevista', 'declaraci√≥n', 'testigo', 'v√≠ctima', 'imputado', 'comparecencia', 'pregunta']
            },
            dictamen: {
                name: 'Dictamen Pericial',
                keywords: ['dictamen', 'pericial', 'an√°lisis', 'conclusiones', 'perito', 't√©cnico', 'cient√≠fico', 'laboratorio']
            },
            oficio: {
                name: 'Oficio/Comunicaci√≥n',
                keywords: ['oficio', 'comunicaci√≥n', 'solicitud', 'requerimiento', 'autoridad', 'remite', 'informa']
            },
            acta: {
                name: 'Acta Circunstanciada',
                keywords: ['acta', 'circunstanciada', 'constancia', 'hechos', 'circunstancias', 'certifico', 'hago constar']
            },
            orden: {
                name: 'Orden de Aprehensi√≥n/Cateo',
                keywords: ['orden', 'aprehensi√≥n', 'cateo', 'juez', 'mandamiento', 'autoriza', 'libra']
            }
        };
    }

    initLegalFramework() {
        return {
            CPEUM: {
                'Art. 14': {
                    content: 'Garant√≠as de audiencia y legalidad. Nadie podr√° ser privado de la libertad o de sus propiedades, posesiones o derechos, sino mediante juicio seguido ante tribunales previamente establecidos.',
                    applies: ['audiencia', 'legalidad', 'debido proceso', 'sentencia', 'tribunal']
                },
                'Art. 16': {
                    content: 'Garant√≠a de seguridad jur√≠dica. Nadie puede ser molestado en su persona, familia, domicilio, papeles o posesiones, sino en virtud de mandamiento escrito de autoridad competente.',
                    applies: ['mandamiento', 'autoridad competente', 'cateo', 'orden', 'fundamentaci√≥n', 'motivaci√≥n']
                },
                'Art. 20': {
                    content: 'Sistema de justicia penal acusatorio y oral. Principios de publicidad, contradicci√≥n, concentraci√≥n, continuidad e inmediaci√≥n.',
                    applies: ['acusatorio', 'oral', 'v√≠ctima', 'imputado', 'defensa', 'ministerio p√∫blico']
                },
                'Art. 21': {
                    content: 'Investigaci√≥n de los delitos corresponde al Ministerio P√∫blico y a las polic√≠as. El ejercicio de la acci√≥n penal ante los tribunales corresponde al Ministerio P√∫blico.',
                    applies: ['investigaci√≥n', 'ministerio p√∫blico', 'polic√≠a', 'acci√≥n penal', 'delitos']
                }
            },
            CNPP: {
                'Art. 131': {
                    content: 'Ejercicio de la acci√≥n penal. El Ministerio P√∫blico ejercer√° la acci√≥n penal cuando de la investigaci√≥n se desprendan datos de prueba que establezcan que se ha cometido un hecho delictivo.',
                    applies: ['acci√≥n penal', 'datos de prueba', 'hecho delictivo', 'investigaci√≥n', 'ministerio p√∫blico']
                },
                'Art. 211': {
                    content: 'Registro de la investigaci√≥n. El Ministerio P√∫blico deber√° registrar y conservar los registros de las diligencias en la carpeta de investigaci√≥n.',
                    applies: ['carpeta de investigaci√≥n', 'registro', 'diligencias', 'conservar', 'investigaci√≥n']
                },
                'Art. 259': {
                    content: 'Medios de prueba. Son medios de prueba los documentos, dict√°menes periciales, testimonios y dem√°s elementos que produzcan convicci√≥n en el juzgador.',
                    applies: ['medios de prueba', 'documentos', 'dictamen pericial', 'testimonio', 'convicci√≥n']
                },
                'Art. 261': {
                    content: 'Prueba il√≠cita. Queda prohibido utilizar medios de prueba obtenidos directa o indirectamente por medios il√≠citos.',
                    applies: ['prueba il√≠cita', 'medios il√≠citos', 'prohibido', 'cadena de custodia']
                },
                'Art. 266': {
                    content: 'Cadena de custodia. Desde que se descubren o encuentran indicios, hasta que la autoridad competente ordene su destino final.',
                    applies: ['cadena de custodia', 'indicios', 'evidencia', 'custodia', 'autoridad competente']
                },
                'Art. 313': {
                    content: 'Denuncia. Cualquier persona que tenga conocimiento de la comisi√≥n de un delito deber√° hacerlo del conocimiento de la autoridad.',
                    applies: ['denuncia', 'conocimiento', 'delito', 'autoridad', 'comisi√≥n']
                },
                'Art. 335': {
                    content: 'Entrevista a v√≠ctimas. Deber√° realizarse sin demora innecesaria en condiciones que garanticen la comodidad y privacidad.',
                    applies: ['entrevista', 'v√≠ctima', 'sin demora', 'privacidad', 'comodidad']
                },
                'Art. 359': {
                    content: 'Inspecci√≥n del lugar del hecho. Se realizar√° de inmediato una inspecci√≥n en el lugar donde ocurrieron los hechos.',
                    applies: ['inspecci√≥n', 'lugar de los hechos', 'inmediato', 'hechos', 'perito']
                }
            }
        };
    }
}

// Inicializaci√≥n global
let carpetaAnalyzer;

// Funci√≥n de exportaci√≥n global para HTML
function exportResultsAsPDF() {
    if (carpetaAnalyzer) {
        carpetaAnalyzer.exportResultsAsPDF();
    } else {
        alert('Sistema no inicializado correctamente.');
    }
}

function exportSpecialReport(format) {
    if (!carpetaAnalyzer || carpetaAnalyzer.analysisResults.length === 0) {
        alert('No hay resultados para exportar.');
        return;
    }
    
    if (format === 'json') {
        const data = {
            metadata: {
                generatedAt: new Date().toISOString(),
                totalDocuments: carpetaAnalyzer.documents.length,
                analyzedDocuments: carpetaAnalyzer.analysisResults.length
            },
            results: carpetaAnalyzer.analysisResults
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `analisis_carpeta_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } else {
        carpetaAnalyzer.exportResultsAsPDF();
    }
}

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM cargado, inicializando CarpetaAnalyzer...');
    carpetaAnalyzer = new CarpetaAnalyzer();
    carpetaAnalyzer.init();
});
    </script>
</body>
</html>
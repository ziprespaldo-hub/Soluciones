<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis de Carpeta de Investigaci√≥n - Sistema Jur√≠dico</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #d4af37, #ffd700);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #1e3c72;
            font-weight: bold;
        }

        .logo-text {
            font-size: 24px;
            font-weight: bold;
            color: #1e3c72;
        }

        .subtitle {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .status-indicator {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        nav {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 24px;
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .nav-btn.active {
            background: linear-gradient(45deg, #d4af37, #ffd700);
            color: #1e3c72;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            min-height: 600px;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .content-area {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed #2a5298;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, rgba(42, 82, 152, 0.05), rgba(212, 175, 55, 0.05));
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #d4af37;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(42, 82, 152, 0.1));
        }

        .upload-area.dragover {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .upload-icon {
            font-size: 48px;
            color: #2a5298;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 18px;
            font-weight: bold;
            color: #2a5298;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #2a5298, #1e3c72);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #2a5298;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-icon {
            width: 32px;
            height: 32px;
            background: #2a5298;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            color: #333;
        }

        .file-size {
            font-size: 12px;
            color: #666;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .analyze-btn {
            background: #28a745;
            color: white;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        .analysis-panel {
            margin-top: 25px;
        }

        .panel-header {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 0 0 10px 10px;
            border: 1px solid #e9ecef;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: #2a5298;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #2a5298;
        }

        .result-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .result-title {
            font-weight: bold;
            color: #1e3c72;
            font-size: 16px;
        }

        .result-score {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .score-high {
            background: #d4edda;
            color: #155724;
        }

        .score-medium {
            background: #fff3cd;
            color: #856404;
        }

        .score-low {
            background: #f8d7da;
            color: #721c24;
        }

        .export-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .export-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .export-btn {
            padding: 12px 24px;
            border: 2px solid #2a5298;
            background: white;
            color: #2a5298;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #2a5298;
            color: white;
            transform: translateY(-2px);
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #2a5298;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .document-tree {
            margin-top: 20px;
        }

        .tree-item {
            padding: 10px;
            border-left: 2px solid #2a5298;
            margin-left: 10px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tree-item:hover {
            background: rgba(42, 82, 152, 0.1);
            border-left-width: 4px;
        }

        .tree-item.selected {
            background: rgba(42, 82, 152, 0.2);
            border-left-color: #d4af37;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-buttons {
                justify-content: center;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }
    </style>

<!-- Librer√≠as necesarias para an√°lisis de archivos -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">‚öñ</div>
                    <div>
                        <div class="logo-text">An√°lisis Carpeta de Investigaci√≥n</div>
                        <div class="subtitle">Sistema de Evaluaci√≥n Jur√≠dica CNPP - CPEUM</div>
                    </div>
                </div>
                <div class="status-indicator">Sistema Activo</div>
            </div>
        </header>

        <!-- Navigation -->
        <nav>
            <div class="nav-buttons">
                <button class="nav-btn active" data-section="upload">üìÅ Cargar Documentos</button>
                <button class="nav-btn" data-section="analysis">‚öñÔ∏è An√°lisis Jur√≠dico</button>
                <button class="nav-btn" data-section="results">üìä Resultados</button>
                <button class="nav-btn" data-section="reports">üìÑ Reportes</button>
                <button class="nav-btn" data-section="help">‚ùì Ayuda</button>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <h3>üìÇ Estructura de Carpeta</h3>
                <div class="document-tree" id="documentTree">
                    <div class="tree-item">üìã Carpeta de Investigaci√≥n</div>
                    <div class="tree-item">‚îî‚îÄ‚îÄ üìÅ Documentos Cargados (<span id="docCount">0</span>)</div>
                </div>

                <div class="summary-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalDocs">0</div>
                        <div class="stat-label">Documentos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="analyzedDocs">0</div>
                        <div class="stat-label">Analizados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgScore">0%</div>
                        <div class="stat-label">Score Promedio</div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Upload Section -->
                <div class="section active" id="upload">
                    <h2>üìÅ Carga de Documentos</h2>
                    <p>Sube los documentos que conforman la carpeta de investigaci√≥n para su an√°lisis jur√≠dico conforme al CNPP y CPEUM.</p>

                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Arrastra documentos aqu√≠</div>
                        <div class="upload-subtext">O haz clic para seleccionar archivos</div>
                        <div class="upload-subtext">Formatos: PDF, DOCX, TXT, CSV, JSON, XLSX</div>
                        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                            Seleccionar Archivos
                        </button>
                    </div>

                    <input type="file" id="fileInput" class="file-input" multiple 
                           accept=".pdf,.docx,.txt,.csv,.json,.xlsx">

                    <div class="file-list" id="fileList">
                        <!-- Archivos cargados aparecer√°n aqu√≠ -->
                    </div>
                </div>

                <!-- Analysis Section -->
                <div class="section" id="analysis">
                    <h2>‚öñÔ∏è An√°lisis Jur√≠dico en Progreso</h2>
                    
                    <div class="analysis-panel">
                        <div class="panel-header">
                            <span>Evaluaci√≥n de Documentos</span>
                            <span id="analysisStatus">Listo para analizar</span>
                        </div>
                        <div class="panel-content">
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <div class="progress-text" id="progressText">0% completado</div>
                            </div>
                            
                            <div id="analysisLog">
                                <p>Selecciona documentos y presiona "Iniciar An√°lisis" para comenzar la evaluaci√≥n jur√≠dica.</p>
                            </div>
                        </div>
                    </div>

                    <button class="upload-btn" id="startAnalysis" style="margin-top: 20px;">
                        üîç Iniciar An√°lisis Jur√≠dico
                    </button>
                </div>

                <!-- Results Section -->
                <div class="section" id="results">
                    <h2>üìä Resultados del An√°lisis</h2>
                    
                    <div class="results-grid" id="resultsGrid">
                        <!-- Resultados aparecer√°n aqu√≠ din√°micamente -->
                    </div>
                </div>

                <!-- Reports Section -->
                <div class="section" id="reports">
                    <h2>üìÑ Generaci√≥n de Reportes</h2>
                    
                    <div class="export-panel">
                        <h3>üìã Resumen Ejecutivo</h3>
                        <p>Generar dictamen procesal estructurado con an√°lisis completo de la carpeta de investigaci√≥n.</p>
                        
                        <div class="export-options">
                            <button class="export-btn" id="exportPDF">üìÑ Exportar PDF</button>
                            <button class="export-btn" id="exportJSON">üìã Exportar JSON</button>
                            <button class="export-btn" id="exportDOCX">üìù Exportar DOCX</button>
                            <button class="export-btn" id="exportExcel">üìä Exportar Excel</button>
                        </div>
                    </div>

                    <div class="export-panel" style="margin-top: 20px;">
                        <h3>üìà Reportes Especializados</h3>
                        <div class="export-options">
                            <button class="export-btn">‚è±Ô∏è Cronolog√≠a de Actuaciones</button>
                            <button class="export-btn">üìä √çndice de Suficiencia</button>
                            <button class="export-btn">‚öñÔ∏è Dictamen Legal</button>
                            <button class="export-btn">üîç Recomendaciones</button>
                        </div>
                    </div>
                </div>

                <!-- Help Section -->
                <div class="section" id="help">
                    <h2>‚ùì Ayuda y Documentaci√≥n</h2>
                    
                    <div class="panel-content">
                        <h3>üîç Tipos de Documentos Analizados</h3>
                        <ul style="margin: 15px 0; padding-left: 30px;">
                            <li><strong>Denuncia/Querella:</strong> Inicio formal de la investigaci√≥n</li>
                            <li><strong>Inspecci√≥n:</strong> Levantamiento de evidencia f√≠sica</li>
                            <li><strong>Entrevistas:</strong> Declaraciones de v√≠ctimas, testigos, imputados</li>
                            <li><strong>Dict√°menes Periciales:</strong> An√°lisis t√©cnicos especializados</li>
                            <li><strong>Oficios:</strong> Comunicaciones oficiales</li>
                            <li><strong>Cadena de Custodia:</strong> Control de evidencias</li>
                        </ul>

                        <h3>‚öñÔ∏è Marco Legal Aplicado</h3>
                        <ul style="margin: 15px 0; padding-left: 30px;">
                            <li><strong>CPEUM:</strong> Arts. 14, 16, 20, 21</li>
                            <li><strong>CNPP:</strong> Arts. 131, 211-220, 259-265, 266-303, 313, 335-336, 359</li>
                            <li><strong>C√≥digo Penal:</strong> Tipificaci√≥n de delitos</li>
                            <li><strong>Leyes Complementarias:</strong> Normativa espec√≠fica aplicable</li>
                        </ul>

                        <h3>üìä Criterios de Evaluaci√≥n</h3>
                        <ul style="margin: 15px 0; padding-left: 30px;">
                            <li><strong>Forma:</strong> Estructura, firmas, fechas, identificaci√≥n</li>
                            <li><strong>Fondo:</strong> Narrativa, hechos relevantes, congruencia</li>
                            <li><strong>Valor Probatorio:</strong> Utilidad para imputar, vincular, acusar</li>
                            <li><strong>Legalidad:</strong> Conformidad con marco jur√≠dico</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts se cargar√°n en las siguientes partes -->
    <script>
        // Script b√°sico para navegaci√≥n - Se ampliar√° en PARTE 2
        document.addEventListener('DOMContentLoaded', function() {
            // Navegaci√≥n entre secciones
            const navButtons = document.querySelectorAll('.nav-btn');
            const sections = document.querySelectorAll('.section');
            
            navButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetSection = this.getAttribute('data-section');
                    
                    // Remover clase active de todos los botones y secciones
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    sections.forEach(section => section.classList.remove('active'));
                    
                    // Agregar clase active al bot√≥n y secci√≥n correspondiente
                    this.classList.add('active');
                    document.getElementById(targetSection).classList.add('active');

        // === PARTE 2: JS-CORE-DOCS ===
        
        // Variables globales
        let uploadedFiles = [];
        let processedDocuments = [];
        let analysisResults = [];
        
        // Configuraci√≥n de tipos de archivo
        const FILE_TYPES = {
            pdf: { icon: 'PDF', color: '#dc3545', processor: 'processPDF' },
            docx: { icon: 'DOC', color: '#2b579a', processor: 'processDOCX' },
            txt: { icon: 'TXT', color: '#28a745', processor: 'processTXT' },
            csv: { icon: 'CSV', color: '#fd7e14', processor: 'processCSV' },
            json: { icon: 'JSON', color: '#6f42c1', processor: 'processJSON' },
            xlsx: { icon: 'XLS', color: '#198754', processor: 'processXLSX' }
        };

        // Tipos de documentos jur√≠dicos
        const DOCUMENT_TYPES = {
            DENUNCIA: { name: 'Denuncia/Querella', keywords: ['denuncia', 'querella', 'hechos', 'delito'], weight: 0.9 },
            INSPECCION: { name: 'Inspecci√≥n', keywords: ['inspecci√≥n', 'lugar', 'hechos', 'evidencia', 'croquis'], weight: 0.8 },
            ENTREVISTA: { name: 'Entrevista', keywords: ['entrevista', 'declaraci√≥n', 'testigo', 'v√≠ctima'], weight: 0.7 },
            DICTAMEN: { name: 'Dictamen Pericial', keywords: ['dictamen', 'pericial', 'an√°lisis', 'conclusiones'], weight: 0.9 },
            CADENA_CUSTODIA: { name: 'Cadena de Custodia', keywords: ['cadena', 'custodia', 'evidencia', 'indicio'], weight: 0.8 },
            OFICIO: { name: 'Oficio', keywords: ['oficio', 'solicitud', 'informe', 'comunicaci√≥n'], weight: 0.6 },
            CITATORIO: { name: 'Citatorio', keywords: ['citatorio', 'comparecencia', 'cita'], weight: 0.5 },
            ACUERDO: { name: 'Acuerdo', keywords: ['acuerdo', 'resoluci√≥n', 'determinaci√≥n'], weight: 0.7 }
        };

        // Art√≠culos del marco legal
        const LEGAL_FRAMEWORK = {
            CPEUM: {
                art14: { title: 'Art. 14 CPEUM', description: 'Principio de legalidad y debido proceso' },
                art16: { title: 'Art. 16 CPEUM', description: 'Fundamento y motivaci√≥n de actos de autoridad' },
                art20A: { title: 'Art. 20-A CPEUM', description: 'Derechos del imputado' },
                art20B: { title: 'Art. 20-B CPEUM', description: 'Derechos de la v√≠ctima' },
                art21: { title: 'Art. 21 CPEUM', description: 'Investigaci√≥n penal por MP y polic√≠as' }
            },
            CNPP: {
                art131: { title: 'Art. 131 CNPP', description: 'Ejercicio de la acci√≥n penal' },
                art211: { title: 'Art. 211 CNPP', description: 'Formas de inicio de investigaci√≥n' },
                art259: { title: 'Art. 259 CNPP', description: 'Datos de prueba' },
                art313: { title: 'Art. 313 CNPP', description: 'Ejercicio de acci√≥n penal' },
                art335: { title: 'Art. 335 CNPP', description: 'Cierre de investigaci√≥n complementaria' },
                art336: { title: 'Art. 336 CNPP', description: 'Formulaci√≥n de acusaci√≥n' }
            }
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            // Navegaci√≥n entre secciones
            const navButtons = document.querySelectorAll('.nav-btn');
            const sections = document.querySelectorAll('.section');
            
            navButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetSection = this.getAttribute('data-section');
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    sections.forEach(section => section.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(targetSection).classList.add('active');
                });
            });
        }

        function setupEventListeners() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const startAnalysis = document.getElementById('startAnalysis');

            // Manejo de archivos
            fileInput.addEventListener('change', handleFileSelect);
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleFileDrop);
            uploadArea.addEventListener('dragleave', handleDragLeave);

            // Bot√≥n de an√°lisis
            startAnalysis.addEventListener('click', startDocumentAnalysis);

            // Botones de exportaci√≥n
            document.getElementById('exportPDF').addEventListener('click', () => exportReport('pdf'));
            document.getElementById('exportJSON').addEventListener('click', () => exportReport('json'));
            document.getElementById('exportDOCX').addEventListener('click', () => exportReport('docx'));
            document.getElementById('exportExcel').addEventListener('click', () => exportReport('excel'));
        }

        // === MANEJO DE ARCHIVOS ===
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            processSelectedFiles(files);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const files = Array.from(event.dataTransfer.files);
            processSelectedFiles(files);
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function processSelectedFiles(files) {
            files.forEach(file => {
                if (isValidFileType(file)) {
                    uploadedFiles.push({
                        id: generateId(),
                        file: file,
                        name: file.name,
                        size: formatFileSize(file.size),
                        type: getFileExtension(file.name),
                        status: 'pending',
                        content: null,
                        analysis: null
                    });
                }
            });
            updateFileList();
            updateStats();
        }

        function isValidFileType(file) {
            const extension = getFileExtension(file.name);
            return Object.keys(FILE_TYPES).includes(extension);
        }

        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function generateId() {
            return 'doc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // === VISUALIZACI√ìN DE ARCHIVOS ===
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            uploadedFiles.forEach(fileData => {
                const fileItem = createFileItem(fileData);
                fileList.appendChild(fileItem);
            });
        }

        function createFileItem(fileData) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.setAttribute('data-id', fileData.id);

            const fileType = FILE_TYPES[fileData.type];
            
            fileItem.innerHTML = `
                <div class="file-info">
                    <div class="file-icon" style="background: ${fileType.color}">
                        ${fileType.icon}
                    </div>
                    <div class="file-details">
                        <div class="file-name">${fileData.name}</div>
                        <div class="file-size">${fileData.size} ‚Ä¢ ${fileData.status}</div>
                    </div>
                </div>
                <div class="file-actions">
                    <button class="action-btn analyze-btn" onclick="analyzeDocument('${fileData.id}')">
                        Analizar
                    </button>
                    <button class="action-btn remove-btn" onclick="removeFile('${fileData.id}')">
                        Eliminar
                    </button>
                </div>
            `;

            return fileItem;
        }

        function removeFile(fileId) {
            uploadedFiles = uploadedFiles.filter(file => file.id !== fileId);
            updateFileList();
            updateStats();
        }

        // === PROCESAMIENTO DE DOCUMENTOS ===
        async function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                
                if (file.type.includes('text') || getFileExtension(file.name) === 'txt') {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        async function processPDF(file) {
            try {
                // Simulaci√≥n de procesamiento PDF
                // En implementaci√≥n real usar PDF.js
                await new Promise(resolve => setTimeout(resolve, 1000));
                return {
                    content: `[CONTENIDO PDF SIMULADO] ${file.name}`,
                    pages: Math.floor(Math.random() * 10) + 1,
                    extractedText: `Contenido extra√≠do del archivo PDF: ${file.name}`
                };
            } catch (error) {
                throw new Error(`Error procesando PDF: ${error.message}`);
            }
        }

        async function processDOCX(file) {
            try {
                // Simulaci√≥n de procesamiento DOCX
                await new Promise(resolve => setTimeout(resolve, 800));
                return {
                    content: `[CONTENIDO DOCX SIMULADO] ${file.name}`,
                    extractedText: `Contenido extra√≠do del documento Word: ${file.name}`
                };
            } catch (error) {
                throw new Error(`Error procesando DOCX: ${error.message}`);
            }
        }

        async function processTXT(file) {
            try {
                const content = await readFileContent(file);
                return {
                    content: content,
                    extractedText: content
                };
            } catch (error) {
                throw new Error(`Error procesando TXT: ${error.message}`);
            }
        }

        async function processCSV(file) {
            try {
                const content = await readFileContent(file);
                // Simulaci√≥n de parsing CSV
                const lines = content.split('\n');
                return {
                    content: content,
                    extractedText: content,
                    rows: lines.length,
                    headers: lines[0]?.split(',') || []
                };
            } catch (error) {
                throw new Error(`Error procesando CSV: ${error.message}`);
            }
        }

        async function processJSON(file) {
            try {
                const content = await readFileContent(file);
                const jsonData = JSON.parse(content);
                return {
                    content: content,
                    extractedText: JSON.stringify(jsonData, null, 2),
                    structure: jsonData
                };
            } catch (error) {
                throw new Error(`Error procesando JSON: ${error.message}`);
            }
        }

        async function processXLSX(file) {
            try {
                // Simulaci√≥n de procesamiento Excel
                await new Promise(resolve => setTimeout(resolve, 1200));
                return {
                    content: `[CONTENIDO XLSX SIMULADO] ${file.name}`,
                    extractedText: `Datos extra√≠dos de la hoja de c√°lculo: ${file.name}`,
                    sheets: ['Hoja1', 'Hoja2']
                };
            } catch (error) {
                throw new Error(`Error procesando XLSX: ${error.message}`);
            }
        }

        // === CLASIFICACI√ìN DE DOCUMENTOS ===
        function classifyDocumentType(content) {
            const contentLower = content.toLowerCase();
            let bestMatch = { type: 'DESCONOCIDO', confidence: 0 };

            Object.entries(DOCUMENT_TYPES).forEach(([type, config]) => {
                let matches = 0;
                config.keywords.forEach(keyword => {
                    if (contentLower.includes(keyword)) {
                        matches++;
                    }
                });
                
                const confidence = matches / config.keywords.length;
                if (confidence > bestMatch.confidence) {
                    bestMatch = { type, confidence, config };
                }
            });

            return bestMatch;
        }

        // === AN√ÅLISIS INDIVIDUAL DE DOCUMENTOS ===
        async function analyzeDocument(fileId) {
            const fileData = uploadedFiles.find(f => f.id === fileId);
            if (!fileData) return;

            try {
                updateFileStatus(fileId, 'processing');
                
                // Procesar contenido seg√∫n tipo de archivo
                const processor = FILE_TYPES[fileData.type].processor;
                const processedContent = await window[processor](fileData.file);
                
                // Clasificar tipo de documento
                const classification = classifyDocumentType(processedContent.extractedText);
                
                // Actualizar datos del archivo
                fileData.content = processedContent;
                fileData.classification = classification;
                fileData.status = 'processed';
                
                updateFileStatus(fileId, 'processed');
                showNotification(`Documento ${fileData.name} procesado correctamente`, 'success');
                
            } catch (error) {
                updateFileStatus(fileId, 'error');
                showNotification(`Error procesando ${fileData.name}: ${error.message}`, 'error');
            }
        }

        function updateFileStatus(fileId, status) {
            const fileItem = document.querySelector(`[data-id="${fileId}"] .file-size`);
            if (fileItem) {
                const statusText = {
                    'pending': 'Pendiente',
                    'processing': 'Procesando...',
                    'processed': 'Procesado',
                    'error': 'Error'
                };
                fileItem.textContent = fileItem.textContent.split(' ‚Ä¢ ')[0] + ' ‚Ä¢ ' + statusText[status];
            }
        }

        // === AN√ÅLISIS MASIVO ===
        async function startDocumentAnalysis() {
            if (uploadedFiles.length === 0) {
                showNotification('No hay documentos para analizar', 'warning');
                return;
            }

            const analysisLog = document.getElementById('analysisLog');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const startButton = document.getElementById('startAnalysis');

            startButton.disabled = true;
            startButton.innerHTML = '<span class="loading"></span> Analizando...';
            
            analysisLog.innerHTML = '<h4>üîç Iniciando an√°lisis jur√≠dico...</h4>';

            for (let i = 0; i < uploadedFiles.length; i++) {
                const file = uploadedFiles[i];
                const progress = ((i + 1) / uploadedFiles.length) * 100;
                
                progressFill.style.width = progress + '%';
                progressText.textContent = `${Math.round(progress)}% completado`;
                
                analysisLog.innerHTML += `<p>üìÑ Procesando: ${file.name}</p>`;
                
                await analyzeDocument(file.id);
                await new Promise(resolve => setTimeout(resolve, 500)); // Simular tiempo de procesamiento
            }

            startButton.disabled = false;
            startButton.innerHTML = '‚úÖ An√°lisis Completado';
            analysisLog.innerHTML += '<p><strong>‚úÖ An√°lisis jur√≠dico completado. Revisa la secci√≥n de Resultados.</strong></p>';
            
            updateStats();
            generateAnalysisResults();
        }

        // === ESTAD√çSTICAS Y UTILIDADES ===
        function updateStats() {
            document.getElementById('totalDocs').textContent = uploadedFiles.length;
            document.getElementById('docCount').textContent = uploadedFiles.length;
            
            const processedCount = uploadedFiles.filter(f => f.status === 'processed').length;
            document.getElementById('analyzedDocs').textContent = processedCount;
            
            // Calcular score promedio (simulado)
            const avgScore = processedCount > 0 ? Math.floor(Math.random() * 30) + 60 : 0;
            document.getElementById('avgScore').textContent = avgScore + '%';
        }

        function showNotification(message, type = 'info') {
            // Implementaci√≥n b√°sica de notificaciones
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 1000;
                padding: 15px 20px; border-radius: 8px; color: white;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // === GENERACI√ìN DE RESULTADOS (Preparaci√≥n para Parte 3) ===
        function generateAnalysisResults() {
            // Esta funci√≥n ser√° expandida en la Parte 3
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = '<p>üìä Los resultados detallados se generar√°n en la Parte 3: An√°lisis Jur√≠dico</p>';
        }

        // === EXPORTACI√ìN (Preparaci√≥n para Parte 3) ===
        function exportReport(format) {
            showNotification(`Exportando reporte en formato ${format.upper()}...`, 'info');
            // Implementaci√≥n completa en Parte 3
        }
    // =====================================================
        // SISTEMA DE AN√ÅLISIS JUR√çDICO CARPETA DE INVESTIGACI√ìN
        // =====================================================

        class CarpetaAnalyzer {
            constructor() {
                this.documents = [];
                this.analysisResults = [];
                this.legalFramework = this.initLegalFramework();
                this.documentTypes = this.initDocumentTypes();
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupDragAndDrop();
                this.initPDFWorker();
            }

            initPDFWorker() {
                if (typeof pdfjsLib !== 'undefined') {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                }
            }

            // =====================================
            // MARCO LEGAL - CNPP Y CPEUM
            // =====================================
            initLegalFramework() {
                return {
                    CPEUM: {
                        art14: {
                            content: "Nadie puede ser privado de la libertad o derechos sin juicio seguido ante tribunales",
                            applies: ["sentencias", "resoluciones", "legalidad"],
                            weight: 0.9
                        },
                        art16: {
                            content: "Nadie puede ser molestado sino en virtud de mandamiento escrito fundado y motivado",
                            applies: ["cateos", "detenciones", "intervenciones"],
                            weight: 0.95
                        },
                        art20A: {
                            content: "Derechos del imputado - presunci√≥n de inocencia, defensa adecuada",
                            applies: ["entrevistas", "declaraciones", "imputacion"],
                            weight: 0.9
                        },
                        art20B: {
                            content: "Derechos de la v√≠ctima - asesor√≠a, coadyuvancia, reparaci√≥n",
                            applies: ["denuncia", "victima", "reparacion"],
                            weight: 0.85
                        },
                        art21: {
                            content: "Investigaci√≥n corresponde al MP y polic√≠as bajo su conducci√≥n",
                            applies: ["investigacion", "policia", "mp"],
                            weight: 0.9
                        }
                    },
                    CNPP: {
                        art131: {
                            content: "Criterios para ejercicio de acci√≥n penal - datos suficientes",
                            applies: ["acusacion", "vinculacion", "datos_prueba"],
                            weight: 1.0
                        },
                        art211: {
                            content: "Formas de inicio: denuncia, querella, oficio",
                            applies: ["denuncia", "querella", "inicio"],
                            weight: 0.8
                        },
                        art212_220: {
                            content: "Desarrollo de investigaci√≥n inicial",
                            applies: ["investigacion", "diligencias", "datos"],
                            weight: 0.85
                        },
                        art259_265: {
                            content: "Prueba il√≠cita y cadena de custodia",
                            applies: ["evidencia", "custodia", "licitud"],
                            weight: 0.95
                        },
                        art266_303: {
                            content: "Medios de prueba y su desahogo",
                            applies: ["pruebas", "desahogo", "valoracion"],
                            weight: 0.9
                        },
                        art313: {
                            content: "Ejercicio de acci√≥n penal y audiencia inicial",
                            applies: ["accion_penal", "audiencia", "imputacion"],
                            weight: 0.9
                        },
                        art335: {
                            content: "Cierre de investigaci√≥n complementaria",
                            applies: ["cierre", "complementaria", "acusacion"],
                            weight: 0.8
                        },
                        art336: {
                            content: "Formulaci√≥n de acusaci√≥n",
                            applies: ["acusacion", "escrito", "pruebas"],
                            weight: 0.85
                        }
                    }
                };
            }

            // =====================================
            // TIPOS DOCUMENTALES
            // =====================================
            initDocumentTypes() {
                return {
                    denuncia: {
                        name: "Denuncia/Querella",
                        requiredElements: ["fecha", "lugar", "hechos", "denunciante", "firma"],
                        legalBasis: ["art211_CNPP", "art21_CPEUM"],
                        probatoryValue: 0.8,
                        keywords: ["denuncia", "querella", "hechos", "delito", "denunciante"]
                    },
                    inspeccion: {
                        name: "Inspecci√≥n/Diligencia",
                        requiredElements: ["fecha", "lugar", "autoridad", "descripcion", "croquis", "fotos"],
                        legalBasis: ["art259_265_CNPP", "art16_CPEUM"],
                        probatoryValue: 0.9,
                        keywords: ["inspecci√≥n", "lugar", "evidencia", "descripci√≥n", "hallazgo"]
                    },
                    entrevista: {
                        name: "Entrevista/Declaraci√≥n",
                        requiredElements: ["fecha", "lugar", "declarante", "narrativa", "firma", "derechos"],
                        legalBasis: ["art20A_CPEUM", "art266_303_CNPP"],
                        probatoryValue: 0.75,
                        keywords: ["entrevista", "declaraci√≥n", "testigo", "v√≠ctima", "imputado"]
                    },
                    dictamen: {
                        name: "Dictamen Pericial",
                        requiredElements: ["perito", "metodologia", "conclusiones", "fundamentacion", "firma"],
                        legalBasis: ["art266_303_CNPP"],
                        probatoryValue: 0.95,
                        keywords: ["dictamen", "pericial", "an√°lisis", "conclusi√≥n", "perito"]
                    },
                    custodia: {
                        name: "Cadena de Custodia",
                        requiredElements: ["fecha", "responsable", "descripcion", "entrega", "recepcion"],
                        legalBasis: ["art259_265_CNPP"],
                        probatoryValue: 0.85,
                        keywords: ["custodia", "evidencia", "indicio", "entrega", "cadena"]
                    },
                    oficio: {
                        name: "Oficio/Comunicaci√≥n",
                        requiredElements: ["fecha", "destinatario", "asunto", "firma", "sello"],
                        legalBasis: ["art212_220_CNPP"],
                        probatoryValue: 0.6,
                        keywords: ["oficio", "solicitud", "informe", "comunicaci√≥n"]
                    }
                };
            }

            // =====================================
            // MANEJO DE EVENTOS
            // =====================================
            setupEventListeners() {
                // Navegaci√≥n
                const navButtons = document.querySelectorAll('.nav-btn');
                const sections = document.querySelectorAll('.section');
                
                navButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const targetSection = e.target.getAttribute('data-section');
                        this.switchSection(targetSection);
                    });
                });

                // Carga de archivos
                document.getElementById('fileInput').addEventListener('change', (e) => {
                    this.handleFileSelect(e.target.files);
                });

                // An√°lisis
                document.getElementById('startAnalysis').addEventListener('click', () => {
                    this.startAnalysis();
                });

                // Exportaci√≥n
                document.getElementById('exportPDF').addEventListener('click', () => {
                    this.exportToPDF();
                });

                document.getElementById('exportJSON').addEventListener('click', () => {
                    this.exportToJSON();
                });
            }

            setupDragAndDrop() {
                const uploadArea = document.getElementById('uploadArea');
                
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    this.handleFileSelect(e.dataTransfer.files);
                });

                uploadArea.addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });
            }

            switchSection(sectionId) {
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
                
                document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
                document.getElementById(sectionId).classList.add('active');
            }

            // =====================================
            // PROCESAMIENTO DE ARCHIVOS
            // =====================================
            async handleFileSelect(files) {
                for (let file of files) {
                    if (this.isValidFileType(file)) {
                        await this.processFile(file);
                    }
                }
                this.updateFileList();
                this.updateStats();
            }

            isValidFileType(file) {
                const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 
                                   'text/plain', 'application/json', 'text/csv', 
                                   'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
                return validTypes.includes(file.type) || 
                       file.name.match(/\.(pdf|docx|txt|json|csv|xlsx)$/i);
            }

            async processFile(file) {
                const doc = {
                    id: this.generateId(),
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    content: '',
                    uploadDate: new Date(),
                    analyzed: false
                };

                try {
                    doc.content = await this.extractText(file);
                    this.documents.push(doc);
                } catch (error) {
                    console.error('Error procesando archivo:', error);
                }
            }

            async extractText(file) {
                const fileType = file.type || this.getFileTypeFromName(file.name);
                
                switch (fileType) {
                    case 'application/pdf':
                        return await this.extractFromPDF(file);
                    case 'application/vnd.openxmlformats-officedocument.wordprocessingml.document':
                        return await this.extractFromDOCX(file);
                    case 'text/plain':
                        return await this.extractFromTXT(file);
                    case 'application/json':
                        return await this.extractFromJSON(file);
                    case 'text/csv':
                        return await this.extractFromCSV(file);
                    case 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':
                        return await this.extractFromXLSX(file);
                    default:
                        return await this.extractFromTXT(file);
                }
            }

            async extractFromPDF(file) {
                if (typeof pdfjsLib === 'undefined') {
                    throw new Error('PDF.js no disponible');
                }

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let text = '';

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    text += pageText + '\n';
                }

                return text;
            }

            async extractFromDOCX(file) {
                if (typeof mammoth === 'undefined') {
                    throw new Error('Mammoth no disponible');
                }

                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({arrayBuffer});
                return result.value;
            }

            async extractFromTXT(file) {
                return await file.text();
            }

            async extractFromJSON(file) {
                const text = await file.text();
                const json = JSON.parse(text);
                return JSON.stringify(json, null, 2);
            }

            async extractFromCSV(file) {
                return await file.text();
            }

            async extractFromXLSX(file) {
                if (typeof XLSX === 'undefined') {
                    throw new Error('XLSX no disponible');
                }

                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                let text = '';

                workbook.SheetNames.forEach(sheetName => {
                    const sheet = workbook.Sheets[sheetName];
                    const csv = XLSX.utils.sheet_to_csv(sheet);
                    text += `Hoja: ${sheetName}\n${csv}\n\n`;
                });

                return text;
            }

            getFileTypeFromName(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const mimeTypes = {
                    'pdf': 'application/pdf',
                    'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                    'txt': 'text/plain',
                    'json': 'application/json',
                    'csv': 'text/csv',
                    'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                };
                return mimeTypes[ext] || 'text/plain';
            }

            // =====================================
            // AN√ÅLISIS JUR√çDICO PRINCIPAL
            // =====================================
            async startAnalysis() {
                if (this.documents.length === 0) {
                    alert('No hay documentos para analizar');
                    return;
                }

                this.switchSection('analysis');
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                const analysisLog = document.getElementById('analysisLog');
                const analysisStatus = document.getElementById('analysisStatus');

                analysisStatus.textContent = 'Analizando...';
                analysisLog.innerHTML = '<h4>üìã Iniciando an√°lisis jur√≠dico...</h4>';

                this.analysisResults = [];

                for (let i = 0; i < this.documents.length; i++) {
                    const doc = this.documents[i];
                    const progress = ((i + 1) / this.documents.length) * 100;
                    
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `${Math.round(progress)}% completado`;
                    
                    analysisLog.innerHTML += `<p>üîç Analizando: ${doc.name}</p>`;
                    
                    const analysis = await this.analyzeDocument(doc);
                    this.analysisResults.push(analysis);
                    doc.analyzed = true;
                    
                    await this.delay(500); // Simular procesamiento
                }

                analysisStatus.textContent = 'An√°lisis completado';
                analysisLog.innerHTML += '<p><strong>‚úÖ An√°lisis jur√≠dico completado</strong></p>';
                
                this.updateStats();
                this.displayResults();
                
                setTimeout(() => {
                    this.switchSection('results');
                }, 1000);
            }

            async analyzeDocument(doc) {
                const analysis = {
                    documentId: doc.id,
                    documentName: doc.name,
                    documentType: this.classifyDocument(doc.content),
                    timestamp: new Date(),
                    forma: this.evaluateForm(doc),
                    fondo: this.evaluateFondo(doc),
                    valorProbatorio: this.evaluateProbatoryValue(doc),
                    legalidad: this.evaluateLegality(doc),
                    articulos: this.getApplicableArticles(doc),
                    riesgos: this.identifyRisks(doc),
                    recomendaciones: this.generateRecommendations(doc),
                    scores: {}
                };

                // Calcular scores detallados
                analysis.scores = this.calculateDetailedScores(analysis);
                
                return analysis;
            }

            classifyDocument(content) {
                const text = content.toLowerCase();
                let bestMatch = null;
                let maxScore = 0;

                for (const [key, docType] of Object.entries(this.documentTypes)) {
                    let score = 0;
                    docType.keywords.forEach(keyword => {
                        const regex = new RegExp(keyword, 'gi');
                        const matches = (text.match(regex) || []).length;
                        score += matches;
                    });

                    if (score > maxScore) {
                        maxScore = score;
                        bestMatch = key;
                    }
                }

                return bestMatch || 'desconocido';
            }

            evaluateForm(doc) {
                const content = doc.content.toLowerCase();
                const docType = this.classifyDocument(doc.content);
                const requiredElements = this.documentTypes[docType]?.requiredElements || [];
                
                const formChecks = {
                    fecha: this.checkForDate(content),
                    lugar: this.checkForPlace(content),
                    firma: this.checkForSignature(content),
                    identificacion: this.checkForIdentification(content),
                    estructura: this.checkStructure(content)
                };

                const compliance = Object.values(formChecks).filter(Boolean).length / Object.keys(formChecks).length;
                
                return {
                    cumple: compliance >= 0.7,
                    porcentaje: Math.round(compliance * 100),
                    elementos: formChecks,
                    observaciones: this.generateFormObservations(formChecks, docType)
                };
            }

            evaluateFondo(doc) {
                const content = doc.content;
                
                const fondoChecks = {
                    narrativaClara: this.checkNarrativeClarity(content),
                    hechosRelevantes: this.checkRelevantFacts(content),
                    congruencia: this.checkCongruence(content),
                    completitud: this.checkCompleteness(content),
                    utilidad: this.checkUtility(content)
                };

                const quality = Object.values(fondoChecks).filter(Boolean).length / Object.keys(fondoChecks).length;
                
                return {
                    suficiente: quality >= 0.6,
                    porcentaje: Math.round(quality * 100),
                    aspectos: fondoChecks,
                    observaciones: this.generateFondoObservations(fondoChecks)
                };
            }

            evaluateProbatoryValue(doc) {
                const docType = this.classifyDocument(doc.content);
                const baseValue = this.documentTypes[docType]?.probatoryValue || 0.5;
                
                const factors = {
                    credibilidad: this.assessCredibility(doc.content),
                    verificabilidad: this.assessVerifiability(doc.content),
                    consistencia: this.assessConsistency(doc.content),
                    corroboracion: this.assessCorroboration(doc.content),
                    impacto: this.assessImpact(doc.content)
                };

                const adjustedValue = baseValue * (Object.values(factors).reduce((a, b) => a + b, 0) / Object.keys(factors).length);
                
                return {
                    valor: Math.round(adjustedValue * 100),
                    factores,
                    utilidad: this.determineUtility(adjustedValue),
                    observaciones: this.generateProbatoryObservations(factors, adjustedValue)
                };
            }

            evaluateLegality(doc) {
                const docType = this.classifyDocument(doc.content);
                const applicableArticles = this.getApplicableArticles(doc);
                
                const legalityChecks = {
                    fundamentacion: this.checkLegalBasis(doc.content),
                    motivacion: this.checkMotivation(doc.content),
                    procedimiento: this.checkProcedure(doc.content),
                    derechos: this.checkRightsRespect(doc.content)
                };

                const compliance = Object.values(legalityChecks).filter(Boolean).length / Object.keys(legalityChecks).length;
                
                return {
                    cumple: compliance >= 0.8,
                    porcentaje: Math.round(compliance * 100),
                    aspectos: legalityChecks,
                    articulos: applicableArticles,
                    observaciones: this.generateLegalityObservations(legalityChecks)
                };
            }

            getApplicableArticles(doc) {
                const docType = this.classifyDocument(doc.content);
                const content = doc.content.toLowerCase();
                const applicable = [];

                // Art√≠culos CPEUM
                for (const [key, article] of Object.entries(this.legalFramework.CPEUM)) {
                    if (article.applies.some(term => content.includes(term) || docType.includes(term))) {
                        applicable.push({
                            codigo: 'CPEUM',
                            articulo: key,
                            contenido: article.content,
                            peso: article.weight,
                            aplicabilidad: this.calculateApplicability(content, article.applies)
                        });
                    }
                }

                // Art√≠culos CNPP
                for (const [key, article] of Object.entries(this.legalFramework.CNPP)) {
                    if (article.applies.some(term => content.includes(term) || docType.includes(term))) {
                        applicable.push({
                            codigo: 'CNPP',
                            articulo: key,
                            contenido: article.content,
                            peso: article.weight,
                            aplicabilidad: this.calculateApplicability(content, article.applies)
                        });
                    }
                }

                return applicable.sort((a, b) => b.peso - a.peso);
            }

            identifyRisks(doc) {
                const risks = [];
                const content = doc.content.toLowerCase();
                const forma = this.evaluateForm(doc);
                const fondo = this.evaluateFondo(doc);

                if (forma.porcentaje < 70) {
                    risks.push({
                        tipo: 'FORMA',
                        nivel: 'ALTO',
                        descripcion: 'Deficiencias formales que pueden generar nulidad',
                        articulo: 'Art. 16 CPEUM - Falta de fundamentaci√≥n'
                    });
                }

                if (fondo.porcentaje < 60) {
                    risks.push({
                        tipo: 'FONDO',
                        nivel: 'MEDIO',
                        descripcion: 'Narrativa insuficiente para sostener imputaci√≥n',
                        articulo: 'Art. 131 CNPP - Insuficiencia probatoria'
                    });
                }

                if (!this.checkForSignature(content)) {
                    risks.push({
                        tipo: 'VALIDEZ',
                        nivel: 'ALTO',
                        descripcion: 'Ausencia de firma compromete autenticidad',
                        articulo: 'Art. 259 CNPP - Cadena de custodia'
                    });
                }

                return risks;
            }

            generateRecommendations(doc) {
                const recommendations = [];
                const forma = this.evaluateForm(doc);
                const fondo = this.evaluateFondo(doc);
                const docType = this.classifyDocument(doc.content);

                if (forma.porcentaje < 80) {
                    recommendations.push({
                        tipo: 'TECNICA',
                        prioridad: 'ALTA',
                        accion: 'Completar elementos formales faltantes',
                        detalle: `Agregar: ${Object.entries(forma.elementos).filter(([k,v]) => !v).map(([k,v]) => k).join(', ')}`,
                        plazo: 'Inmediato'
                    });
                }

                if (fondo.porcentaje < 70) {
                    recommendations.push({
                        tipo: 'JURIDICA',
                        prioridad: 'MEDIA',
                        accion: 'Reforzar narrativa de hechos',
                        detalle: 'Ampliar descripci√≥n con elementos objetivos y verificables',
                        plazo: '3 d√≠as'
                    });
                }

                if (docType === 'inspeccion' && !this.checkForPlace(doc.content)) {
                    recommendations.push({
                        tipo: 'PROCESAL',
                        prioridad: 'ALTA',
                        accion: 'Incluir croquis y descripci√≥n detallada del lugar',
                        detalle: 'Art. 266 CNPP - Inspecci√≥n debe contener descripci√≥n precisa',
                        plazo: 'Inmediato'
                    });
                }

                return recommendations;
            }

            // =====================================
			// M√âTODOS DE VERIFICACI√ìN B√ÅSICA
			// =====================================

			checkForDate(content) {
				const datePatterns = [
					/\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4}/,
					/\d{1,2}\s+de\s+\w+\s+de\s+\d{4}/,
					/\w+\s+\d{1,2},?\s+\d{4}/
				];
				return datePatterns.some(pattern => pattern.test(content));
			}

			checkForPlace(content) {
				const placeKeywords = ['lugar', 'ubicado', 'domicilio', 'direcci√≥n', 'calle', 'municipio', 'ciudad'];
				return placeKeywords.some(keyword => content.toLowerCase().includes(keyword));
			}

			checkForSignature(content) {
				const signatureKeywords = ['firma', 'firmado', 'suscribe', 'rubrica', 'signatura'];
				return signatureKeywords.some(keyword => content.toLowerCase().includes(keyword));
			}

						checkForIdentification(content) {
				const idKeywords = ['identific√≥', 'acredit√≥', 'credencial', 'c√©dula', 'nombre', 'cargo'];
				return idKeywords.some(keyword => content.toLowerCase().includes(keyword));
			}

			checkStructure(content) {
				return content.length > 100 && content.includes('.');
			}

			checkNarrativeClarity(content) {
				const sentences = content.split('.').filter(s => s.trim().length > 10);
				return sentences.length >= 3;
			}

						checkRelevantFacts(content) {
				const factKeywords = ['hecho', 'ocurri√≥', 'sucedi√≥', 'aconteci√≥', 'evento'];
				return factKeywords.some(keyword => content.toLowerCase().includes(keyword));
			}

			hasContradictions(content) {
				const negativeWords = ['no', 'nunca', 'jam√°s', 'ning√∫n'];
				const positiveWords = ['s√≠', 'siempre', 'todos', 'cada'];
				const negCount = negativeWords.filter(word => content.toLowerCase().includes(word)).length;
				const posCount = positiveWords.filter(word => content.toLowerCase().includes(word)).length;
				return Math.abs(negCount - posCount) > 3;
			}

			checkCongruence(content) {
				return !this.hasContradictions(content);
			}

						checkCompleteness(content) {
				return content.length > 200;
			}

			checkUtility(content) {
				const utilityKeywords = ['prueba', 'evidencia', 'demuestra', 'acredita', 'sustenta'];
				return utilityKeywords.some(keyword => content.toLowerCase().includes(keyword));
			}

						// =====================================
						// FUNCIONES DE AN√ÅLISIS GLOBAL
						// =====================================

						assessCredibility(content) {
				let score = 0.5;
				if (this.checkForDate(content)) score += 0.1;
				if (this.checkForPlace(content)) score += 0.1;
				if (content.length > 300) score += 0.1;
				if (this.checkNarrativeClarity(content)) score += 0.2;
				return Math.min(score, 1.0);
			}

			assessVerifiability(content) {
				let score = 0.3;
				const verifiableElements = ['testigo', 'documento', 'evidencia', 'prueba', 'registro'];
				verifiableElements.forEach(element => {
					if (content.toLowerCase().includes(element)) score += 0.15;
				});
				return Math.min(score, 1.0);
			}//
			const app = new CarpetaAnalyzer();
</script>
</body>
</html>